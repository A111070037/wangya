<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- PWA / Fullscreen on mobile -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4D9980">
    <link rel="manifest" href="manifest.webmanifest">
    <title>è—¥åš€ç®¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(to bottom, #D9F2E0, #F2FAF4, #FFFFFF);
            min-height: 100dvh; /* ä½¿ç”¨å‹•æ…‹è¦–çª—é«˜åº¦é¿å…è¢«ç€è¦½å™¨å·¥å…·åˆ—å£“ç¸® */
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
        }

        /* é ‚éƒ¨åˆ†é¡å’ŒåŠŸèƒ½å€ */
        .header {
            padding: 16px 24px;
            background: transparent;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .category-buttons {
            display: flex;
            gap: 0;
        }

        .category-btn {
            padding: 12px 24px;
            border: none;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            background: #E5E5E5;
            color: #000;
            position: relative;
        }

        .category-btn:first-child {
            border-radius: 20px 0 0 20px;
        }

        .category-btn:last-child {
            border-radius: 0 20px 20px 0;
        }

        .category-btn:only-child {
            border-radius: 20px;
        }

        .category-btn.active {
            background: #4D9980;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.1);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .icon-btn:hover {
            background: #f5f5f5;
        }

        /* ä¸‹æ‹‰é¸å–®ï¼ˆæ’åºï¼‰ */
        .dropdown-menu {
            position: absolute;
            right: 0;
            top: 44px;
            background: white;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 10px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
            padding: 6px;
            display: none;
            z-index: 20;
            min-width: 160px;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-menu button {
            width: 100%;
            text-align: left;
            padding: 10px 12px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        .dropdown-menu button:hover { background: #f4f6f8; }
        .dropdown-menu hr { border: 0; height: 1px; background: #eee; margin: 6px 0; }

        /* æœå°‹åˆ— */
        .search-bar {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.95);
            padding: 12px 16px;
            border-radius: 12px;
            gap: 12px;
            margin-top: 20px;
        }

        .search-bar input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
            background: transparent;
        }

        .search-bar svg {
            width: 18px;
            height: 18px;
            color: #666;
        }

        /* è—¥å“åˆ—è¡¨ */
        .medicine-list {
            padding: 0 20px;
            margin-top: 24px;
        }

        .medicine-card {
            background: #F5F6F7;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s;
        }

        .medicine-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .medicine-image {
            width: 64px;
            height: 64px;
            border-radius: 10px;
            background: #D5D5D5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: #666;
            flex-shrink: 0;
        }

        .medicine-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        .medicine-info {
            flex: 1;
        }

        .medicine-name {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #000;
        }

        .medicine-dosage {
            font-size: 16px;
            color: #666;
        }

        .time-slots {
            display: flex;
            gap: 16px;
        }

        .time-slot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(128,128,128,0.2);
            color: #666;
            font-size: 20px;
        }

        .time-slot.taken {
            background: #4D9980;
            color: white;
            border-color: #4D9980;
        }

        /* åº•éƒ¨åŠŸèƒ½æŒ‰éˆ• */
        .bottom-actions {
            position: fixed;
            bottom: 80px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 32px;
            padding: 20px;
        }

        .fab {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #4D9980;
            color: white;
            border: none;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            transition: all 0.3s;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        /* åŒ¯å‡ºæŒ‰éˆ•å€åŸŸ */
        .export-section {
            padding: 12px 20px;
            background: rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .export-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px 16px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
            background: linear-gradient(135deg, #218838 0%, #1aa179 100%);
        }

        .export-btn:active {
            transform: translateY(0);
        }

        .export-btn span:first-child {
            font-size: 20px;
        }

        /* åº•éƒ¨å°èˆª */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: calc(12px + env(safe-area-inset-bottom)/2) 0 env(safe-area-inset-bottom) 0; /* è®“å…§å®¹ä¸è¢« Safari å·¥å…·åˆ—è“‹ä½ */
            border-top: 1px solid #E5E5E5;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            color: #666;
            transition: all 0.3s;
            padding: 8px 16px;
            border: none;
            background: transparent;
            font-size: 12px;
        }

        .nav-item.active {
            color: #4D9980;
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
        }

        /* æ¨¡æ…‹çª—å£ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 600px;
            border-radius: 20px 20px 0 0;
            padding: 24px;
            padding-top: 0; /* å°‡é ‚éƒ¨é–“è·äº¤ç”± sticky header è™•ç†ï¼Œé¿å…æ»¾å‹•æ™‚éœ²å‡ºèƒŒæ™¯ */
            /* ä¸å¾—é«˜æ–¼è¢å¹•é«˜åº¦ï¼ˆå¤šé‡å–®ä½åšç›¸å®¹æ€§å›é€€ï¼‰ */
            max-height: 88vh; /* ä¸€èˆ¬ç€è¦½å™¨å›é€€ */
            max-height: calc(100svh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 20px); /* å°è¦–çª—å–®ä½ */
            max-height: calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 20px); /* å‹•æ…‹è¦–çª—å–®ä½ */
            padding-top: calc(24px + env(safe-area-inset-top));
            padding-bottom: calc(24px + env(safe-area-inset-bottom));
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overscroll-behavior: contain; /* é˜²æ­¢æ»¾åˆ°é ‚/åº•æ™‚å¸¶å‹•èƒŒæ™¯é  */
            -webkit-overflow-scrolling: touch; /* è¡Œå‹•è£ç½®æ»¾å‹•æ›´é †ï¼Œé¿å…å¡åœ¨é ‚éƒ¨ */
            animation: slideUp 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 2;
            /* è®“ header èˆ‡å½ˆçª—ä¸Šç·£å®Œå…¨è²¼é½Šä¸”å¡«æ»¿èƒŒæ™¯ï¼Œä¸ç•™ç¸«éš™ */
            margin: 0 -24px 16px -24px;
            padding: calc(24px + env(safe-area-inset-top)) 24px 8px 24px;
            background: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 1px 0 rgba(0,0,0,0.06) inset;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #f5f5f5;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            min-width: 0; /* é˜²æ­¢åœ¨ flex å®¹å™¨ä¸­æº¢å‡º */
            max-width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px; /* é¿å… iOS è‡ªå‹•æ”¾å¤§ */
            outline: none;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        input[type="datetime-local"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            max-width: 100%;
            font-size: 16px; /* iOS ä¸è‡ªå‹•ç¸®æ”¾ */
        }

        /* è©³æƒ…å…§åœ–ç‰‡åœ¨å°è¢å¹•ä¸æº¢å‡º */
        #medicineDetailContent img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        /* å°è¢å¹•è¡€å£“èˆ‡å–®å€¼å€å¡Šå…è¨±æ›è¡Œï¼Œé¿å…æ©«å‘æº¢å‡º */
        #bloodPressureInputs > div,
        #singleValueInput > div,
        #editValueInputs > div {
            flex-wrap: wrap;
        }

        .form-input:focus {
            border-color: #4D9980;
        }

        .time-slot-selector {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .time-slot-option {
            flex: 1;
            min-width: 80px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .time-slot-option.selected {
            background: #4D9980;
            color: white;
            border-color: #4D9980;
        }

        .btn-primary {
            width: 100%;
            padding: 16px;
            background: #4D9980;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: #3D7A65;
        }

        .btn-danger {
            width: 100%;
            padding: 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 12px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* ç©ºç‹€æ…‹ */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            color: rgba(77, 153, 128, 0.7);
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        /* æ­·å²è¨˜éŒ„ */
        .history-item {
            padding: 16px;
            background: #F5F6F7;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .history-date {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .history-medicine {
            font-size: 16px;
            font-weight: 500;
            color: #000;
        }

        .history-time {
            font-size: 14px;
            color: #4D9980;
            margin-top: 4px;
        }

        /* å€‹äººè³‡æ–™ */
        .profile-section {
            padding: 20px;
        }

        .profile-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-label {
            color: #666;
        }

        .profile-value {
            font-weight: 500;
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 12px;
            background: #f5f5f5;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: #e5e5e5;
            border-color: #4D9980;
        }

        .view-container {
            display: none;
        }

        .view-container.active {
            display: block;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* å¥åº·è¨˜éŒ„ç›¸é—œæ¨£å¼ */
        .health-type-selector {
            background: rgba(255,255,255,0.05);
            padding: 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .type-buttons {
            display: flex;
            gap: 10px;
            padding: 0 20px;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .type-buttons::-webkit-scrollbar {
            display: none;
        }

        .type-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: rgba(128,128,128,0.1);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 70px;
            flex-shrink: 0;
        }

        .type-btn.active {
            background: #4D9980;
            color: white;
        }

        .type-icon {
            font-size: 24px;
        }

        .type-name {
            font-size: 12px;
            font-weight: 500;
        }

        .health-content {
            flex: 1;
            overflow-y: auto;
        }

        .sync-section {
            padding: 16px 20px;
            background: rgba(77, 153, 128, 0.05);
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .sync-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: #4D9980;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            width: 100%;
        }

        .sync-btn:hover {
            background: #3D7A65;
        }

        .sync-icon {
            font-size: 16px;
        }

        .health-records-list {
            padding: 20px;
        }

        .health-record-item {
            background: #F5F6F7;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .health-record-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .health-record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .health-record-type {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #333;
        }

        .health-record-time {
            font-size: 14px;
            color: #666;
        }

        .health-record-value {
            font-size: 18px;
            font-weight: 600;
            color: #4D9980;
            margin-bottom: 8px;
        }

        .health-record-note {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        .chart-container {
            padding: 20px;
            background: white;
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        #healthChart {
            height: 300px !important;
        }

        .export-types {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 10px;
        }

        .export-types .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f5f5f5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .export-types .checkbox-group:hover {
            background: #e5e5e5;
        }

        .export-types .checkbox-group input[type="checkbox"]:checked + span {
            color: #4D9980;
            font-weight: 500;
        }

        /* æ—¥æœŸåˆ†çµ„æ¨™é¡Œ */
        .date-group {
            margin-bottom: 20px;
        }

        .date-group-title {
            font-size: 16px;
            font-weight: 600;
            color: #4D9980;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 2px solid #4D9980;
        }

        /* Toast æç¤º */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s;
            max-width: 90%;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.success {
            background: #4D9980;
        }

        .toast.error {
            background: #dc3545;
        }

        /* æ‰‹æ©Ÿå„ªåŒ– */
        /* è¼‰å…¥ä¸­å‹•ç•« */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            color: #4D9980;
            gap: 10px;
        }
        .loading .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(77,153,128,0.3);
            border-top-color: #4D9980;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            .btn-primary {
                padding: 20px;
                font-size: 20px;
            }
            
            .form-input {
                padding: 16px;
                font-size: 18px;
            }
            
            .modal-content {
                padding: 16px;
                padding-top: 0; /* äº¤ç”± sticky header è£œè¶³é ‚éƒ¨å®‰å…¨è·é›¢ */
                padding-bottom: calc(16px + env(safe-area-inset-bottom));
                max-height: calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 10px);
            }
            .modal-header {
                margin: 0 -16px 12px -16px;
                padding: calc(16px + env(safe-area-inset-top)) 16px 8px 16px;
            }
            
            .modal-title {
                font-size: 20px;
            }
            
            .time-slot-option {
                padding: 16px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- æˆ‘çš„è—¥å“é é¢ -->
    <div id="medicinesView" class="view-container active">
        <div class="header">
            <div class="top-bar">
                <div class="category-buttons">
                    <button class="category-btn active" onclick="changeCategory('è™•æ–¹è—¥')">è™•æ–¹è—¥</button>
                    <button class="category-btn" onclick="changeCategory('ä¿å¥å“')">ä¿å¥å“</button>
                </div>
                <div class="action-buttons" style="position: relative;">
                    <button class="icon-btn" onclick="toggleSortMenu(event)" title="æ’åº">
                        â‡…
                    </button>
                    <div id="sortMenu" class="dropdown-menu">
                        <button onclick="setMedicineSort('created_desc')">æ–°å¢æ™‚é–“ æ–°â†’èˆŠ</button>
                        <button onclick="setMedicineSort('created_asc')">æ–°å¢æ™‚é–“ èˆŠâ†’æ–°</button>
                        <hr>
                        <button onclick="setMedicineSort('stock_desc')">åº«å­˜ é«˜â†’ä½</button>
                        <button onclick="setMedicineSort('stock_asc')">åº«å­˜ ä½â†’é«˜</button>
                    </div>
                    <button class="icon-btn" onclick="showHistory()">
                        ğŸ•’
                    </button>
                </div>
            </div>

            <div class="search-bar">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <input type="text" id="searchInput" placeholder="æœå°‹è—¥å“" oninput="searchMedicines()">
                <button class="icon-btn" onclick="document.getElementById('searchInput').value=''; searchMedicines();" style="border: none; background: transparent;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="medicine-list" id="medicineList"></div>

        <div class="bottom-actions">
            <button class="fab" onclick="showAddMedicine()" title="æ·»åŠ è—¥å“">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 26px; height: 26px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- å¥åº·ç´€éŒ„é é¢ -->
    <div id="healthView" class="view-container">
        <div class="header">
            <h2 class="modal-title">å¥åº·ç´€éŒ„</h2>
        </div>
        
        <!-- åŒ¯å‡ºæŒ‰éˆ•å€åŸŸ -->
        <div class="export-section">
            <button class="export-btn" onclick="showExportOptions()">
                <span>ğŸ“¤</span>
                <span>åŒ¯å‡ºè¨˜éŒ„</span>
            </button>
        </div>
        
        <!-- å¥åº·æŒ‡æ¨™é¡å‹é¸æ“‡å™¨ -->
        <div class="health-type-selector">
            <div class="type-buttons">
                <button class="type-btn active" data-type="bloodPressure" onclick="changeHealthType('bloodPressure')">
                    <span class="type-icon">â¤ï¸</span>
                    <span class="type-name">è¡€å£“</span>
                </button>
                <button class="type-btn" data-type="bloodSugar" onclick="changeHealthType('bloodSugar')">
                    <span class="type-icon">ğŸ©¸</span>
                    <span class="type-name">è¡€ç³–</span>
                </button>
                <button class="type-btn" data-type="heartRate" onclick="changeHealthType('heartRate')">
                    <span class="type-icon">ğŸ’“</span>
                    <span class="type-name">å¿ƒç‡</span>
                </button>
                <button class="type-btn" data-type="bloodOxygen" onclick="changeHealthType('bloodOxygen')">
                    <span class="type-icon">ğŸ«</span>
                    <span class="type-name">è¡€æ°§</span>
                </button>
                <button class="type-btn" data-type="weight" onclick="changeHealthType('weight')">
                    <span class="type-icon">âš–ï¸</span>
                    <span class="type-name">é«”é‡</span>
                </button>
                <button class="type-btn" data-type="medication" onclick="changeHealthType('medication')">
                    <span class="type-icon">ğŸ’Š</span>
                    <span class="type-name">ç”¨è—¥ç´€éŒ„</span>
                </button>
            </div>
        </div>

        <div class="health-content">
            <!-- åŒæ­¥æŒ‰éˆ•ï¼ˆåƒ…åœ¨ç”¨è—¥è¨˜éŒ„é¡¯ç¤ºï¼‰ -->
            <div id="syncButton" class="sync-section" style="display: none;">
                <button class="sync-btn" onclick="syncMedicationRecords()">
                    <span class="sync-icon">ğŸ”„</span>
                    <span>åŒæ­¥è—¥å“æœç”¨è¨˜éŒ„</span>
                </button>
            </div>

            <!-- å¥åº·è¨˜éŒ„åˆ—è¡¨ -->
            <div class="health-records-list" id="healthRecordsList">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h3 id="emptyStateTitle">æš«ç„¡è¡€å£“è¨˜éŒ„</h3>
                    <p>é»æ“Šå³ä¸‹æ–¹ + æŒ‰éˆ•æ·»åŠ æ–°è¨˜éŒ„</p>
                </div>
            </div>
        </div>

        <!-- åœ–è¡¨å€åŸŸ -->
        <div class="chart-container" id="chartContainer" style="display: none;">
            <canvas id="healthChart"></canvas>
        </div>

        <!-- åº•éƒ¨æ·»åŠ æŒ‰éˆ• -->
        <div class="bottom-actions">
            <button class="fab" onclick="showAddHealthRecord()" title="æ·»åŠ å¥åº·è¨˜éŒ„">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 26px; height: 26px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </button>
        </div>

    </div>

    <!-- é™„è¿‘é†«ç™‚åœ°åœ–é é¢ -->
    <div id="mapView" class="view-container">
        <div class="header">
            <h2 class="modal-title">é™„è¿‘é†«ç™‚</h2>
        </div>
        
        <!-- ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div id="networkStatus" style="display: none; padding: 8px 20px; background: #fff3cd; color: #856404; font-size: 13px; text-align: center;">
            ğŸ“¶ ç¶²è·¯é€£æ¥è¼ƒæ…¢ï¼Œè«‹è€å¿ƒç­‰å¾…...
        </div>

        <!-- æœç´¢æ  -->
        <div style="padding: 12px 20px;">
            <div style="position: relative;">
                <input type="text" id="mapSearchInput" placeholder="æœå°‹é†«ç™‚æ©Ÿæ§‹åç¨±..." style="width: 100%; padding: 10px 40px 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px;">
                <svg onclick="searchPlaces()" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; cursor: pointer; color: #666;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
        </div>

        <!-- ç±»åˆ«ç­›é€‰ -->
        <div style="padding: 0 20px 12px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
            <button class="type-btn active" data-filter="all" onclick="setMapFilter('all')"><span class="type-name">å…¨éƒ¨</span></button>
            <button class="type-btn" data-filter="pharmacy" onclick="setMapFilter('pharmacy')"><span class="type-name">è—¥å±€</span></button>
            <button class="type-btn" data-filter="hospital" onclick="setMapFilter('hospital')"><span class="type-name">å¤§é†«é™¢</span></button>
            <button class="type-btn" data-filter="internal" onclick="setMapFilter('internal')"><span class="type-name">å…§ç§‘</span></button>
            <button class="type-btn" data-filter="pediatric" onclick="setMapFilter('pediatric')"><span class="type-name">å°å…’ç§‘</span></button>
            <button class="type-btn" data-filter="dental" onclick="setMapFilter('dental')"><span class="type-name">ç‰™ç§‘</span></button>
            <button class="type-btn" data-filter="eye" onclick="setMapFilter('eye')"><span class="type-name">çœ¼ç§‘</span></button>
            <button class="type-btn" data-filter="ent" onclick="setMapFilter('ent')"><span class="type-name">è€³é¼»å–‰ç§‘</span></button>
            <button class="type-btn" data-filter="obgyn" onclick="setMapFilter('obgyn')"><span class="type-name">å©¦ç”¢ç§‘</span></button>
            <button class="type-btn" data-filter="ortho" onclick="setMapFilter('ortho')"><span class="type-name">éª¨ç§‘</span></button>
            <button class="type-btn" data-filter="derm" onclick="setMapFilter('derm')"><span class="type-name">çš®è†šç§‘</span></button>
            <button class="type-btn" data-filter="emergency" onclick="setMapFilter('emergency')"><span class="type-name">æ€¥è¨º</span></button>
        </div>

        <!-- å·¥å…·æ ï¼šèŒƒå›´å’Œæ’åº -->
        <div style="padding: 0 20px 12px; display: flex; gap: 8px; align-items: center;">
            <select id="searchRadius" onchange="updateSearchRadius()" style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                <option value="500">500ç±³å…§</option>
                <option value="1000" selected>1å…¬é‡Œå…§</option>
                <option value="2000">2å…¬é‡Œå…§</option>
                <option value="3000">3å…¬é‡Œå…§</option>
            </select>
            <select id="sortBy" onchange="sortPlaces()" style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                <option value="distance">è·é›¢æ’åº</option>
                <option value="name">åç¨±æ’åº</option>
            </select>
            <button onclick="toggleFavorites()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">
                <svg id="favIcon" style="width: 20px; height: 20px; color: #666;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
            </button>
        </div>
        
        <!-- æç¤ºä¿¡æ¯ -->
        <div id="mapHint" style="display: none; padding: 8px 20px; background: #e3f2fd; color: #1565c0; font-size: 12px; border-left: 3px solid #1976d2; margin: 0 20px 12px;">
            ğŸ’¡ æç¤ºï¼šå¦‚æœåŠ è¼‰å¾ˆæ…¢ï¼Œè©¦è©¦é¸æ“‡æ›´å°çš„æœå°‹ç¯„åœï¼ˆ500ç±³æˆ–1å…¬é‡Œï¼‰
        </div>

        <!-- åœ°å›¾å®¹å™¨ - æ·»åŠ è¾¹è·å’Œè¾¹æ¡† -->
        <div style="padding: 0 12px; margin-bottom: 12px; position: relative;">
            <div id="map" style="height: calc(100dvh - 410px); min-height: 250px; border: 2px solid #e0e0e0; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
            
            <!-- å°æ¸¸æˆæµ®å±‚ - ç‹¬ç«‹äºåˆ—è¡¨ï¼Œå›ºå®šåœ¨åœ°å›¾ä¸Šæ–¹ -->
            <div id="miniGameOverlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.98); z-index: 2000; border-radius: 12px; padding: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
                <!-- å…³é—­æŒ‰é’® -->
                <button onclick="closeGameOverlay()" style="position: absolute; top: 8px; right: 8px; background: #e0e0e0; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#ccc'" onmouseout="this.style.background='#e0e0e0'" title="é—œé–‰éŠæˆ²">
                    âœ–ï¸
                </button>
                <div style="text-align: center;">
                    <div style="font-size: 13px; color: #4D9980; font-weight: 500; margin-bottom: 8px;">
                        ğŸ® ç­‰å¾…å¤ªä¹…äº†ï¼Ÿä¾†ç©å€‹å°éŠæˆ²å§ï¼
                    </div>
                    <div style="font-size: 11px; color: #999; margin-bottom: 12px;">
                        ğŸ“± æ‰‹æ©Ÿï¼šé»æ“ŠéŠæˆ²å€åŸŸ | ğŸ’» é›»è…¦ï¼šé»æ“Šæˆ–æŒ‰ç©ºæ ¼
                    </div>
                    <canvas id="gameCanvas" width="280" height="180" 
                            style="border: 2px solid #e0e0e0; border-radius: 8px; background: #fff; cursor: pointer; display: block; margin: 0 auto; box-shadow: 0 2px 6px rgba(0,0,0,0.1); max-width: 100%;"></canvas>
                    <div style="margin-top: 8px; font-size: 16px; font-weight: 600; color: #4D9980;">
                        åˆ†æ•¸ï¼š<span id="gameScore">0</span>
                    </div>
                </div>
            </div>
            
            <!-- æœç´¢æ­¤åŒºåŸŸæŒ‰é’® -->
            <div id="searchAreaBtn" style="display: none; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000;">
                <button onclick="searchCurrentArea()" 
                        style="background: linear-gradient(135deg, #4D9980 0%, #5daa94 100%); 
                               color: white; 
                               border: none; 
                               padding: 10px 20px; 
                               border-radius: 8px; 
                               font-size: 14px; 
                               font-weight: 500;
                               cursor: pointer; 
                               box-shadow: 0 3px 10px rgba(77, 153, 128, 0.4);
                               transition: all 0.3s ease;
                               display: inline-flex;
                               align-items: center;
                               gap: 6px;"
                        onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(77, 153, 128, 0.5)';"
                        onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 3px 10px rgba(77, 153, 128, 0.4)';">
                    <span style="font-size: 16px;">ğŸ”</span> æœå°‹æ­¤å€åŸŸ
                </button>
            </div>
            
            <!-- å›åˆ°æˆ‘çš„ä½ç½®æŒ‰é’® - åœ¨åœ°å›¾ç¼©æ”¾æ§åˆ¶æŒ‰é’®ä¸‹æ–¹ -->
            <button id="myLocationBtn" onclick="goToMyLocation()" style="position: absolute; top: 92px; right: 24px; z-index: 1000; background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px; width: 34px; height: 34px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.2s;" title="å›åˆ°æˆ‘çš„ä½ç½®" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
                ğŸ“
            </button>
        </div>
        
        <div id="placeList" class="health-records-list" style="padding-top: 12px;"></div>
    </div>

    <!-- å€‹äººè³‡æ–™é é¢ -->
    <div id="profileView" class="view-container">
        <div class="header">
            <h2 class="modal-title">å€‹äººè³‡æ–™</h2>
        </div>
        <div class="profile-section">
            <div class="profile-item">
                <span class="profile-label">å§“å</span>
                <input type="text" id="userName" class="form-input" style="width: auto; border: none; background: transparent; text-align: right;" placeholder="è«‹è¼¸å…¥å§“å" onchange="saveProfile()" oninput="saveProfile()" autocomplete="name">
            </div>
            <div class="profile-item">
                <span class="profile-label">å¹´é½¡</span>
                <input type="number" id="userAge" class="form-input" style="width: auto; border: none; background: transparent; text-align: right;" placeholder="20" onchange="saveProfile()" oninput="saveProfile()" inputmode="numeric">
            </div>
            <div class="profile-item">
                <span class="profile-label">æ€§åˆ¥</span>
                <select id="userGender" class="form-input" style="width: auto; border: none; background: transparent; text-align: right;" onchange="saveProfile()" >
                    <option value="ç”·æ€§">ç”·æ€§</option>
                    <option value="å¥³æ€§">å¥³æ€§</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>
            <div class="profile-item">
                <span class="profile-label">èº«é«˜ (cm)</span>
                <input type="number" id="userHeight" class="form-input" style="width: auto; border: none; background: transparent; text-align: right;" placeholder="170" onchange="saveProfile()" oninput="saveProfile()" inputmode="numeric">
            </div>
            <div class="profile-item">
                <span class="profile-label">é«”é‡ (kg)</span>
                <input type="number" id="userWeight" class="form-input" style="width: auto; border: none; background: transparent; text-align: right;" placeholder="60" onchange="saveProfile()" oninput="saveProfile()" inputmode="numeric">
            </div>
            <div class="profile-item">
                <span class="profile-label">ç–¾ç—…</span>
                <input type="text" id="userDisease" class="form-input" style="width: auto; border: none; background: transparent; text-align: right;" placeholder="ä¾‹å¦‚ï¼šé«˜è¡€å£“ã€ç³–å°¿ç—…" onchange="saveProfile()" oninput="saveProfile()">
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆª -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchView('medicines')">
            <svg fill="currentColor" viewBox="0 0 24 24">
                <path d="M4.22 11.29l-1.94 1.94a3 3 0 000 4.24l4.25 4.25a3 3 0 004.24 0l9.19-9.19a3 3 0 000-4.24L15.71 4.04a3 3 0 00-4.24 0l-1.94 1.94 4.24 4.25a1 1 0 010 1.41l-2.12 2.12a1 1 0 01-1.41 0L5.99 9.52l-1.77 1.77z"/>
            </svg>
            <span>æˆ‘çš„è—¥å“</span>
        </button>
        <button class="nav-item" onclick="switchView('health')">
            <svg fill="currentColor" viewBox="0 0 24 24">
                <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
            </svg>
            <span>å¥åº·ç´€éŒ„</span>
        </button>
        <button class="nav-item" onclick="switchView('map')">
            <svg fill="currentColor" viewBox="0 0 24 24">
                <path d="M9 20l-5 2V6l5-2 6 2 6-2v16l-6 2-6-2zm6-14l-6-2v14l6 2V6z"/>
            </svg>
            <span>é™„è¿‘é†«ç™‚</span>
        </button>
        <button class="nav-item" onclick="switchView('profile')">
            <svg fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            <span>å€‹äººè³‡æ–™</span>
        </button>
    </div>

    <!-- æ·»åŠ /ç·¨è¼¯è—¥å“æ¨¡æ…‹çª—å£ -->
    <div id="addMedicineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">æ·»åŠ è—¥å“</h3>
                <button class="close-btn" onclick="closeModal('addMedicineModal')">Ã—</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">è—¥å“åç¨±</label>
                <input type="text" id="medicineName" class="form-input" placeholder="è«‹è¼¸å…¥è—¥å“åç¨±">
            </div>

            <div class="form-group">
                <label class="form-label">é¡åˆ¥</label>
                <select id="medicineCategory" class="form-input">
                    <option value="è™•æ–¹è—¥">è™•æ–¹è—¥</option>
                    <option value="ä¿å¥å“">ä¿å¥å“</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">æ¯æ¬¡ç”¨é‡</label>
                <input type="text" id="medicineDosage" class="form-input" placeholder="ä¾‹å¦‚ï¼š1é¡†ã€2ml">
            </div>

            <div class="form-group">
                <label class="form-label">ç¸½åº«å­˜</label>
                <input type="number" id="medicineStock" class="form-input" placeholder="ç¸½é‡">
            </div>

            <div class="form-group">
                <label class="form-label">æœç”¨æ™‚æ®µ</label>
                <div class="time-slot-selector">
                    <div class="time-slot-option" data-slot="morning" onclick="toggleTimeSlot(this)">
                        æ—©ä¸Š
                    </div>
                    <div class="time-slot-option" data-slot="noon" onclick="toggleTimeSlot(this)">
                        ä¸­åˆ
                    </div>
                    <div class="time-slot-option" data-slot="evening" onclick="toggleTimeSlot(this)">
                        æ™šä¸Š
                    </div>
                    <div class="time-slot-option" data-slot="bedtime" onclick="toggleTimeSlot(this)">
                        ç¡å‰
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">è—¥å“åœ–ç‰‡</label>
                <div class="file-input-wrapper">
                    <input type="file" id="medicineImage" accept="image/*" onchange="previewImage(this)">
                    <label for="medicineImage" class="file-input-label">
                        ğŸ“· é»æ“Šä¸Šå‚³åœ–ç‰‡
                    </label>
                </div>
                <img id="imagePreview" class="image-preview" style="display: none;">
            </div>

            <div class="form-group">
                <label class="form-label">å‚™è¨»</label>
                <textarea id="medicineNotes" class="form-input" rows="3" placeholder="å…¶ä»–å‚™è¨»è³‡è¨Š"></textarea>
            </div>

            <button class="btn-primary" onclick="saveMedicine()">ä¿å­˜</button>
            <button class="btn-danger" id="deleteMedicineBtn" style="display: none;" onclick="deleteMedicine()">åˆªé™¤è—¥å“</button>
        </div>
    </div>

    <!-- æ­·å²è¨˜éŒ„æ¨¡æ…‹çª—å£ -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æœè—¥æ­·å²</h3>
                <button class="close-btn" onclick="closeModal('historyModal')">Ã—</button>
            </div>
            <div id="historyList"></div>
        </div>
    </div>

    <!-- è—¥å“è©³æƒ…æ¨¡æ…‹çª—å£ -->
    <div id="medicineDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="detailMedicineName"></h3>
                <button class="close-btn" onclick="closeModal('medicineDetailModal')">Ã—</button>
            </div>
            <div id="medicineDetailContent"></div>
            <button class="btn-primary" onclick="editCurrentMedicine()">ç·¨è¼¯</button>
        </div>
    </div>

    <!-- æ·»åŠ å¥åº·è¨˜éŒ„æ¨¡æ…‹çª—å£ -->
    <div id="addHealthRecordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ·»åŠ å¥åº·è¨˜éŒ„</h3>
                <button class="close-btn" onclick="closeModal('addHealthRecordModal')">Ã—</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">è¨˜éŒ„é¡å‹</label>
                <select id="healthRecordType" class="form-input" onchange="updateHealthRecordForm()">
                    <option value="bloodPressure">è¡€å£“</option>
                    <option value="bloodSugar">è¡€ç³–</option>
                    <option value="heartRate">å¿ƒç‡</option>
                    <option value="bloodOxygen">è¡€æ°§</option>
                    <option value="weight">é«”é‡</option>
                    <option value="medication">ç”¨è—¥è¨˜éŒ„</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">æ—¥æœŸèˆ‡æ™‚é–“</label>
                <input type="datetime-local" id="healthRecordDate" class="form-input">
            </div>

            <!-- è¡€å£“å°ˆç”¨è¼¸å…¥ -->
            <div id="bloodPressureInputs" class="form-group">
                <label class="form-label">è¡€å£“æ•¸å€¼</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" id="systolicPressure" class="form-input" placeholder="æ”¶ç¸®å£“" style="flex: 1;">
                    <span>/</span>
                    <input type="number" id="diastolicPressure" class="form-input" placeholder="èˆ’å¼µå£“" style="flex: 1;">
                    <span>mmHg</span>
                </div>
            </div>

            <!-- å…¶ä»–æ•¸å€¼è¼¸å…¥ -->
            <div id="singleValueInput" class="form-group">
                <label class="form-label">æ¸¬é‡å€¼</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" id="healthRecordValue" class="form-input" placeholder="æ•¸å€¼" step="0.1">
                    <span id="healthRecordUnit">mmHg</span>
                </div>
            </div>

            <!-- ç”¨è—¥è¨˜éŒ„å°ˆç”¨è¼¸å…¥ -->
            <div id="medicationInputs" class="form-group" style="display: none;">
                <label class="form-label">è—¥å“åç¨±</label>
                <input type="text" id="healthMedicationName" class="form-input" placeholder="è«‹è¼¸å…¥è—¥å“åç¨±">
                
                <label class="form-label" style="margin-top: 15px;">åŠ‘é‡</label>
                <input type="text" id="healthMedicationDosage" class="form-input" placeholder="ä¾‹å¦‚ï¼šä¸€å¤©å…©æ¬¡ 5mg">
            </div>

            <div class="form-group">
                <label class="form-label">å‚™è¨»</label>
                <textarea id="healthRecordNote" class="form-input" rows="3" placeholder="å…¶ä»–å‚™è¨»è³‡è¨Š"></textarea>
            </div>

            <button class="btn-primary" onclick="saveHealthRecord()">ä¿å­˜</button>
        </div>
    </div>

    <!-- ç·¨è¼¯å¥åº·è¨˜éŒ„æ¨¡æ…‹çª—å£ -->
    <div id="editHealthRecordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç·¨è¼¯å¥åº·è¨˜éŒ„</h3>
                <button class="close-btn" onclick="closeModal('editHealthRecordModal')">Ã—</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">è¨˜éŒ„é¡å‹</label>
                <input type="text" id="editRecordType" class="form-input" readonly>
            </div>

            <div class="form-group">
                <label class="form-label">æ—¥æœŸèˆ‡æ™‚é–“</label>
                <input type="datetime-local" id="editRecordDate" class="form-input">
            </div>

            <div id="editValueInputs" class="form-group"></div>

            <div class="form-group">
                <label class="form-label">å‚™è¨»</label>
                <textarea id="editRecordNote" class="form-input" rows="3"></textarea>
            </div>

            <button class="btn-primary" onclick="updateHealthRecord()">ä¿å­˜ä¿®æ”¹</button>
            <button class="btn-danger" onclick="deleteHealthRecord()">åˆªé™¤è¨˜éŒ„</button>
        </div>
    </div>

    <!-- åŒ¯å‡ºé¸é …æ¨¡æ…‹çª—å£ -->
    <div id="exportOptionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">åŒ¯å‡ºå¥åº·è¨˜éŒ„</h3>
                <button class="close-btn" onclick="closeModal('exportOptionsModal')">Ã—</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">é¸æ“‡è¦åŒ¯å‡ºçš„è¨˜éŒ„é¡å‹</label>
                <div class="export-types">
                    <label class="checkbox-group">
                        <input type="checkbox" id="export-bloodPressure" value="bloodPressure" checked>
                        <span>è¡€å£“</span>
                    </label>
                    <label class="checkbox-group">
                        <input type="checkbox" id="export-bloodSugar" value="bloodSugar" checked>
                        <span>è¡€ç³–</span>
                    </label>
                    <label class="checkbox-group">
                        <input type="checkbox" id="export-heartRate" value="heartRate" checked>
                        <span>å¿ƒç‡</span>
                    </label>
                    <label class="checkbox-group">
                        <input type="checkbox" id="export-bloodOxygen" value="bloodOxygen" checked>
                        <span>è¡€æ°§</span>
                    </label>
                    <label class="checkbox-group">
                        <input type="checkbox" id="export-weight" value="weight" checked>
                        <span>é«”é‡</span>
                    </label>
                    <label class="checkbox-group">
                        <input type="checkbox" id="export-medication" value="medication" checked>
                        <span>ç”¨è—¥è¨˜éŒ„</span>
                    </label>
                </div>
            </div>

            <button class="btn-primary" onclick="exportToPDF()">åŒ¯å‡ºç‚º PDF</button>
        </div>
    </div>

    <!-- Leaflet for map (no API key) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2pdf (åŒ…å« html2canvas + jsPDF) ç”¨æ–¼æ­£ç¢ºé¡¯ç¤ºç¹é«”ä¸­æ–‡ -->
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

    <script>
        // æ•¸æ“šçµæ§‹
        let medicines = [];
        let history = [];
        let healthRecords = [];
        let currentCategory = 'è™•æ–¹è—¥';
        let medicineSortMode = localStorage.getItem('medicineSortMode') || 'name_asc';
        let currentHealthType = 'bloodPressure';
        let editingMedicineId = null;
        let currentMedicineDetail = null;
        let editingHealthRecordId = null;
        let healthChart = null;
        // Map related state
        let mapInstance = null;
        let mapInited = false;
        let mapFilter = 'all';
        let mapMarkers = [];
        let userPosition = null; // {lat, lon}
        let searchRadius = 1000; // é»˜è®¤1å…¬é‡Œï¼ˆå‡å°‘æŸ¥è¯¢å¤æ‚åº¦ï¼‰
        let allPlaces = []; // å­˜å‚¨æ‰€æœ‰æœç´¢ç»“æœ
        let favoritePlaces = JSON.parse(localStorage.getItem('favoritePlaces') || '[]');
        let showingFavorites = false;
        let placesCache = {}; // ç¼“å­˜æœç´¢ç»“æœ
        let fetchTimeout = null; // é˜²æŠ–åŠ¨å®šæ—¶å™¨
        let currentFetchController = null; // ç”¨äºå–æ¶ˆè¯·æ±‚
        let markerClusterGroup = null; // æ ‡è®°èšåˆç»„
        let currentServerIndex = 0; // å½“å‰ä½¿ç”¨çš„æœåŠ¡å™¨ç´¢å¼•
        let requestId = 0; // è¯·æ±‚IDï¼Œç”¨äºè·Ÿè¸ªæœ€æ–°è¯·æ±‚
        let isRequesting = false; // æ˜¯å¦æ­£åœ¨è¯·æ±‚ä¸­
        let displayedCount = 10; // å½“å‰æ˜¾ç¤ºçš„æ•°é‡
        const INITIAL_DISPLAY_COUNT = 10; // åˆå§‹æ˜¾ç¤º10ä¸ª
        const LOAD_MORE_COUNT = 10; // æ¯æ¬¡åŠ è½½æ›´å¤š10ä¸ª
        let myLocationMarker = null; // ç”¨æˆ·ä½ç½®æ ‡è®°
        let loadingStartTime = 0; // åŠ è½½å¼€å§‹æ—¶é—´
        let progressInterval = null; // è¿›åº¦æ›´æ–°å®šæ—¶å™¨
        let currentMessage = 'æ­£åœ¨é€£æ¥æœå‹™å™¨...'; // å½“å‰åŠ è½½æ¶ˆæ¯
        let currentProgress = 0; // å½“å‰è¿›åº¦
        let lastSearchPosition = null; // ä¸Šæ¬¡æœç´¢çš„ä½ç½®
        let autoSearchEnabled = false; // æ˜¯å¦å¯ç”¨è‡ªåŠ¨æœç´¢
        
        // å°æ¸¸æˆç›¸å…³å˜é‡
        let gameActive = false;
        let gameStarted = false;
        let catY = 150;
        let catVelocity = 0;
        let pills = [];
        let gameScore = 0;
        let gameInterval = null;
        let gameCanvas = null;
        let gameCtx = null;
        let lastFrameTime = 0;
        let gameSpeed = 3; // æ¸¸æˆé€Ÿåº¦ï¼Œä¼šé€æ¸å¢åŠ 
        let isOnGround = true; // æ˜¯å¦åœ¨åœ°é¢ä¸Š
        const GRAVITY = 0.5;
        const JUMP_STRENGTH = -7.5; // é™ä½è·³è·ƒé«˜åº¦
        const CAT_SIZE = 35;
        const PILL_WIDTH = 25;
        const PILL_HEIGHT = 35;
        const FRAME_RATE = 1000 / 60; // 60 FPS
        const GROUND_Y = 130; // åœ°é¢ä½ç½®
        const MAX_SPEED = 8; // æœ€å¤§é€Ÿåº¦
        
        // å¤šä¸ª Overpass API æœåŠ¡å™¨å¤‡ç”¨
        const overpassServers = [
            'https://overpass.kumi.systems/api/interpreter',
            'https://overpass-api.de/api/interpreter',
            'https://overpass.openstreetmap.ru/api/interpreter',
            'https://overpass.openstreetmap.fr/api/interpreter'
        ];

        // æ™‚æ®µåœ–æ¨™æ˜ å°„
        const timeSlotIcons = {
            morning: 'ğŸŒ…',
            noon: 'â˜€ï¸',
            evening: 'ğŸŒ†',
            bedtime: 'ğŸŒ™'
        };

        const timeSlotNames = {
            morning: 'æ—©ä¸Š',
            noon: 'ä¸­åˆ',
            evening: 'æ™šä¸Š',
            bedtime: 'ç¡å‰'
        };

        // åˆå§‹åŒ–
        function init() {
            loadData();
            loadProfile();
            renderMedicines();
            // åˆå§‹åŒ–å¥åº·è¨˜éŒ„é é¢
            changeHealthType(currentHealthType);
            // åœ°åœ–é è¨­æ¿¾é¡
            mapFilter = localStorage.getItem('mapFilter') || 'pharmacy';
        }

        // è¼‰å…¥æ•¸æ“š
        function loadData() {
            const savedMedicines = localStorage.getItem('medicines');
            const savedHistory = localStorage.getItem('history');
            const savedHealthRecords = localStorage.getItem('healthRecords');

            if (savedMedicines) {
                medicines = JSON.parse(savedMedicines);
                // å‡ç´šï¼šè£œä¸Š createdAt ä»¥æ”¯æ´ä¾æ·»åŠ æ™‚é–“æ’åº
                let upgraded = false;
                medicines.forEach(m => {
                    if (!m.createdAt) {
                        const fallbackTs = parseInt(m.id) || Date.now();
                        m.createdAt = fallbackTs;
                        upgraded = true;
                    }
                });
                if (upgraded) {
                    localStorage.setItem('medicines', JSON.stringify(medicines));
                }
            }

            if (savedHistory) {
                history = JSON.parse(savedHistory);
            }

            if (savedHealthRecords) {
                healthRecords = JSON.parse(savedHealthRecords);
            }
        }

        // ä¿å­˜æ•¸æ“š
        function saveData() {
            localStorage.setItem('medicines', JSON.stringify(medicines));
            localStorage.setItem('history', JSON.stringify(history));
            localStorage.setItem('healthRecords', JSON.stringify(healthRecords));
        }

        // è¼‰å…¥å€‹äººè³‡æ–™
        function loadProfile() {
            const profile = JSON.parse(localStorage.getItem('profile') || '{}');
            document.getElementById('userName').value = profile.name || '';
            document.getElementById('userAge').value = profile.age || '';
            document.getElementById('userGender').value = profile.gender || 'ç”·æ€§';
            document.getElementById('userHeight').value = profile.height || '';
            document.getElementById('userWeight').value = profile.weight || '';
            if (document.getElementById('userDisease')) {
                document.getElementById('userDisease').value = profile.disease || '';
            }
        }

        // ä¿å­˜å€‹äººè³‡æ–™
        function saveProfile() {
            const profile = {
                name: document.getElementById('userName').value,
                age: document.getElementById('userAge').value,
                gender: document.getElementById('userGender').value,
                height: document.getElementById('userHeight').value,
                weight: document.getElementById('userWeight').value,
                disease: (document.getElementById('userDisease') && document.getElementById('userDisease').value) || ''
            };
            localStorage.setItem('profile', JSON.stringify(profile));
        }

        // åˆ‡æ›åˆ†é¡
        function changeCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === category) {
                    btn.classList.add('active');
                }
            });
            renderMedicines();
        }

        // æœå°‹è—¥å“
        function searchMedicines() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            renderMedicines(searchText);
        }

        // æ¸²æŸ“è—¥å“åˆ—è¡¨
        function renderMedicines(searchText = '') {
            const listContainer = document.getElementById('medicineList');
            let filteredMedicines = medicines.filter(m => m.category === currentCategory);
            
            if (searchText) {
                filteredMedicines = filteredMedicines.filter(m => 
                    m.name.toLowerCase().includes(searchText)
                );
            }

            // æ’åº
            filteredMedicines = sortMedicines(filteredMedicines, medicineSortMode);

            if (filteredMedicines.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        <h3>æš«ç„¡${currentCategory}</h3>
                        <p>é»æ“Š + æŒ‰éˆ•æ·»åŠ æ–°è—¥å“</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = filteredMedicines.map(medicine => `
                <div class="medicine-card" onclick="showMedicineDetail('${medicine.id}')">
                    <div class="medicine-image">
                        ${medicine.imageData ? `<img src="${medicine.imageData}" alt="${medicine.name}">` : 'ğŸ’Š'}
                    </div>
                    <div class="medicine-info">
                        <div class="medicine-name">${medicine.name}</div>
                        <div class="medicine-dosage">æ¯æ¬¡ ${medicine.dosage}</div>
                    </div>
                    <div class="time-slots">
                        ${medicine.timeSlots.map(slot => `
                            <div class="time-slot ${isTakenToday(medicine.id, slot) ? 'taken' : ''}" 
                                 onclick="event.stopPropagation(); takeMedicine('${medicine.id}', '${slot}')">
                                ${timeSlotIcons[slot]}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // è—¥å“æ’åº
        function sortMedicines(list, mode) {
            const arr = list.slice();
            switch (mode) {
                case 'stock_asc':
                    return arr.sort((a, b) => (a.stock || 0) - (b.stock || 0));
                case 'stock_desc':
                    return arr.sort((a, b) => (b.stock || 0) - (a.stock || 0));
                case 'created_desc':
                    return arr.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                case 'created_asc':
                    return arr.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
                default:
                    return arr;
            }
        }

        function toggleSortMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('sortMenu');
            menu.classList.toggle('show');
            // é»æ“Šå¤–éƒ¨é—œé–‰
            const close = (e) => {
                if (!menu.contains(e.target)) {
                    menu.classList.remove('show');
                    document.removeEventListener('click', close);
                }
            };
            document.addEventListener('click', close);
        }

        function setMedicineSort(mode) {
            medicineSortMode = mode;
            localStorage.setItem('medicineSortMode', medicineSortMode);
            renderMedicines(document.getElementById('searchInput').value.toLowerCase());
            const labels = {
                created_desc: 'æ–°å¢æ™‚é–“ æ–°â†’èˆŠ',
                created_asc: 'æ–°å¢æ™‚é–“ èˆŠâ†’æ–°',
                stock_desc: 'åº«å­˜ é«˜â†’ä½',
                stock_asc: 'åº«å­˜ ä½â†’é«˜'
            };
            showToast('æ’åºï¼š' + labels[medicineSortMode], 'success');
            const menu = document.getElementById('sortMenu');
            if (menu) menu.classList.remove('show');
        }

        // é¡¯ç¤ºè—¥å“è©³æƒ…
        function showMedicineDetail(medicineId) {
            const medicine = medicines.find(m => m.id === medicineId);
            if (!medicine) return;

            currentMedicineDetail = medicine;
            document.getElementById('detailMedicineName').textContent = medicine.name;
            
            const detailContent = document.getElementById('medicineDetailContent');
            detailContent.innerHTML = `
                ${medicine.imageData ? `<img src="${medicine.imageData}" style="width: 100%; border-radius: 12px; margin-bottom: 20px;">` : ''}
                <div class="profile-item">
                    <span class="profile-label">é¡åˆ¥</span>
                    <span class="profile-value">${medicine.category}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">æ¯æ¬¡ç”¨é‡</span>
                    <span class="profile-value">${medicine.dosage}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">å‰©é¤˜åº«å­˜</span>
                    <span class="profile-value">${medicine.stock || 0}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">æœç”¨æ™‚æ®µ</span>
                    <span class="profile-value">${medicine.timeSlots.map(s => timeSlotNames[s]).join('ã€')}</span>
                </div>
                ${medicine.notes ? `
                    <div class="profile-item" style="flex-direction: column; align-items: flex-start;">
                        <span class="profile-label">å‚™è¨»</span>
                        <span class="profile-value" style="margin-top: 8px;">${medicine.notes}</span>
                    </div>
                ` : ''}
            `;
            
            showModal('medicineDetailModal');
        }

        // ç·¨è¼¯ç•¶å‰è—¥å“
        function editCurrentMedicine() {
            if (currentMedicineDetail) {
                closeModal('medicineDetailModal');
                editMedicine(currentMedicineDetail.id);
            }
        }

        // æª¢æŸ¥ä»Šå¤©æ˜¯å¦å·²æœç”¨
        function isTakenToday(medicineId, slot) {
            const today = new Date().toDateString();
            return history.some(h => 
                h.medicineId === medicineId && 
                h.slot === slot && 
                new Date(h.date).toDateString() === today
            );
        }

        // æœè—¥è¨˜éŒ„
        function takeMedicine(medicineId, slot) {
            if (isTakenToday(medicineId, slot)) return;

            const medicine = medicines.find(m => m.id === medicineId);
            if (!medicine) return;

            // ä½¿ç”¨è‡ªå®šç¾©ç¢ºèªå°è©±æ¡†
            showConfirmDialog(
                'ç¢ºèªæœè—¥',
                `æ‚¨ç¢ºå®šå·²ç¶“æœç”¨äº† ${medicine.name} ${medicine.dosage} å—ï¼Ÿ`,
                () => {
                    // æ¸›å°‘åº«å­˜
                    if (medicine.stock && medicine.stock > 0) {
                        medicine.stock--;
                    }

                    history.push({
                        id: Date.now().toString(),
                        medicineId: medicineId,
                        medicineName: medicine.name,
                        dosage: medicine.dosage,
                        slot: slot,
                        date: new Date().toISOString()
                    });
                    
                    saveData();
                    renderMedicines();
                    renderHealthRecords();
                    showToast('æœè—¥è¨˜éŒ„å·²ä¿å­˜', 'success');
                }
            );
        }

        // é¡¯ç¤ºæ·»åŠ è—¥å“
        function showAddMedicine() {
            editingMedicineId = null;
            document.getElementById('modalTitle').textContent = 'æ·»åŠ è—¥å“';
            document.getElementById('deleteMedicineBtn').style.display = 'none';
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('medicineName').value = '';
            document.getElementById('medicineCategory').value = currentCategory;
            document.getElementById('medicineDosage').value = '';
            document.getElementById('medicineStock').value = '';
            document.getElementById('medicineNotes').value = '';
            document.getElementById('medicineImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            
            document.querySelectorAll('.time-slot-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            showModal('addMedicineModal');
        }

        // ç·¨è¼¯è—¥å“
        function editMedicine(medicineId) {
            const medicine = medicines.find(m => m.id === medicineId);
            if (!medicine) return;

            editingMedicineId = medicineId;
            document.getElementById('modalTitle').textContent = 'ç·¨è¼¯è—¥å“';
            document.getElementById('deleteMedicineBtn').style.display = 'block';
            
            document.getElementById('medicineName').value = medicine.name;
            document.getElementById('medicineCategory').value = medicine.category;
            document.getElementById('medicineDosage').value = medicine.dosage;
            document.getElementById('medicineStock').value = medicine.stock || '';
            document.getElementById('medicineNotes').value = medicine.notes || '';
            
            if (medicine.imageData) {
                document.getElementById('imagePreview').src = medicine.imageData;
                document.getElementById('imagePreview').style.display = 'block';
            }
            
            document.querySelectorAll('.time-slot-option').forEach(el => {
                if (medicine.timeSlots.includes(el.dataset.slot)) {
                    el.classList.add('selected');
                } else {
                    el.classList.remove('selected');
                }
            });
            
            showModal('addMedicineModal');
        }

        // åˆ‡æ›æ™‚æ®µé¸æ“‡
        function toggleTimeSlot(element) {
            element.classList.toggle('selected');
        }

        // åœ–ç‰‡é è¦½
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ä¿å­˜è—¥å“
        function saveMedicine() {
            // é˜²æ­¢é‡è¤‡æäº¤
            if (isSubmitting) {
                showToast('æ­£åœ¨ä¿å­˜ä¸­ï¼Œè«‹ç¨å€™...', 'info');
                return;
            }

            const name = document.getElementById('medicineName').value.trim();
            const category = document.getElementById('medicineCategory').value;
            const dosage = document.getElementById('medicineDosage').value.trim();
            const stock = parseInt(document.getElementById('medicineStock').value) || 0;
            const notes = document.getElementById('medicineNotes').value.trim();
            const imagePreview = document.getElementById('imagePreview');
            
            // æª¢æŸ¥å¿…å¡«æ¬„ä½
            if (!name || !dosage) {
                showToast('è«‹å¡«å¯«è—¥å“åç¨±å’Œç”¨é‡', 'error');
                return;
            }

            const selectedSlots = Array.from(document.querySelectorAll('.time-slot-option.selected'))
                .map(el => el.dataset.slot);
            
            if (selectedSlots.length === 0) {
                showToast('è«‹é¸æ“‡è‡³å°‘ä¸€å€‹æœç”¨æ™‚æ®µ', 'error');
                return;
            }

            // è¨­ç½®æäº¤ç‹€æ…‹
            isSubmitting = true;
            const saveButton = document.querySelector('#addMedicineModal .btn-primary');
            if (saveButton) {
                saveButton.textContent = 'ä¿å­˜ä¸­...';
                saveButton.disabled = true;
            }

            const medicineData = {
                name,
                category,
                dosage,
                stock,
                notes,
                timeSlots: selectedSlots,
                imageData: imagePreview.style.display !== 'none' ? imagePreview.src : null,
                createdAt: Date.now()
            };

            try {
                if (editingMedicineId) {
                    const index = medicines.findIndex(m => m.id === editingMedicineId);
                    if (index !== -1) {
                        medicines[index] = { ...medicines[index], ...medicineData };
                    }
                } else {
                    medicines.push({
                        id: Date.now().toString(),
                        ...medicineData
                    });
                }

                saveData();
                renderMedicines();
                closeModal('addMedicineModal');
                showToast('è—¥å“ä¿å­˜æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('ä¿å­˜è—¥å“æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showToast('ä¿å­˜å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
            } finally {
                // é‡ç½®æäº¤ç‹€æ…‹
                isSubmitting = false;
                if (saveButton) {
                    saveButton.textContent = 'ä¿å­˜';
                    saveButton.disabled = false;
                }
            }
        }

        // åˆªé™¤è—¥å“
        function deleteMedicine() {
            if (!editingMedicineId) return;
            
            showConfirmDialog(
                'åˆªé™¤è—¥å“',
                'ç¢ºå®šè¦åˆªé™¤é€™å€‹è—¥å“å—ï¼Ÿ',
                () => {
                    medicines = medicines.filter(m => m.id !== editingMedicineId);
                    saveData();
                    renderMedicines();
                    closeModal('addMedicineModal');
                    showToast('è—¥å“å·²åˆªé™¤', 'success');
                }
            );
        }

        // é¡¯ç¤ºæ­·å²è¨˜éŒ„
        function showHistory() {
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h3>æš«ç„¡æœè—¥è¨˜éŒ„</h3>
                    </div>
                `;
            } else {
                const sortedHistory = [...history].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                
                historyList.innerHTML = sortedHistory.map(item => {
                    const date = new Date(item.date);
                    return `
                        <div class="history-item">
                            <div class="history-date">${date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                            <div class="history-medicine">${item.medicineName}</div>
                            <div class="history-time">${timeSlotNames[item.slot]} - ${item.dosage}</div>
                        </div>
                    `;
                }).join('');
            }
            
            showModal('historyModal');
        }

        // å¥åº·è¨˜éŒ„é¡å‹é…ç½®
        const healthTypes = {
            bloodPressure: { name: 'è¡€å£“', icon: 'â¤ï¸', unit: 'mmHg', color: '#dc3545' },
            bloodSugar: { name: 'è¡€ç³–', icon: 'ğŸ©¸', unit: 'mmol/L', color: '#fd7e14' },
            heartRate: { name: 'å¿ƒç‡', icon: 'ğŸ’“', unit: 'bpm', color: '#e83e8c' },
            bloodOxygen: { name: 'è¡€æ°§', icon: 'ğŸ«', unit: '%', color: '#007bff' },
            weight: { name: 'é«”é‡', icon: 'âš–ï¸', unit: 'kg', color: '#28a745' },
            medication: { name: 'ç”¨è—¥è¨˜éŒ„', icon: 'ğŸ’Š', unit: '', color: '#6f42c1' }
        };

        // åˆ‡æ›å¥åº·è¨˜éŒ„é¡å‹
        function changeHealthType(type) {
            console.log(`åˆ‡æ›å¥åº·è¨˜éŒ„é¡å‹åˆ°: ${type}`);
            currentHealthType = type;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === type) {
                    btn.classList.add('active');
                }
            });

            // é¡¯ç¤º/éš±è—åŒæ­¥æŒ‰éˆ•
            const syncButton = document.getElementById('syncButton');
            if (type === 'medication') {
                syncButton.style.display = 'block';
            } else {
                syncButton.style.display = 'none';
            }

            // é‡æ–°æ¸²æŸ“å¥åº·è¨˜éŒ„ï¼ˆåªé¡¯ç¤ºé¸ä¸­é¡å‹çš„è¨˜éŒ„ï¼‰
            renderHealthRecords();
            updateChart();
            
            // é¡¯ç¤ºåˆ‡æ›æç¤º
            const totalRecords = healthRecords.length;
            const filteredRecords = healthRecords.filter(record => record && record.type === type);
            console.log(`ç¸½è¨˜éŒ„æ•¸: ${totalRecords}, ${healthTypes[type].name}è¨˜éŒ„æ•¸: ${filteredRecords.length}`);
            
            if (totalRecords > 0 && filteredRecords.length === 0) {
                showToast(`å·²åˆ‡æ›åˆ°${healthTypes[type].name}ï¼Œç•¶å‰æ²’æœ‰æ­¤é¡å‹çš„è¨˜éŒ„`, 'info');
            }
        }

        // æ¸²æŸ“å¥åº·è¨˜éŒ„
        function renderHealthRecords() {
            const container = document.getElementById('healthRecordsList');
            
            // ç¢ºä¿åªé¡¯ç¤ºç•¶å‰é¸ä¸­é¡å‹çš„è¨˜éŒ„
            const filteredRecords = healthRecords.filter(record => {
                return record && record.type === currentHealthType;
            });
            
            console.log(`ç•¶å‰é¡å‹: ${currentHealthType}, éæ¿¾å¾Œè¨˜éŒ„æ•¸: ${filteredRecords.length}, ç¸½è¨˜éŒ„æ•¸: ${healthRecords.length}`);
            
            if (filteredRecords.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <h3>æš«ç„¡${healthTypes[currentHealthType].name}è¨˜éŒ„</h3>
                        <p>é»æ“Šå³ä¸‹æ–¹ + æŒ‰éˆ•æ·»åŠ æ–°è¨˜éŒ„</p>
                    </div>
                `;
                return;
            }

            // æŒ‰æ—¥æœŸåˆ†çµ„
            const groupedByDate = {};
            filteredRecords.forEach(record => {
                const dateKey = new Date(record.date).toLocaleDateString('zh-TW');
                if (!groupedByDate[dateKey]) {
                    groupedByDate[dateKey] = [];
                }
                groupedByDate[dateKey].push(record);
            });

            const sortedDates = Object.keys(groupedByDate).sort((a, b) => 
                new Date(b) - new Date(a)
            );

            container.innerHTML = sortedDates.map(date => `
                <div class="date-group">
                    <div class="date-group-title">${formatDateHeader(date)}</div>
                    ${groupedByDate[date].sort((a, b) => new Date(b.date) - new Date(a.date)).map(record => `
                        <div class="health-record-item" onclick="editHealthRecord('${record.id}')">
                            <div class="health-record-header">
                                <div class="health-record-type">
                                    <span>${healthTypes[record.type].icon}</span>
                                    <span>${healthTypes[record.type].name}</span>
                                </div>
                                <div class="health-record-time">${formatTime(new Date(record.date))}</div>
                            </div>
                            <div class="health-record-value">${formatHealthValue(record)}</div>
                            ${record.note ? `<div class="health-record-note">${record.note}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        // æ ¼å¼åŒ–å¥åº·è¨˜éŒ„æ•¸å€¼
        function formatHealthValue(record) {
            if (record.type === 'bloodPressure') {
                return `${record.value}/${record.value2} ${healthTypes[record.type].unit}`;
            } else if (record.type === 'medication') {
                return `${record.medicationName || 'æœªçŸ¥è—¥ç‰©'}${record.dosage ? ' (' + record.dosage + ')' : ''}`;
            } else {
                return `${record.value} ${healthTypes[record.type].unit}`;
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ¨™é¡Œ
        function formatDateHeader(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (date.toDateString() === today.toDateString()) {
                return 'ä»Šå¤©';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'æ˜¨å¤©';
            } else {
                return dateString;
            }
        }

        // æ ¼å¼åŒ–æ™‚é–“
        function formatTime(date) {
            return date.toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // åˆ‡æ›è¦–åœ–
        function switchView(view) {
            document.querySelectorAll('.view-container').forEach(el => {
                el.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active');
            });

            if (view === 'medicines') {
                document.getElementById('medicinesView').classList.add('active');
                document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            } else if (view === 'health') {
                document.getElementById('healthView').classList.add('active');
                document.querySelector('.nav-item:nth-child(2)').classList.add('active');
                renderHealthRecords();
                updateChart();
            } else if (view === 'map') {
                document.getElementById('mapView').classList.add('active');
                document.querySelector('.nav-item:nth-child(3)').classList.add('active');
                initMapOnce();
            } else if (view === 'profile') {
                document.getElementById('profileView').classList.add('active');
                document.querySelector('.nav-item:nth-child(4)').classList.add('active');
            }
        }

        // æ¨¡æ…‹çª—å£æ§åˆ¶
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // é»æ“Šæ¨¡æ…‹çª—å£å¤–éƒ¨é—œé–‰
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('show');
                }
            });
        });

        // Toast æç¤ºåŠŸèƒ½
        function showToast(message, type = 'info') {
            // ç§»é™¤ç¾æœ‰çš„ toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // å‰µå»ºæ–°çš„ toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // é¡¯ç¤º toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            // è‡ªå‹•éš±è—
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 3000);
        }

        // é˜²æ­¢é‡è¤‡æäº¤
        let isSubmitting = false;

        // è‡ªå®šç¾©ç¢ºèªå°è©±æ¡†
        function showConfirmDialog(title, message, onConfirm) {
            // ç§»é™¤ç¾æœ‰çš„ç¢ºèªå°è©±æ¡†
            const existingDialog = document.querySelector('.confirm-dialog');
            if (existingDialog) {
                existingDialog.remove();
            }

            // å‰µå»ºç¢ºèªå°è©±æ¡†
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog modal show';
            dialog.innerHTML = `
                <div class="modal-content" style="max-width: 400px; text-align: center; padding: 24px 20px;">
                    <h3 style="margin-top: 8px; margin-bottom: 16px; font-size: 18px; font-weight: 600;">${title}</h3>
                    <p style="margin-bottom: 24px; color: #666;">${message}</p>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn-cancel" style="flex: 1; padding: 12px; background: #f5f5f5; color: #333; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;">å–æ¶ˆ</button>
                        <button class="btn-confirm" style="flex: 1; padding: 12px; background: #4D9980; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;">ç¢ºèª</button>
                    </div>
                </div>
            `;

            document.body.appendChild(dialog);

            // ç¶å®šäº‹ä»¶
            dialog.querySelector('.btn-cancel').onclick = () => {
                dialog.remove();
            };

            dialog.querySelector('.btn-confirm').onclick = () => {
                dialog.remove();
                if (onConfirm) onConfirm();
            };

            // é»æ“ŠèƒŒæ™¯é—œé–‰
            dialog.onclick = (e) => {
                if (e.target === dialog) {
                    dialog.remove();
                }
            };
        }

        // å¥åº·è¨˜éŒ„ç›¸é—œåŠŸèƒ½
        function showAddHealthRecord() {
            document.getElementById('healthRecordType').value = currentHealthType;
            document.getElementById('healthRecordDate').value = new Date().toISOString().slice(0, 16);
            document.getElementById('healthRecordNote').value = '';
            document.getElementById('systolicPressure').value = '';
            document.getElementById('diastolicPressure').value = '';
            document.getElementById('healthRecordValue').value = '';
            document.getElementById('healthMedicationName').value = '';
            document.getElementById('healthMedicationDosage').value = '';
            
            updateHealthRecordForm();
            showModal('addHealthRecordModal');
        }

        function updateHealthRecordForm() {
            const type = document.getElementById('healthRecordType').value;
            const bloodPressureInputs = document.getElementById('bloodPressureInputs');
            const singleValueInput = document.getElementById('singleValueInput');
            const medicationInputs = document.getElementById('medicationInputs');
            const unitSpan = document.getElementById('healthRecordUnit');

            // éš±è—æ‰€æœ‰è¼¸å…¥å€åŸŸ
            bloodPressureInputs.style.display = 'none';
            singleValueInput.style.display = 'none';
            medicationInputs.style.display = 'none';

            if (type === 'bloodPressure') {
                bloodPressureInputs.style.display = 'block';
            } else if (type === 'medication') {
                medicationInputs.style.display = 'block';
            } else {
                singleValueInput.style.display = 'block';
                unitSpan.textContent = healthTypes[type].unit;
            }
        }

        function saveHealthRecord() {
            const type = document.getElementById('healthRecordType').value;
            const date = document.getElementById('healthRecordDate').value;
            const note = document.getElementById('healthRecordNote').value.trim();

            if (!date) {
                showToast('è«‹é¸æ“‡æ—¥æœŸæ™‚é–“', 'error');
                return;
            }

            let record = {
                id: Date.now().toString(),
                type: type,
                date: new Date(date).toISOString(),
                note: note || null
            };

            if (type === 'bloodPressure') {
                const systolic = parseFloat(document.getElementById('systolicPressure').value);
                const diastolic = parseFloat(document.getElementById('diastolicPressure').value);
                
                if (!systolic || !diastolic) {
                    showToast('è«‹å¡«å¯«è¡€å£“æ•¸å€¼', 'error');
                    return;
                }
                
                record.value = systolic;
                record.value2 = diastolic;
            } else if (type === 'medication') {
                const medicationName = document.getElementById('healthMedicationName').value.trim();
                const dosage = document.getElementById('healthMedicationDosage').value.trim();
                
                if (!medicationName) {
                    showToast('è«‹å¡«å¯«è—¥å“åç¨±', 'error');
                    return;
                }
                
                record.medicationName = medicationName;
                record.dosage = dosage || null;
                record.value = 0;
            } else {
                const value = parseFloat(document.getElementById('healthRecordValue').value);
                
                if (!value && value !== 0) {
                    showToast('è«‹å¡«å¯«æ¸¬é‡å€¼', 'error');
                    return;
                }
                
                record.value = value;
            }

            healthRecords.push(record);
            saveData();
            
            // è‡ªå‹•åˆ‡æ›åˆ°å‰›æ·»åŠ çš„è¨˜éŒ„é¡å‹
            if (currentHealthType !== record.type) {
                changeHealthType(record.type);
            } else {
                renderHealthRecords();
                updateChart();
            }
            
            closeModal('addHealthRecordModal');
            showToast(`${healthTypes[record.type].name}è¨˜éŒ„ä¿å­˜æˆåŠŸï¼`, 'success');
        }

        function editHealthRecord(recordId) {
            const record = healthRecords.find(r => r.id === recordId);
            if (!record) return;

            editingHealthRecordId = recordId;
            document.getElementById('editRecordType').value = healthTypes[record.type].name;
            document.getElementById('editRecordDate').value = new Date(record.date).toISOString().slice(0, 16);
            document.getElementById('editRecordNote').value = record.note || '';

            const editValueInputs = document.getElementById('editValueInputs');
            
            if (record.type === 'bloodPressure') {
                editValueInputs.innerHTML = `
                    <label class="form-label">è¡€å£“æ•¸å€¼</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="editSystolicPressure" class="form-input" value="${record.value}" style="flex: 1;">
                        <span>/</span>
                        <input type="number" id="editDiastolicPressure" class="form-input" value="${record.value2}" style="flex: 1;">
                        <span>mmHg</span>
                    </div>
                `;
            } else if (record.type === 'medication') {
                editValueInputs.innerHTML = `
                    <label class="form-label">è—¥å“åç¨±</label>
                    <input type="text" id="editMedicationName" class="form-input" value="${record.medicationName || ''}">
                    
                    <label class="form-label" style="margin-top: 15px;">åŠ‘é‡</label>
                    <input type="text" id="editMedicationDosage" class="form-input" value="${record.dosage || ''}">
                `;
            } else {
                editValueInputs.innerHTML = `
                    <label class="form-label">æ¸¬é‡å€¼</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="editHealthValue" class="form-input" value="${record.value}" step="0.1" style="flex: 1;">
                        <span>${healthTypes[record.type].unit}</span>
                    </div>
                `;
            }

            showModal('editHealthRecordModal');
        }

        function updateHealthRecord() {
            const record = healthRecords.find(r => r.id === editingHealthRecordId);
            if (!record) return;

            const date = document.getElementById('editRecordDate').value;
            const note = document.getElementById('editRecordNote').value.trim();

            if (!date) {
                showToast('è«‹é¸æ“‡æ—¥æœŸæ™‚é–“', 'error');
                return;
            }

            record.date = new Date(date).toISOString();
            record.note = note || null;

            if (record.type === 'bloodPressure') {
                const systolic = parseFloat(document.getElementById('editSystolicPressure').value);
                const diastolic = parseFloat(document.getElementById('editDiastolicPressure').value);
                
                if (!systolic || !diastolic) {
                    showToast('è«‹å¡«å¯«è¡€å£“æ•¸å€¼', 'error');
                    return;
                }
                
                record.value = systolic;
                record.value2 = diastolic;
            } else if (record.type === 'medication') {
                const medicationName = document.getElementById('editMedicationName').value.trim();
                const dosage = document.getElementById('editMedicationDosage').value.trim();
                
                if (!medicationName) {
                    showToast('è«‹å¡«å¯«è—¥å“åç¨±', 'error');
                    return;
                }
                
                record.medicationName = medicationName;
                record.dosage = dosage || null;
            } else {
                const value = parseFloat(document.getElementById('editHealthValue').value);
                
                if (!value && value !== 0) {
                    showToast('è«‹å¡«å¯«æ¸¬é‡å€¼', 'error');
                    return;
                }
                
                record.value = value;
            }

            saveData();
            
            // ç¢ºä¿é¡¯ç¤ºæ›´æ–°å¾Œçš„è¨˜éŒ„
            if (currentHealthType !== record.type) {
                changeHealthType(record.type);
            } else {
                renderHealthRecords();
                updateChart();
            }
            
            closeModal('editHealthRecordModal');
            showToast('å¥åº·è¨˜éŒ„æ›´æ–°æˆåŠŸï¼', 'success');
        }

        function deleteHealthRecord() {
            showConfirmDialog(
                'åˆªé™¤å¥åº·è¨˜éŒ„',
                'ç¢ºå®šè¦åˆªé™¤é€™æ¢å¥åº·è¨˜éŒ„å—ï¼Ÿ',
                () => {
                    const recordToDelete = healthRecords.find(r => r.id === editingHealthRecordId);
                    healthRecords = healthRecords.filter(r => r.id !== editingHealthRecordId);
                    saveData();
                    
                    // åˆ·æ–°ç•¶å‰é¡å‹çš„è¨˜éŒ„é¡¯ç¤º
                    renderHealthRecords();
                    updateChart();
                    closeModal('editHealthRecordModal');
                    
                    if (recordToDelete) {
                        showToast(`${healthTypes[recordToDelete.type].name}è¨˜éŒ„å·²åˆªé™¤`, 'success');
                    } else {
                        showToast('å¥åº·è¨˜éŒ„å·²åˆªé™¤', 'success');
                    }
                }
            );
        }

        // åŒæ­¥è—¥å“è¨˜éŒ„
        function syncMedicationRecords() {
            const newRecords = [];
            
            history.forEach(h => {
                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„ç”¨è—¥è¨˜éŒ„
                const exists = healthRecords.some(r => 
                    r.type === 'medication' &&
                    r.medicationName === h.medicineName &&
                    new Date(r.date).toDateString() === new Date(h.date).toDateString() &&
                    r.note === `${timeSlotNames[h.slot]} - ${h.dosage}`
                );

                if (!exists) {
                    newRecords.push({
                        id: Date.now().toString() + Math.random(),
                        type: 'medication',
                        date: h.date,
                        medicationName: h.medicineName,
                        dosage: h.dosage,
                        note: `${timeSlotNames[h.slot]} - ${h.dosage}`,
                        value: 0
                    });
                }
            });

            if (newRecords.length > 0) {
                healthRecords.push(...newRecords);
                saveData();
                renderHealthRecords();
                showToast(`å·²åŒæ­¥ ${newRecords.length} æ¢è—¥å“è¨˜éŒ„`, 'success');
            } else {
                showToast('æ²’æœ‰æ–°çš„è—¥å“è¨˜éŒ„éœ€è¦åŒæ­¥', 'info');
            }
        }

        // åŒ¯å‡ºåŠŸèƒ½
        function showExportOptions() {
            showModal('exportOptionsModal');
        }

        async function exportToPDF() {
            const selectedTypes = getSelectedExportTypes();
            if (selectedTypes.length === 0) {
                showToast('è«‹é¸æ“‡è‡³å°‘ä¸€ç¨®è¨˜éŒ„é¡å‹', 'error');
                return;
            }

            const filteredRecords = healthRecords.filter(record => selectedTypes.includes(record.type));
            if (filteredRecords.length === 0) {
                showToast('æ²’æœ‰å¯åŒ¯å‡ºçš„è¨˜éŒ„', 'error');
                return;
            }

            // å»ºç«‹è‡¨æ™‚ DOMï¼ˆä½¿ç”¨åŸç”Ÿå­—å‹æ¸²æŸ“ï¼Œç¢ºä¿ç¹é«”ä¸­æ–‡é¡¯ç¤ºæ­£ç¢ºï¼‰
            const container = document.createElement('div');
            container.style.padding = '24px';
            container.style.width = '794px'; // A4 å¯¬åº¦ @96DPI ç´„ 794px
            container.style.boxSizing = 'border-box';
            container.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft JhengHei', sans-serif";
            // è®“æ¯å€‹å€å¡Šé¿å…è¢«æˆªæ–·
            container.style.wordBreak = 'break-word';

            const title = document.createElement('h2');
            title.textContent = 'å¥åº·è¨˜éŒ„å ±å‘Š';
            title.style.textAlign = 'center';
            title.style.color = '#2f6f5d';
            container.appendChild(title);

            const gen = document.createElement('div');
            gen.style.textAlign = 'center';
            gen.style.marginBottom = '12px';
            gen.textContent = 'ç”Ÿæˆæ™‚é–“ï¼š' + new Date().toLocaleString('zh-TW');
            container.appendChild(gen);

            const imageLoadPromises = [];

            selectedTypes.forEach(type => {
                const typeRecords = filteredRecords.filter(r => r.type === type);
                if (typeRecords.length === 0) return;

                const section = document.createElement('div');
                section.style.margin = '16px 0 24px';
                section.style.pageBreakInside = 'avoid';

                const header = document.createElement('h3');
                header.textContent = `${healthTypes[type].name}è¨˜éŒ„`;
                header.style.color = '#4D9980';
                header.style.margin = '0 0 8px 0';
                section.appendChild(header);

                // åœ–è¡¨
                if (type !== 'medication' && typeRecords.length >= 2) {
                    const chartPxWidth = 1000;
                    const chartPxHeight = 360;
                    const dpr = Math.min(2, Math.max(1.5, window.devicePixelRatio || 1));
                    const { dataUrl } = getChartImageData(type, typeRecords, chartPxWidth, chartPxHeight, dpr);
                    const img = document.createElement('img');
                    img.src = dataUrl;
                    img.style.width = '100%';
                    img.style.height = 'auto';
                    img.style.margin = '6px 0 10px';
                    section.appendChild(img);
                    imageLoadPromises.push(new Promise(res => { img.onload = () => res(); img.onerror = () => res(); }));
                }

                // æ¸…å–®
                const list = document.createElement('div');
                const recordsForPdf = typeRecords
                    .slice()
                    .sort((a, b) => new Date(b.date) - new Date(a.date)); // é¡¯ç¤ºæ‰€æœ‰ç­†æ•¸
                list.style.display = 'grid';
                list.style.gridTemplateColumns = '1fr 1fr';
                list.style.columnGap = '24px';
                list.style.rowGap = '6px';

                recordsForPdf.forEach(record => {
                    const row = document.createElement('div');
                    row.style.pageBreakInside = 'avoid';
                    const dateStr = new Date(record.date).toLocaleString('zh-TW');
                    let valueStr = '';
                    if (record.type === 'bloodPressure') {
                        valueStr = `${record.value}/${record.value2} ${healthTypes[record.type].unit}`;
                    } else if (record.type === 'medication') {
                        valueStr = `${record.medicationName || 'æœªçŸ¥è—¥ç‰©'}${record.dosage ? ' (' + record.dosage + ')' : ''}`;
                    } else {
                        valueStr = `${record.value} ${healthTypes[record.type].unit}`;
                    }
                    row.textContent = `${dateStr}    ${valueStr}`;
                    list.appendChild(row);
                });

                section.appendChild(list);
                container.appendChild(section);
            });

            // æ›åˆ° body å¾Œç”¨ html2pdf åŒ¯å‡ºï¼Œå†ç§»é™¤
            document.body.appendChild(container);

            // ç­‰å¾…æ‰€æœ‰åœ–è¡¨åœ–ç‰‡è¼‰å…¥ï¼Œé¿å…è¢«æˆªåœ–æ™‚ç¼ºåœ–
            try { await Promise.all(imageLoadPromises); } catch (_) {}

            const opt = {
                margin:       [10, 10, 10, 10], // mm
                filename:     'å¥åº·è¨˜éŒ„å ±å‘Š_' + new Date().toISOString().slice(0,10) + '.pdf',
                image:        { type: 'jpeg', quality: 0.92 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().from(container).set(opt).save().then(() => {
                container.remove();
                closeModal('exportOptionsModal');
                showToast('PDFåŒ¯å‡ºæˆåŠŸï¼', 'success');
            }).catch(err => {
                console.error('PDFåŒ¯å‡ºå¤±æ•—:', err);
                container.remove();
                showToast('PDFåŒ¯å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
            });
        }

        // åœ–ç‰‡åŒ¯å‡ºåŠŸèƒ½å·²ç§»é™¤ï¼ˆåƒ…ä¿ç•™ PDF åŒ¯å‡ºï¼‰

        // ä»¥å›ºå®šå°ºå¯¸èˆ‡åƒç´ æ¯”å‰µå»ºé›¢å±åœ–è¡¨ï¼Œé¿å…åŒ¯å‡ºæ™‚è¢«å£“ç¸®è®Šå½¢
        function createExportChart(type, records, cssWidth, cssHeight, devicePixelRatio = 2) {
            const tempCanvas = document.createElement('canvas');
            // ç‰©ç†è§£åƒåº¦ï¼šCSS å°ºå¯¸ * åƒç´ æ¯”ï¼Œç¢ºä¿æ¸…æ™°
            tempCanvas.width = Math.floor(cssWidth * devicePixelRatio);
            tempCanvas.height = Math.floor(cssHeight * devicePixelRatio);
            tempCanvas.style.width = cssWidth + 'px';
            tempCanvas.style.height = cssHeight + 'px';
            const ctx = tempCanvas.getContext('2d');
            // å°‡åæ¨™ç³»ç¸®æ”¾åˆ° DPRï¼Œé¿å…åœ–è¡¨è¢«æ‹‰ä¼¸
            ctx.scale(devicePixelRatio, devicePixelRatio);
            
            const sortedRecords = records.sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = sortedRecords.map(record => {
                const date = new Date(record.date);
                return date.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });
            });

            if (type === 'bloodPressure') {
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'æ”¶ç¸®å£“',
                                data: sortedRecords.map(record => record.value),
                                borderColor: '#dc3545',
                                backgroundColor: '#dc3545',
                                tension: 0.1,
                                pointRadius: 4
                            },
                            {
                                label: 'èˆ’å¼µå£“',
                                data: sortedRecords.map(record => record.value2),
                                borderColor: '#007bff',
                                backgroundColor: '#007bff',
                                tension: 0.1,
                                pointRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: false,
                        animation: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${healthTypes[type].name}è¶¨å‹¢åœ–`,
                                font: { size: 18, weight: 'bold' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: healthTypes[type].unit
                                }
                            }
                        }
                    }
                });
                // å¼·åˆ¶ç«‹å³æ¸²æŸ“
                chart.update();
                return { canvas: tempCanvas, chart };
            } else {
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: healthTypes[type].name,
                            data: sortedRecords.map(record => record.value),
                            borderColor: healthTypes[type].color,
                            backgroundColor: healthTypes[type].color,
                            tension: 0.1,
                            pointRadius: 4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: false,
                         animation: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${healthTypes[type].name}è¶¨å‹¢åœ–`,
                                font: { size: 18, weight: 'bold' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: healthTypes[type].unit
                                }
                            }
                        }
                    }
                });
                // å¼·åˆ¶ç«‹å³æ¸²æŸ“
                chart.update();
                return { canvas: tempCanvas, chart };
            }
        }

        // å–å¾—åœ–è¡¨ PNG dataURLï¼ˆå°è£ createExportChartï¼‰
        function getChartImageData(type, records, widthPx, heightPx, dpr) {
            const { canvas, chart } = createExportChart(type, records, widthPx, heightPx, dpr);
            const dataUrl = canvas.toDataURL('image/png');
            chart.destroy();
            return { dataUrl, widthPx, heightPx };
        }

        function getSelectedExportTypes() {
            const checkboxes = document.querySelectorAll('.export-types input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // åœ–è¡¨åŠŸèƒ½
        function updateChart() {
            const filteredRecords = healthRecords.filter(record => record.type === currentHealthType);
            
            // åªæœ‰éç”¨è—¥è¨˜éŒ„ä¸”æœ‰å¤šå€‹æ•¸æ“šé»æ™‚æ‰é¡¯ç¤ºåœ–è¡¨
            if (currentHealthType === 'medication' || filteredRecords.length < 2) {
                document.getElementById('chartContainer').style.display = 'none';
                return;
            }

            document.getElementById('chartContainer').style.display = 'block';
            
            // éŠ·æ¯€ç¾æœ‰åœ–è¡¨
            if (healthChart) {
                healthChart.destroy();
            }

            const ctx = document.getElementById('healthChart').getContext('2d');
            const sortedRecords = filteredRecords.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const labels = sortedRecords.map(record => {
                const date = new Date(record.date);
                return date.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });
            });

            if (currentHealthType === 'bloodPressure') {
                // è¡€å£“é›™ç·šåœ–è¡¨
                healthChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'æ”¶ç¸®å£“',
                                data: sortedRecords.map(record => record.value),
                                borderColor: '#dc3545',
                                backgroundColor: '#dc3545',
                                tension: 0.1,
                                pointRadius: 4
                            },
                            {
                                label: 'èˆ’å¼µå£“',
                                data: sortedRecords.map(record => record.value2),
                                borderColor: '#007bff',
                                backgroundColor: '#007bff',
                                tension: 0.1,
                                pointRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${healthTypes[currentHealthType].name}è¶¨å‹¢åœ–`,
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: healthTypes[currentHealthType].unit
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ—¥æœŸ'
                                }
                            }
                        }
                    }
                });
            } else {
                // å–®ç·šåœ–è¡¨
                healthChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: healthTypes[currentHealthType].name,
                            data: sortedRecords.map(record => record.value),
                            borderColor: healthTypes[currentHealthType].color,
                            backgroundColor: healthTypes[currentHealthType].color,
                            tension: 0.1,
                            pointRadius: 4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${healthTypes[currentHealthType].name}è¶¨å‹¢åœ–`,
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: healthTypes[currentHealthType].unit
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ—¥æœŸ'
                                }
                            }
                        }
                    }
                });
            }
        }

        // -------- Map (Leaflet + Overpass) ----------
        function initMapOnce() {
            if (mapInited) return;
            mapInited = true;
            const mapEl = document.getElementById('map');
            
            // ä¼˜åŒ–ï¼šä½¿ç”¨æ›´å¿«çš„ç“¦ç‰‡æœåŠ¡å™¨ï¼Œå¹¶å¯ç”¨ç¡¬ä»¶åŠ é€Ÿ
            mapInstance = L.map(mapEl, {
                preferCanvas: true, // ä½¿ç”¨ Canvas æ¸²æŸ“ï¼Œæ€§èƒ½æ›´å¥½
                zoomControl: true,
                attributionControl: false
            }).setView([25.033964, 121.564468], 14);
            
            // ä½¿ç”¨å¤šä¸ªç“¦ç‰‡æœåŠ¡å™¨è½®æ¢ï¼Œæé«˜åŠ è½½é€Ÿåº¦
            const tileUrls = [
                'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
            ];
            
            L.tileLayer(tileUrls[0], {
                maxZoom: 18,
                attribution: '&copy; OpenStreetMap',
                updateWhenIdle: true, // åªåœ¨åœæ­¢ç§»åŠ¨æ—¶æ›´æ–°
                updateWhenZooming: false, // ç¼©æ”¾æ—¶ä¸æ›´æ–°
                keepBuffer: 2 // ä¿æŒ2å±å¹•çš„ç¼“å†²åŒº
            }).addTo(mapInstance);

            // å®šä½ - ä¼˜åŒ–è¶…æ—¶è®¾ç½®
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const { latitude, longitude } = pos.coords;
                    mapInstance.setView([latitude, longitude], 15);
                    
                    // ä¿å­˜ç”¨æˆ·ä½ç½®æ ‡è®°
                    myLocationMarker = L.circle([latitude, longitude], { 
                        radius: 30, 
                        color: '#4D9980',
                        fillColor: '#4D9980',
                        fillOpacity: 0.5
                    }).addTo(mapInstance);
                    
                    userPosition = { lat: latitude, lon: longitude };
                    debouncedFetchPlaces(latitude, longitude);
                }, (err) => {
                    console.warn('å®šä½å¤±æ•—/è¢«æ‹’çµ•:', err);
                    debouncedFetchPlaces();
                }, { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 }); // é™ä½ç²¾åº¦è¦æ±‚ï¼Œæé«˜é€Ÿåº¦
            } else {
                debouncedFetchPlaces();
            }
            
            // åœ°å›¾ç§»åŠ¨ç»“æŸåæ˜¾ç¤º"æœç´¢æ­¤åŒºåŸŸ"æŒ‰é’®
            mapInstance.on('moveend', () => {
                const center = mapInstance.getCenter();
                
                // è®¡ç®—ç§»åŠ¨è·ç¦»
                if (lastSearchPosition) {
                    const distance = distanceInMeters(
                        lastSearchPosition.lat, 
                        lastSearchPosition.lon, 
                        center.lat, 
                        center.lng
                    );
                    
                    // å¦‚æœç§»åŠ¨è·ç¦»è¶…è¿‡500ç±³ï¼Œæ˜¾ç¤º"æœç´¢æ­¤åŒºåŸŸ"æŒ‰é’®
                    if (distance > 500) {
                        showSearchAreaButton();
                    } else {
                        // ç§»åŠ¨è·ç¦»å¤ªå°ï¼Œéšè—æŒ‰é’®
                        hideSearchAreaButton();
                    }
                } else {
                    // é¦–æ¬¡ç§»åŠ¨ï¼Œéšè—æŒ‰é’®
                    hideSearchAreaButton();
                }
            });
        }

        // æ˜¾ç¤º"æœç´¢æ­¤åŒºåŸŸ"æŒ‰é’®
        function showSearchAreaButton() {
            const btn = document.getElementById('searchAreaBtn');
            if (btn) {
                btn.style.display = 'block';
            }
        }

        // éšè—"æœç´¢æ­¤åŒºåŸŸ"æŒ‰é’®
        function hideSearchAreaButton() {
            const btn = document.getElementById('searchAreaBtn');
            if (btn) {
                btn.style.display = 'none';
            }
        }

        // æœç´¢å½“å‰åŒºåŸŸ
        function searchCurrentArea() {
            hideSearchAreaButton();
            const center = mapInstance.getCenter();
            fetchPlaces(center.lat, center.lng);
        }

        // å›åˆ°æˆ‘çš„ä½ç½®
        function goToMyLocation() {
            if (userPosition) {
                // æœ‰ä¿å­˜çš„ä½ç½®ï¼Œç›´æ¥è·³è½¬
                mapInstance.setView([userPosition.lat, userPosition.lon], 15);
                
                // è®©æ ‡è®°é—ªçƒä¸€ä¸‹æç¤ºç”¨æˆ·
                if (myLocationMarker) {
                    const originalRadius = 30;
                    myLocationMarker.setRadius(50);
                    setTimeout(() => myLocationMarker.setRadius(originalRadius), 300);
                }
            } else {
                // é‡æ–°è·å–ä½ç½®
                const btn = document.getElementById('myLocationBtn');
                btn.innerHTML = 'â³';
                btn.disabled = true;
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((pos) => {
                        const { latitude, longitude } = pos.coords;
                        mapInstance.setView([latitude, longitude], 15);
                        
                        // åˆ›å»ºæˆ–æ›´æ–°ä½ç½®æ ‡è®°
                        if (myLocationMarker) {
                            myLocationMarker.setLatLng([latitude, longitude]);
                        } else {
                            myLocationMarker = L.circle([latitude, longitude], { 
                                radius: 30, 
                                color: '#4D9980',
                                fillColor: '#4D9980',
                                fillOpacity: 0.5
                            }).addTo(mapInstance);
                        }
                        
                        userPosition = { lat: latitude, lon: longitude };
                        btn.innerHTML = 'ğŸ“';
                        btn.disabled = false;
                        
                        // é‡æ–°åŠ è½½é™„è¿‘æ•°æ®
                        fetchPlaces(latitude, longitude);
                    }, (err) => {
                        alert('ç„¡æ³•ç²å–æ‚¨çš„ä½ç½®ï¼Œè«‹ç¢ºèªå·²å…è¨±å®šä½æ¬Šé™');
                        btn.innerHTML = 'ğŸ“';
                        btn.disabled = false;
                    }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 });
                } else {
                    alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒå®šä½åŠŸèƒ½');
                    btn.innerHTML = 'ğŸ“';
                    btn.disabled = false;
                }
            }
        }

        // é˜²æŠ–åŠ¨å‡½æ•° - åªç”¨äºåœ°å›¾ç§»åŠ¨ç­‰é¢‘ç¹äº‹ä»¶
        function debouncedFetchPlaces(lat, lon) {
            if (fetchTimeout) {
                clearTimeout(fetchTimeout);
            }
            fetchTimeout = setTimeout(() => {
                fetchPlaces(lat, lon);
            }, 300); // å‡å°‘åˆ°300ms
        }

        function setMapFilter(f) {
            mapFilter = f;
            localStorage.setItem('mapFilter', f);
            
            // ç«‹å³å–æ¶ˆæ‰€æœ‰è¿›è¡Œä¸­çš„è¯·æ±‚
            cancelCurrentRequest();
            
            const center = mapInstance.getCenter();
            // ç”¨æˆ·ä¸»åŠ¨ç‚¹å‡»ï¼Œç«‹å³æ‰§è¡Œï¼Œä¸ä½¿ç”¨é˜²æŠ–åŠ¨
            fetchPlaces(center.lat, center.lng);
            
            // UI active
            document.querySelectorAll('#mapView .type-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.filter === f);
            });
        }
        
        // å–æ¶ˆå½“å‰è¯·æ±‚ï¼ˆä½†ä¿ç•™æ¸¸æˆï¼‰
        function cancelCurrentRequest() {
            // å–æ¶ˆé˜²æŠ–åŠ¨å®šæ—¶å™¨
            if (fetchTimeout) {
                clearTimeout(fetchTimeout);
                fetchTimeout = null;
            }
            
            // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¯·æ±‚
            if (currentFetchController) {
                currentFetchController.abort();
                currentFetchController = null;
            }
            
            // æ¸…é™¤è¿›åº¦å®šæ—¶å™¨
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            
            // é‡ç½®è¯·æ±‚çŠ¶æ€
            isRequesting = false;
            
            // æ˜¾ç¤ºå–æ¶ˆæç¤ºï¼ˆä¿ç•™æ¸¸æˆï¼‰
            const list = document.getElementById('placeList');
            if (list) {
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>ğŸš« å·²å–æ¶ˆæœå°‹</h3>
                        <p style="color: #999; margin: 12px 0;">
                            ${gameActive ? 'ç¹¼çºŒç©éŠæˆ²ï¼Œæˆ–èª¿æ•´è¨­å®šå¾Œé‡æ–°æœå°‹' : 'æ‚¨å¯ä»¥èª¿æ•´è¨­å®šå¾Œé‡æ–°æœå°‹'}
                        </p>
                        <button onclick="fetchPlaces()" class="sync-btn" style="margin-top: 12px;">ğŸ”„ é‡æ–°æœå°‹</button>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºåŠ è½½è¿›åº¦
        function showLoadingProgress(container, message, progress) {
            const elapsed = Math.floor((Date.now() - loadingStartTime) / 1000);
            
            // 10ç§’åå¯åŠ¨æ¸¸æˆ
            if (elapsed >= 10 && !gameActive) {
                startMiniGame(container, message, elapsed);
                return;
            }
            
            // æ™ºèƒ½æç¤ºå’Œæ“ä½œï¼šæ ¹æ®å®é™…ç­‰å¾…æ—¶é—´
            let actionButtons = '';
            if (elapsed > 10 && gameActive) {
                actionButtons = `
                    <div style="margin-top: 16px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="cancelCurrentRequest(); quickFix();" 
                                style="background: linear-gradient(135deg, #b8c5d6 0%, #a8b9cc 100%); 
                                       color: #4a5568; 
                                       border: 1px solid #cbd5e0; 
                                       padding: 10px 20px; 
                                       border-radius: 8px; 
                                       font-size: 14px; 
                                       font-weight: 500;
                                       cursor: pointer; 
                                       box-shadow: 0 2px 6px rgba(0,0,0,0.08);
                                       transition: all 0.3s ease;
                                       display: inline-flex;
                                       align-items: center;
                                       gap: 6px;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 10px rgba(0,0,0,0.12)'; this.style.background='linear-gradient(135deg, #a8b9cc 0%, #98aabb 100%)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.08)'; this.style.background='linear-gradient(135deg, #b8c5d6 0%, #a8b9cc 100%)';">
                            <span style="font-size: 16px;">âš¡</span> å„ªåŒ–è¨­å®šé‡è©¦
                        </button>
                        <button onclick="cancelCurrentRequest();" 
                                style="background: linear-gradient(135deg, #e8eaed 0%, #d5d8dc 100%); 
                                       color: #5a6270; 
                                       border: 1px solid #cbd5e0; 
                                       padding: 10px 20px; 
                                       border-radius: 8px; 
                                       font-size: 14px; 
                                       font-weight: 500;
                                       cursor: pointer; 
                                       box-shadow: 0 2px 6px rgba(0,0,0,0.08);
                                       transition: all 0.3s ease;
                                       display: inline-flex;
                                       align-items: center;
                                       gap: 6px;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 10px rgba(0,0,0,0.12)'; this.style.background='linear-gradient(135deg, #d5d8dc 0%, #c5c9cd 100%)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.08)'; this.style.background='linear-gradient(135deg, #e8eaed 0%, #d5d8dc 100%)';">
                            <span style="font-size: 16px;">â¸ï¸</span> å–æ¶ˆ
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="loading" style="padding: 30px 20px;">
                    <div class="spinner"></div>
                    <div style="margin-top: 16px; text-align: center;">
                        <div style="font-size: 15px; font-weight: 500; margin-bottom: 8px;">${message}</div>
                        <div style="font-size: 13px; color: #999; margin-bottom: 16px;">
                            å·²ç­‰å¾… <strong>${elapsed}</strong> ç§’
                            ${elapsed > 20 ? '<span style="color: #ff9800;">ï¼ˆè¼ƒæ…¢ï¼‰</span>' : ''}
                            ${elapsed > 45 ? '<span style="color: #f44336;">ï¼ˆç•°å¸¸æ…¢ï¼‰</span>' : ''}
                        </div>
                        
                        <!-- è¿›åº¦æ¡ -->
                        <div style="background: #e0e0e0; height: 6px; border-radius: 3px; overflow: hidden; margin: 0 auto; max-width: 200px;">
                            <div style="background: linear-gradient(90deg, #4D9980, #6cb896); height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                        </div>
                        
                        ${actionButtons}
                    </div>
                </div>
            `;
        }

        // å¯åŠ¨è¿·ä½ æ¸¸æˆ
        function startMiniGame(container, message, elapsed) {
            if (gameActive) return;
            
            try {
                gameActive = true;
                gameStarted = false;
                gameScore = 0;
                catY = GROUND_Y; // è°ƒæ•´åˆå§‹ä½ç½®é€‚åº”æ–°ç”»å¸ƒå¤§å°
                catVelocity = 0;
                pills = [];
                gameSpeed = 3; // é‡ç½®é€Ÿåº¦
                isOnGround = true;
            
            // åœ¨ä¸‹æ–¹åˆ—è¡¨åŒºåŸŸåªæ˜¾ç¤ºç®€å•çš„ç­‰å¾…æç¤º
            container.innerHTML = `
                <div class="loading" style="padding: 30px 20px;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                        ${message}
                    </div>
                    <div style="font-size: 12px; color: #999;">
                        å·²ç­‰å¾… <strong>${elapsed}</strong> ç§’
                    </div>
                    <div style="margin-top: 16px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="cancelCurrentRequest(); quickFix();" 
                                style="background: linear-gradient(135deg, #b8c5d6 0%, #a8b9cc 100%); 
                                       color: #4a5568; 
                                       border: 1px solid #cbd5e0; 
                                       padding: 8px 16px; 
                                       border-radius: 8px; 
                                       font-size: 13px; 
                                       cursor: pointer;">
                            âš¡ å„ªåŒ–è¨­å®šé‡è©¦
                        </button>
                        <button onclick="cancelCurrentRequest();" 
                                style="background: linear-gradient(135deg, #e8eaed 0%, #d5d8dc 100%); 
                                       color: #5a6270; 
                                       border: 1px solid #cbd5e0; 
                                       padding: 8px 16px; 
                                       border-radius: 8px; 
                                       font-size: 13px; 
                                       cursor: pointer;">
                            â¸ï¸ å–æ¶ˆ
                        </button>
                    </div>
                </div>
            `;
            
            // æ˜¾ç¤ºç‹¬ç«‹çš„æ¸¸æˆæµ®å±‚
            const gameOverlay = document.getElementById('miniGameOverlay');
            if (gameOverlay) {
                gameOverlay.style.display = 'block';
            }
            
            // åˆå§‹åŒ–æ¸¸æˆ
            setTimeout(() => {
                try {
                    gameCanvas = document.getElementById('gameCanvas');
                    if (!gameCanvas) {
                        console.error('æ— æ³•æ‰¾åˆ°æ¸¸æˆç”»å¸ƒ');
                        return;
                    }
                    
                    gameCtx = gameCanvas.getContext('2d');
                    if (!gameCtx) {
                        console.error('æ— æ³•è·å–Canvasä¸Šä¸‹æ–‡');
                        return;
                    }
                    
                    // æ·»åŠ ç‚¹å‡»å’Œè§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯å…¼å®¹ï¼‰
                    gameCanvas.addEventListener('click', catJump);
                    gameCanvas.addEventListener('touchend', handleTouch);
                    document.addEventListener('keydown', handleGameKeyPress);
                    
                    runGame();
                } catch (error) {
                    console.error('åˆå§‹åŒ–æ¸¸æˆå¤±è´¥:', error);
                    gameActive = false;
                }
            }, 100);
            
            } catch (error) {
                console.error('å¯åŠ¨æ¸¸æˆå¤±è´¥:', error);
                gameActive = false;
                // é™çº§æ˜¾ç¤ºæ™®é€šåŠ è½½ç•Œé¢
                container.innerHTML = `
                    <div class="loading" style="padding: 30px 20px;">
                        <div class="spinner"></div>
                        <div style="margin-top: 16px; text-align: center;">
                            <div style="font-size: 15px; font-weight: 500; margin-bottom: 8px;">${message}</div>
                            <div style="font-size: 13px; color: #999; margin-bottom: 16px;">å·²ç­‰å¾… ${elapsed} ç§’</div>
                        </div>
                    </div>
                `;
            }
        }

        // çŒ«å’ªè·³è·ƒ
        function catJump(e) {
            if (!gameActive) return;
            
            // åªåœ¨ç‚¹å‡»æ¸¸æˆç”»å¸ƒæ—¶é˜»æ­¢é»˜è®¤è¡Œä¸º
            if (e && e.target === gameCanvas && e.preventDefault) {
                e.preventDefault();
            }
            
            if (!gameStarted) {
                gameStarted = true;
            }
            
            // åªæœ‰åœ¨åœ°é¢ä¸Šæ‰èƒ½è·³è·ƒï¼ˆé˜²æ­¢è¿ç»­è·³è·ƒç´¯ç§¯é«˜åº¦ï¼‰
            if (isOnGround) {
                catVelocity = JUMP_STRENGTH;
                isOnGround = false;
            }
        }

        // è§¦æ‘¸æ§åˆ¶ï¼ˆæ‰‹æœºç«¯ï¼‰
        function handleTouch(e) {
            // åªåœ¨æ¸¸æˆæ¿€æ´»æ—¶å¤„ç†
            if (!gameActive) return;
            
            // ä¸é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œå…è®¸æ»šåŠ¨
            // åªè°ƒç”¨è·³è·ƒ
            catJump();
        }

        // é”®ç›˜æ§åˆ¶
        function handleGameKeyPress(e) {
            if (gameActive && e.code === 'Space') {
                e.preventDefault();
                catJump(e);
            }
        }

        // æ¸¸æˆä¸»å¾ªç¯
        function runGame(currentTime = 0) {
            if (!gameActive || !gameCanvas || !gameCtx) return;
            
            // å¸§ç‡æ§åˆ¶ï¼ˆé¿å…è¿‡åº¦å ç”¨èµ„æºï¼‰
            const elapsed = currentTime - lastFrameTime;
            if (elapsed < FRAME_RATE) {
                if (gameActive) {
                    requestAnimationFrame(runGame);
                }
                return;
            }
            lastFrameTime = currentTime;
            
            try {
                const canvas = gameCanvas;
                const ctx = gameCtx;
                
                // æ¸…ç©ºç”»å¸ƒ
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶åœ°é¢
            ctx.fillStyle = '#e0e0e0';
            ctx.fillRect(0, 170, canvas.width, 10);
            
            if (gameStarted) {
                // æ›´æ–°çŒ«å’ªä½ç½®
                catVelocity += GRAVITY;
                catY += catVelocity;
                
                // é™åˆ¶çŒ«å’ªä¸è¦æ‰å‡ºåœ°é¢ï¼ˆè°ƒæ•´é€‚åº”æ–°ç”»å¸ƒï¼‰
                if (catY >= GROUND_Y) {
                    catY = GROUND_Y;
                    catVelocity = 0;
                    isOnGround = true; // ç€åœ°äº†
                } else {
                    isOnGround = false; // åœ¨ç©ºä¸­
                }
                
                if (catY < 0) {
                    catY = 0;
                    catVelocity = 0;
                }
                
                // æ ¹æ®åˆ†æ•°é€æ¸åŠ é€Ÿï¼ˆæ¯5åˆ†åŠ é€Ÿä¸€æ¬¡ï¼Œæœ€é«˜8å€é€Ÿï¼‰
                gameSpeed = Math.min(MAX_SPEED, 3 + Math.floor(gameScore / 5) * 0.5);
                
                // ç”Ÿæˆè¯ä¸¸éšœç¢ç‰©
                if (pills.length === 0 || pills[pills.length - 1].x < canvas.width - 120) {
                    pills.push({
                        x: canvas.width,
                        y: 130,
                        passed: false
                    });
                }
                
                // æ›´æ–°å¹¶ç»˜åˆ¶è¯ä¸¸
                pills = pills.filter(pill => {
                    pill.x -= gameSpeed; // ä½¿ç”¨åŠ¨æ€é€Ÿåº¦
                    
                    // æ£€æµ‹ç¢°æ’ï¼ˆæ›´ç²¾ç¡®çš„ç¢°æ’æ£€æµ‹ï¼‰
                    const catLeft = 40 - CAT_SIZE/2 + 5;
                    const catRight = 40 + CAT_SIZE/2 - 5;
                    const catTop = catY + 5;
                    const catBottom = catY + CAT_SIZE - 5;
                    
                    const pillLeft = pill.x + 5;
                    const pillRight = pill.x + PILL_WIDTH - 5;
                    const pillTop = pill.y + 5;
                    const pillBottom = pill.y + PILL_HEIGHT - 5;
                    
                    if (catRight > pillLeft && catLeft < pillRight && 
                        catBottom > pillTop && catTop < pillBottom) {
                        // ç¢°åˆ°äº†ï¼æ¸¸æˆç»“æŸ
                        stopMiniGame(true);
                        return false;
                    }
                    
                    // è®¡åˆ†
                    if (!pill.passed && pill.x < 20) {
                        pill.passed = true;
                        gameScore++;
                        try {
                            const scoreEl = document.getElementById('gameScore');
                            if (scoreEl) {
                                scoreEl.textContent = gameScore;
                            }
                        } catch (e) {
                            // å…ƒç´ å¯èƒ½å·²è¢«ç§»é™¤ï¼Œå¿½ç•¥é”™è¯¯
                        }
                    }
                    
                    // ç»˜åˆ¶è¯ä¸¸ ğŸ’Šï¼ˆä½¿ç”¨å…¼å®¹æ€§æ›´å¥½çš„æ–¹æ³•ï¼‰
                    if (pill.x > -PILL_WIDTH) {
                        // ç»˜åˆ¶èƒ¶å›Šå½¢çŠ¶
                        ctx.fillStyle = '#ff6b9d';
                        
                        const radius = PILL_WIDTH / 2;
                        const centerY = pill.y + PILL_HEIGHT / 2;
                        
                        // ä¸ŠåŠåœ†
                        ctx.beginPath();
                        ctx.arc(pill.x + radius, pill.y + radius, radius - 1, 0, Math.PI, true);
                        ctx.fill();
                        
                        // çŸ©å½¢ä¸»ä½“
                        ctx.fillRect(pill.x + 1, pill.y + radius, PILL_WIDTH - 2, PILL_HEIGHT - PILL_WIDTH);
                        
                        // ä¸‹åŠåœ†
                        ctx.beginPath();
                        ctx.arc(pill.x + radius, pill.y + PILL_HEIGHT - radius, radius - 1, 0, Math.PI, false);
                        ctx.fill();
                        
                        // è¯ä¸¸ä¸­é—´çš„çº¿
                        ctx.strokeStyle = '#fff';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(pill.x + 4, centerY);
                        ctx.lineTo(pill.x + PILL_WIDTH - 4, centerY);
                        ctx.stroke();
                        
                        return true;
                    }
                    return false;
                });
            }
            
            // ç»˜åˆ¶çŒ«å’ª ğŸ±
            ctx.save();
            ctx.translate(40, catY + CAT_SIZE/2);
            
            // çŒ«å’ªèº«ä½“
            ctx.fillStyle = '#ffa500';
            ctx.beginPath();
            ctx.ellipse(0, 0, CAT_SIZE/2, CAT_SIZE/2.5, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // çŒ«å’ªè€³æœµ
            ctx.fillStyle = '#ffa500';
            ctx.beginPath();
            ctx.moveTo(-15, -15);
            ctx.lineTo(-10, -25);
            ctx.lineTo(-5, -15);
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(5, -15);
            ctx.lineTo(10, -25);
            ctx.lineTo(15, -15);
            ctx.fill();
            
            // çŒ«å’ªçœ¼ç›
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(-8, -3, 3, 0, Math.PI * 2);
            ctx.arc(8, -3, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // çŒ«å’ªé¼»å­
            ctx.fillStyle = '#ff69b4';
            ctx.beginPath();
            ctx.arc(0, 3, 2, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
            
            // æç¤ºæ–‡å­—å’Œé€Ÿåº¦æ˜¾ç¤º
            if (!gameStarted) {
                ctx.fillStyle = '#999';
                ctx.font = '13px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('é»æ“Šç•«é¢é–‹å§‹', canvas.width / 2, 25);
            } else {
                // æ˜¾ç¤ºå½“å‰é€Ÿåº¦ï¼ˆå³ä¸Šè§’ï¼‰
                ctx.fillStyle = '#999';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(`é€Ÿåº¦ ${gameSpeed.toFixed(1)}x`, canvas.width - 10, 20);
            }
            
            // ç»§ç»­æ¸¸æˆå¾ªç¯
            if (gameActive) {
                requestAnimationFrame(runGame);
            }
            
            } catch (error) {
                console.error('æ¸¸æˆè¿è¡Œé”™è¯¯:', error);
                stopMiniGame(false);
            }
        }

        // åœæ­¢æ¸¸æˆï¼ˆcrashed = true è¡¨ç¤ºæ’åˆ°äº†ï¼Œfalse è¡¨ç¤ºæ­£å¸¸ç»“æŸï¼‰
        function stopMiniGame(crashed = false) {
            // ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
            document.removeEventListener('keydown', handleGameKeyPress);
            if (gameCanvas) {
                gameCanvas.removeEventListener('click', catJump);
                gameCanvas.removeEventListener('touchend', handleTouch);
            }
            
            // å¦‚æœæ˜¯æ’åˆ°äº†ï¼Œæ˜¾ç¤ºé‡æ–°å¼€å§‹é€‰é¡¹
            if (crashed && gameCanvas && gameCtx) {
                try {
                    gameActive = false;
                    gameStarted = false;
                    
                    const ctx = gameCtx;
                    ctx.fillStyle = 'rgba(0,0,0,0.6)';
                    ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 18px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('ğŸ’¥ æ’åˆ°äº†ï¼', gameCanvas.width / 2, gameCanvas.height / 2 - 30);
                    ctx.font = '14px sans-serif';
                    ctx.fillText(`åˆ†æ•¸: ${gameScore}`, gameCanvas.width / 2, gameCanvas.height / 2 - 5);
                    ctx.font = '12px sans-serif';
                    ctx.fillStyle = '#ffa500';
                    ctx.fillText(`æœ€é«˜é€Ÿåº¦: ${gameSpeed.toFixed(1)}x`, gameCanvas.width / 2, gameCanvas.height / 2 + 18);
                    ctx.font = '12px sans-serif';
                    ctx.fillStyle = '#4D9980';
                    ctx.fillText('é»æ“Šé‡æ–°é–‹å§‹', gameCanvas.width / 2, gameCanvas.height / 2 + 40);
                    
                    // æ·»åŠ é‡æ–°å¼€å§‹çš„ç‚¹å‡»äº‹ä»¶
                    const restartGame = () => {
                        if (gameCanvas) {
                            gameCanvas.removeEventListener('click', restartGame);
                            gameCanvas.removeEventListener('touchend', restartGame);
                        }
                        // é‡ç½®æ¸¸æˆ
                        restartMiniGame();
                    };
                    
                    gameCanvas.addEventListener('click', restartGame);
                    gameCanvas.addEventListener('touchend', restartGame);
                    
                } catch (error) {
                    console.error('åœæ­¢æ¸¸æˆé”™è¯¯:', error);
                }
            } else {
                // æœç´¢å®Œæˆï¼Œå¼ºåˆ¶ç»“æŸæ¸¸æˆ
                gameActive = false;
                gameStarted = false;
                
                // ç›´æ¥éšè—æ¸¸æˆæµ®å±‚
                const gameOverlay = document.getElementById('miniGameOverlay');
                if (gameOverlay) {
                    gameOverlay.style.display = 'none';
                }
            }
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartMiniGame() {
            gameActive = true;
            gameStarted = false;
            gameScore = 0;
            catY = GROUND_Y;
            catVelocity = 0;
            pills = [];
            gameSpeed = 3; // é‡ç½®é€Ÿåº¦
            isOnGround = true;
            
            // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
            const scoreEl = document.getElementById('gameScore');
            if (scoreEl) {
                scoreEl.textContent = '0';
            }
            
            // é‡æ–°æ·»åŠ äº‹ä»¶
            if (gameCanvas) {
                gameCanvas.addEventListener('click', catJump);
                gameCanvas.addEventListener('touchend', handleTouch);
                document.addEventListener('keydown', handleGameKeyPress);
            }
            
            // é‡æ–°å¯åŠ¨æ¸¸æˆå¾ªç¯
            runGame();
        }

        // å…³é—­æ¸¸æˆæµ®å±‚
        function closeGameOverlay() {
            // åœæ­¢æ¸¸æˆ
            gameActive = false;
            gameStarted = false;
            
            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
            document.removeEventListener('keydown', handleGameKeyPress);
            if (gameCanvas) {
                gameCanvas.removeEventListener('click', catJump);
                gameCanvas.removeEventListener('touchend', handleTouch);
            }
            
            // éšè—æµ®å±‚
            const gameOverlay = document.getElementById('miniGameOverlay');
            if (gameOverlay) {
                gameOverlay.style.display = 'none';
            }
        }

        // æ›´æ–°åŠ è½½è¿›åº¦
        function updateLoadingProgress(message, progress) {
            // æ›´æ–°å½“å‰çŠ¶æ€ï¼ˆç»™å®šæ—¶å™¨ä½¿ç”¨ï¼‰
            currentMessage = message;
            currentProgress = progress;
            
            const list = document.getElementById('placeList');
            if (list && isRequesting) {
                showLoadingProgress(list, message, progress);
            }
        }

        function clearMapMarkers() {
            mapMarkers.forEach(m => mapInstance.removeLayer(m));
            mapMarkers = [];
        }

        function fetchPlaces(lat, lon) {
            // å¦‚æœæ­£åœ¨è¯·æ±‚ä¸­ï¼Œå…ˆå–æ¶ˆ
            if (isRequesting) {
                cancelCurrentRequest();
            }
            
            // ç”Ÿæˆæ–°çš„è¯·æ±‚ID
            const thisRequestId = ++requestId;
            isRequesting = true;
            
            clearMapMarkers();
            const list = document.getElementById('placeList');
            
            // æ˜¾ç¤ºå¸¦è¿›åº¦çš„åŠ è½½ç•Œé¢
            loadingStartTime = Date.now();
            currentMessage = 'æ­£åœ¨é€£æ¥æœå‹™å™¨...';
            currentProgress = 0;
            showLoadingProgress(list, currentMessage, currentProgress);
            
            // å¯åŠ¨å®šæ—¶å™¨ï¼Œæ¯ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´æ˜¾ç¤º
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            progressInterval = setInterval(() => {
                if (isRequesting) {
                    showLoadingProgress(list, currentMessage, currentProgress);
                } else {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
            }, 1000); // æ¯ç§’æ›´æ–°ä¸€æ¬¡

            // è‹¥ç„¡å®šä½ï¼Œç”¨åœ°åœ–ä¸­å¿ƒ
            if (!lat || !lon) {
                const c = mapInstance.getCenter();
                lat = c.lat; lon = c.lng;
            }

            // æ£€æŸ¥ç¼“å­˜
            const cacheKey = `${mapFilter}_${lat.toFixed(4)}_${lon.toFixed(4)}_${searchRadius}`;
            if (placesCache[cacheKey]) {
                isRequesting = false;
                
                // è®°å½•æœç´¢ä½ç½®
                lastSearchPosition = { lat, lon };
                
                // éšè—"æœç´¢æ­¤åŒºåŸŸ"æŒ‰é’®
                hideSearchAreaButton();
                
                // æ¸…é™¤è¿›åº¦å®šæ—¶å™¨
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                
                // åœæ­¢æ¸¸æˆï¼ˆå¦‚æœåœ¨ç©ï¼‰
                if (gameActive) {
                    stopMiniGame(false);
                }
                
                renderPlaces(placesCache[cacheKey]);
                return;
            }

            // æ£€æŸ¥ç½‘ç»œè¿æ¥
            if (!navigator.onLine) {
                isRequesting = false;
                list.innerHTML = '<div class="empty-state"><h3>âŒ æ²’æœ‰ç¶²è·¯é€£æ¥</h3><p>è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯è¨­å®š</p></div>';
                return;
            }

            const filters = {
                // ç®€åŒ–"å…¨éƒ¨"æŸ¥è¯¢ï¼ŒåªåŒ…å«ä¸»è¦ç±»åˆ«
                all: 'nwr[amenity~"pharmacy|hospital|clinic|dentist"]',
                pharmacy: 'nwr[amenity=pharmacy]',
                hospital: 'nwr[amenity=hospital]',
                ent: 'nwr[healthcare:speciality=otorhinolaryngology]',
                obgyn: 'nwr[healthcare:speciality=gynaecology]',
                internal: 'nwr[healthcare:speciality=internal]',
                pediatric: 'nwr[healthcare:speciality=paediatrics]',
                dental: 'nwr[amenity=dentist]',
                eye: 'nwr[healthcare:speciality=ophthalmology]',
                ortho: 'nwr[healthcare:speciality=orthopaedics]',
                derm: 'nwr[healthcare:speciality=dermatology]',
                emergency: 'nwr[emergency=yes]'
            };

            // å¸¦é‡è¯•çš„è·å–å‡½æ•°
            const fetchWithRetry = async (serverIndex = 0, retryCount = 0) => {
                // æ£€æŸ¥è¿™ä¸ªè¯·æ±‚æ˜¯å¦è¿˜æ˜¯æœ€æ–°çš„
                if (thisRequestId !== requestId) {
                    return;
                }
                
                // åˆ›å»ºæ–°çš„ AbortController
                currentFetchController = new AbortController();
                const signal = currentFetchController.signal;

                const maxRetries = overpassServers.length;
                if (retryCount >= maxRetries) {
                    // æ£€æŸ¥è¿™ä¸ªè¯·æ±‚æ˜¯å¦è¿˜æ˜¯æœ€æ–°çš„
                    if (thisRequestId !== requestId) {
                        return;
                    }
                    
                    isRequesting = false;
                    
                    // è®°å½•æœç´¢ä½ç½®ï¼ˆå³ä½¿å¤±è´¥ï¼‰
                    lastSearchPosition = { lat, lon };
                    
                    // éšè—"æœç´¢æ­¤åŒºåŸŸ"æŒ‰é’®
                    hideSearchAreaButton();
                    
                    // æ¸…é™¤è¿›åº¦å®šæ—¶å™¨
                    if (progressInterval) {
                        clearInterval(progressInterval);
                        progressInterval = null;
                    }
                    
                    // åœæ­¢æ¸¸æˆ
                    if (gameActive) {
                        stopMiniGame(false);
                    }
                    
                    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                    const hintEl = document.getElementById('mapHint');
                    if (hintEl) {
                        hintEl.style.display = 'block';
                    }
                    
                    const finalScore = gameScore > 0 ? `<p style="color: #4D9980; font-size: 16px; font-weight: 500; margin: 8px 0;">ğŸ® éŠæˆ²åˆ†æ•¸ï¼š${gameScore}</p>` : '';
                    
                    list.innerHTML = `<div class="empty-state">
                        <h3>â±ï¸ æ‰€æœ‰æœå‹™å™¨éŸ¿æ‡‰è¶…æ™‚</h3>
                        <p style="margin: 12px 0;">å·²å˜—è©¦ ${maxRetries} å€‹æœå‹™å™¨éƒ½ç„¡æ³•é€£æ¥</p>
                        ${finalScore}
                        
                        <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin: 12px 0; text-align: left;">
                            <strong style="color: #856404;">ğŸ’¡ å»ºè­°è§£æ±ºæ–¹æ³•ï¼š</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; color: #856404;">
                                <li>é¸æ“‡æ›´å°çš„æœå°‹ç¯„åœï¼ˆ500ç±³æˆ–1å…¬é‡Œï¼‰</li>
                                <li>é¸æ“‡å–®ä¸€é¡åˆ¥ï¼ˆè—¥å±€ã€é†«é™¢ç­‰ï¼‰è€Œé"å…¨éƒ¨"</li>
                                <li>æª¢æŸ¥ç¶²è·¯é€£æ¥æ˜¯å¦ç©©å®š</li>
                                <li>ç¨å¾Œå†è©¦ï¼ˆé¿é–‹é«˜å³°æ™‚æ®µï¼‰</li>
                            </ul>
                        </div>
                        
                        <button onclick="quickFix()" class="sync-btn" style="margin-top:8px; background: #ff9800;">ğŸ”§ è‡ªå‹•å„ªåŒ–è¨­å®š</button>
                        <button onclick="fetchPlaces()" class="sync-btn" style="margin-top:8px; margin-left:8px;">ğŸ”„ é‡è©¦</button>
                    </div>`;
                    return;
                }

                const overpassHost = overpassServers[serverIndex % overpassServers.length];
                
                // åŠ¨æ€è°ƒæ•´æŸ¥è¯¢å‚æ•°ï¼šæ ¹æ®èŒƒå›´è°ƒæ•´ç»“æœæ•°é‡å’Œè¶…æ—¶æ—¶é—´
                const maxResults = searchRadius <= 2000 ? 40 : 25;
                const timeout = searchRadius <= 2000 ? 10 : 15;
                const clientTimeout = (timeout + 5) * 1000; // æ¯”æœåŠ¡å™¨è¶…æ—¶å¤š5ç§’
                
                const query = `[out:json][timeout:${timeout}];(${filters[mapFilter]}(around:${searchRadius},${lat},${lon}););out center ${maxResults};`;
                const overpass = `${overpassHost}?data=${encodeURIComponent(query)}`;

                // æ›´æ–°è¿›åº¦ï¼šæ­£åœ¨æŸ¥è¯¢
                const serverNum = serverIndex + 1;
                const totalServers = overpassServers.length;
                updateLoadingProgress(`æ­£åœ¨æŸ¥è©¢æœå‹™å™¨ ${serverNum}/${totalServers}...`, 20 + (serverIndex * 20));

                // æ·»åŠ è¶…æ—¶å¤„ç† - åŠ¨æ€è¶…æ—¶æ—¶é—´
                const timeoutId = setTimeout(() => {
                    currentFetchController.abort();
                }, clientTimeout);

                try {
                    const response = await fetch(overpass, { signal });
                    clearTimeout(timeoutId);
                    
                    // æ›´æ–°è¿›åº¦ï¼šæ­£åœ¨æ¥æ”¶æ•°æ®
                    updateLoadingProgress('æ­£åœ¨æ¥æ”¶æ•¸æ“š...', 60);
                    
                    // æ£€æŸ¥è¿™ä¸ªè¯·æ±‚æ˜¯å¦è¿˜æ˜¯æœ€æ–°çš„
                    if (thisRequestId !== requestId) {
                        return;
                    }
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    // æ›´æ–°è¿›åº¦ï¼šæ­£åœ¨è§£ææ•°æ®
                    updateLoadingProgress('æ­£åœ¨è§£ææ•¸æ“š...', 80);
                    
                    const data = await response.json();
                    
                    // å†æ¬¡æ£€æŸ¥ï¼ˆå› ä¸ºJSONè§£æéœ€è¦æ—¶é—´ï¼‰
                    if (thisRequestId !== requestId) {
                        return;
                    }
                    
                    // æ›´æ–°è¿›åº¦ï¼šæ­£åœ¨å¤„ç†ç»“æœ
                    updateLoadingProgress('æ­£åœ¨è™•ç†çµæœ...', 90);
                    
                    const elements = data.elements || [];
                    
                    if (elements.length === 0) {
                        isRequesting = false;
                        
                        // è®°å½•æœç´¢ä½ç½®
                        lastSearchPosition = { lat, lon };
                        
                        // éšè—"æœç´¢æ­¤åŒºåŸŸ"æŒ‰é’®
                        hideSearchAreaButton();
                        
                        // æ¸…é™¤è¿›åº¦å®šæ—¶å™¨
                        if (progressInterval) {
                            clearInterval(progressInterval);
                            progressInterval = null;
                        }
                        
                        // åœæ­¢æ¸¸æˆ
                        if (gameActive) {
                            stopMiniGame(false);
                        }
                        
                        // æ ¹æ®å½“å‰è®¾ç½®ç»™å‡ºæ™ºèƒ½å»ºè®®
                        const suggestions = [];
                        if (searchRadius < 2000) {
                            suggestions.push('æ“´å¤§æœå°‹ç¯„åœåˆ°2-3å…¬é‡Œ');
                        }
                        if (mapFilter !== 'all' && mapFilter !== 'pharmacy' && mapFilter !== 'hospital') {
                            suggestions.push('è©¦è©¦ã€Œå…¨éƒ¨ã€æˆ–ã€Œè—¥å±€ã€é¡åˆ¥');
                        }
                        if (searchRadius >= 2000) {
                            suggestions.push('è©¦è©¦å…¶ä»–é¡åˆ¥æˆ–ç§»å‹•åœ°åœ–ä½ç½®');
                        }
                        
                        const suggestionHtml = suggestions.length > 0 ? 
                            `<ul style="text-align: left; margin: 12px auto; max-width: 250px; color: #666;">
                                ${suggestions.map(s => `<li style="margin: 6px 0;">â€¢ ${s}</li>`).join('')}
                            </ul>` : '';
                        
                        const categoryNames = {
                            'all': 'å…¨éƒ¨é¡åˆ¥',
                            'pharmacy': 'è—¥å±€',
                            'hospital': 'å¤§é†«é™¢',
                            'internal': 'å…§ç§‘',
                            'pediatric': 'å°å…’ç§‘',
                            'dental': 'ç‰™ç§‘',
                            'eye': 'çœ¼ç§‘',
                            'ent': 'è€³é¼»å–‰ç§‘',
                            'obgyn': 'å©¦ç”¢ç§‘',
                            'ortho': 'éª¨ç§‘',
                            'derm': 'çš®è†šç§‘',
                            'emergency': 'æ€¥è¨º'
                        };
                        const categoryName = categoryNames[mapFilter] || mapFilter;
                        const rangeText = searchRadius >= 1000 ? (searchRadius/1000) + 'å…¬é‡Œ' : searchRadius + 'ç±³';
                        
                        list.innerHTML = `<div class="empty-state">
                            <h3>ğŸ“ é™„è¿‘æ²’æœ‰æ‰¾åˆ°è³‡æ–™</h3>
                            <p style="color: #999; margin: 12px 0;">ç•¶å‰æœå°‹ï¼š${categoryName} Â· ${rangeText}</p>
                            ${suggestionHtml}
                            <div style="display: flex; gap: 8px; justify-content: center; margin-top: 16px;">
                                ${searchRadius < 3000 ? '<button onclick="expandSearchRadius()" class="sync-btn" style="background: #ff9800;">ğŸ“ æ“´å¤§ç¯„åœ</button>' : ''}
                                <button onclick="fetchPlaces()" class="sync-btn">ğŸ”„ é‡æ–°æœå°‹</button>
                            </div>
                        </div>`;
                        return;
                    }

                    const items = elements.map(e => {
                        const p = e.tags || {};
                        const latlng = e.type === 'node' ? [e.lat, e.lon] : [e.center?.lat, e.center?.lon];
                        
                        return {
                            id: e.id,
                            name: p.name || 'æœªå‘½å',
                            address: p['addr:full'] || `${p['addr:city'] || ''}${p['addr:district'] || ''}${p['addr:street'] || ''}${p['addr:housenumber'] || ''}`,
                            phone: p.phone || p['contact:phone'] || '',
                            website: p.website || p['contact:website'] || '',
                            opening_hours: p.opening_hours || '',
                            lat: latlng[0],
                            lon: latlng[1],
                            type: mapFilter
                        };
                    }).filter(it => it.lat && it.lon);

                    allPlaces = items;
                    placesCache[cacheKey] = items;
                    
                    // é™åˆ¶ç¼“å­˜å¤§å°
                    const cacheKeys = Object.keys(placesCache);
                    if (cacheKeys.length > 20) {
                        delete placesCache[cacheKeys[0]];
                    }
                    
                    // è®°ä½æˆåŠŸçš„æœåŠ¡å™¨
                    currentServerIndex = serverIndex % overpassServers.length;
                    isRequesting = false;
                    
                    // è®°å½•æœç´¢ä½ç½®
                    lastSearchPosition = { lat, lon };
                    
                    // éšè—"æœç´¢æ­¤åŒºåŸŸ"æŒ‰é’®
                    hideSearchAreaButton();
                    
                    // æ¸…é™¤è¿›åº¦å®šæ—¶å™¨
                    if (progressInterval) {
                        clearInterval(progressInterval);
                        progressInterval = null;
                    }
                    
                    // æœ€åè¿›åº¦ï¼šå®Œæˆ
                    updateLoadingProgress('å®Œæˆï¼', 100);
                    
                    // åœæ­¢æ¸¸æˆï¼ˆå¦‚æœåœ¨ç©ï¼‰
                    if (gameActive) {
                        stopMiniGame(false);
                    }
                    
                    // çŸ­æš‚å»¶è¿Ÿåæ˜¾ç¤ºç»“æœï¼ˆè®©ç”¨æˆ·çœ‹åˆ°100%ï¼‰
                    setTimeout(() => {
                        renderPlaces(items);
                    }, 200);
                    
                } catch (error) {
                    clearTimeout(timeoutId);
                    
                    // æ£€æŸ¥è¿™ä¸ªè¯·æ±‚æ˜¯å¦è¿˜æ˜¯æœ€æ–°çš„
                    if (thisRequestId !== requestId) {
                        return;
                    }
                    
                    if (error.name === 'AbortError') {
                        return; // è¢«å–æ¶ˆçš„è¯·æ±‚ä¸é‡è¯•
                    }
                    
                    // æ˜¾ç¤ºé‡è¯•æç¤º
                    const nextServer = (serverIndex + 1) % overpassServers.length;
                    updateLoadingProgress(`æœå‹™å™¨ ${serverIndex + 1} å¤±æ•—ï¼Œåˆ‡æ›åˆ°æœå‹™å™¨ ${nextServer + 1}...`, 30 + (serverIndex * 15));
                    
                    // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæœåŠ¡å™¨é‡è¯•
                    setTimeout(() => {
                        fetchWithRetry(serverIndex + 1, retryCount + 1);
                    }, 500);
                }
            };

            // ä»ä¸Šæ¬¡æˆåŠŸçš„æœåŠ¡å™¨å¼€å§‹å°è¯•
            fetchWithRetry(currentServerIndex, 0);
        }

        function renderPlaces(items, resetCount = true) {
            clearMapMarkers();
            const list = document.getElementById('placeList');
            
            if (items.length === 0) {
                list.innerHTML = '<div class="empty-state"><h3>æ²’æœ‰æ‰¾åˆ°è³‡æ–™</h3></div>';
                return;
            }

            // é‡ç½®æ˜¾ç¤ºæ•°é‡
            if (resetCount) {
                displayedCount = INITIAL_DISPLAY_COUNT;
            }

            // è®¡ç®—è·ç¦»
            items.forEach(it => {
                if (userPosition && it.lat && it.lon) {
                    it.distance = distanceInMeters(userPosition.lat, userPosition.lon, it.lat, it.lon);
                }
            });

            // æ’åº
            const sortBy = document.getElementById('sortBy')?.value || 'distance';
            if (sortBy === 'distance') {
                items.sort((a, b) => (a.distance || Infinity) - (b.distance || Infinity));
            } else if (sortBy === 'name') {
                items.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));
            }

            // åªæ˜¾ç¤ºå‰displayedCountä¸ª
            const itemsToDisplay = items.slice(0, displayedCount);
            const hasMore = items.length > displayedCount;

            // åœ¨åœ°å›¾ä¸Šæ·»åŠ æ ‡è®° - åªæ˜¾ç¤ºå½“å‰æ˜¾ç¤ºçš„é¡¹ç›®
            requestAnimationFrame(() => {
                itemsToDisplay.forEach(it => {
                    if (it.lat && it.lon) {
                        const isFavorite = favoritePlaces.some(f => f.id === it.id);
                        const icon = L.divIcon({
                            html: `<div style="background: ${isFavorite ? '#ff4757' : '#4D9980'}; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                            iconSize: [24, 24],
                            className: ''
                        });
                        const marker = L.marker([it.lat, it.lon], { icon }).addTo(mapInstance);
                        const popupAddr = it.address || '';
                        marker.bindPopup(`<b>${escapeHtml(it.name)}</b><br>${escapeHtml(popupAddr)}`);
                        mapMarkers.push(marker);
                    }
                });
            });

            // æ˜¾ç¤ºç»“æœç»Ÿè®¡
            const statsHtml = `<div style="padding: 8px 20px; background: #f8f9fa; font-size: 13px; color: #666;">
                æ‰¾åˆ° ${items.length} å€‹é†«ç™‚æ©Ÿæ§‹ï¼ˆé¡¯ç¤ºå‰ ${itemsToDisplay.length} å€‹ï¼‰
            </div>`;

            // æ¸²æŸ“åˆ—è¡¨é¡¹
            const itemsHtml = itemsToDisplay.map(it => {
                const isFavorite = favoritePlaces.some(f => f.id === it.id);
                const dist = it.distance ? ` Â· ${formatDistance(it.distance)}` : '';
                const navUrl = it.lat && it.lon ? `https://www.google.com/maps/search/?api=1&query=${it.lat},${it.lon}` : '#';
                const tel = it.phone ? `tel:${it.phone.replace(/\s|-/g,'')}` : '';
                const openStatus = getOpenStatus(it.opening_hours);
                
                return `
                <div class="history-item" style="position: relative;">
                    <button onclick="toggleFavorite('${it.id}', event)" style="position: absolute; top: 12px; right: 12px; background: none; border: none; cursor: pointer; padding: 4px;">
                        <svg style="width: 20px; height: 20px; color: ${isFavorite ? '#ff4757' : '#ccc'};" fill="${isFavorite ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                    </button>
                    <div class="history-medicine">${escapeHtml(it.name)}${dist}</div>
                    ${openStatus ? `<div style="display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-bottom: 4px; ${openStatus.isOpen ? 'background: #d4edda; color: #155724;' : 'background: #f8d7da; color: #721c24;'}">${openStatus.text}</div>` : ''}
                    <div class="history-time" style="color:#333;">${escapeHtml(it.address || 'åœ°å€æœªæä¾›')}</div>
                    ${it.opening_hours ? `<div class="history-time">ç‡Ÿæ¥­æ™‚é–“ï¼š${escapeHtml(it.opening_hours)}</div>` : ''}
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <a href="${navUrl}" target="_blank" class="sync-btn" style="padding:8px 12px; width:auto;">å°èˆª</a>
                        ${it.phone ? `<a href="${tel}" class="sync-btn" style="background:#6c757d; padding:8px 12px; width:auto;">æ‰“é›»è©±</a>` : ''}
                        ${it.website ? `<a href="${it.website}" target="_blank" class="sync-btn" style="background:#17a2b8; padding:8px 12px; width:auto;">å®˜ç¶²</a>` : ''}
                    </div>
                </div>`;
            }).join('');

            // æ˜¾ç¤ºæ›´å¤šæŒ‰é’®
            const loadMoreBtn = hasMore ? `
                <div style="padding: 20px; text-align: center;">
                    <button onclick="loadMorePlaces()" class="sync-btn" style="width: auto; padding: 12px 24px; font-size: 15px;">
                        ğŸ“‹ é¡¯ç¤ºæ›´å¤š (é‚„æœ‰ ${items.length - displayedCount} å€‹)
                    </button>
                </div>
            ` : '';
            
            list.innerHTML = statsHtml + itemsHtml + loadMoreBtn;
        }

        // åŠ è½½æ›´å¤š
        function loadMorePlaces() {
            displayedCount += LOAD_MORE_COUNT;
            renderPlaces(allPlaces, false); // falseè¡¨ç¤ºä¸é‡ç½®è®¡æ•°
        }

        function distanceInMeters(lat1, lon1, lat2, lon2) {
            const R = 6371000; // m
            const toRad = (d) => d * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function formatDistance(m) {
            if (m < 1000) return `${Math.round(m)}m`;
            return `${(m/1000).toFixed(1)}km`;
        }

        // æœç´¢åŠŸèƒ½
        function searchPlaces() {
            const searchTerm = document.getElementById('mapSearchInput').value.trim().toLowerCase();
            if (!searchTerm) {
                renderPlaces(allPlaces);
                return;
            }
            const filtered = allPlaces.filter(p => 
                p.name.toLowerCase().includes(searchTerm) || 
                p.address.toLowerCase().includes(searchTerm)
            );
            renderPlaces(filtered);
        }

        // æŒ‰Enteré”®æœç´¢
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('mapSearchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') searchPlaces();
                });
            }

            // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
            const networkStatus = document.getElementById('networkStatus');
            
            window.addEventListener('online', () => {
                if (networkStatus) {
                    networkStatus.style.display = 'none';
                }
            });
            
            window.addEventListener('offline', () => {
                if (networkStatus) {
                    networkStatus.innerHTML = 'âŒ ç¶²è·¯å·²æ–·é–‹ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥';
                    networkStatus.style.background = '#f8d7da';
                    networkStatus.style.color = '#721c24';
                    networkStatus.style.display = 'block';
                }
            });

            // æ£€æµ‹ç½‘ç»œé€Ÿåº¦ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
            if (navigator.connection) {
                const updateNetworkStatus = () => {
                    const connection = navigator.connection;
                    const effectiveType = connection.effectiveType;
                    
                    if (networkStatus && (effectiveType === 'slow-2g' || effectiveType === '2g')) {
                        networkStatus.innerHTML = 'ğŸ“¶ ç¶²è·¯é€£æ¥è¼ƒæ…¢ï¼Œå¯èƒ½éœ€è¦æ›´é•·æ™‚é–“';
                        networkStatus.style.background = '#fff3cd';
                        networkStatus.style.color = '#856404';
                        networkStatus.style.display = 'block';
                    } else if (networkStatus) {
                        networkStatus.style.display = 'none';
                    }
                };
                
                navigator.connection.addEventListener('change', updateNetworkStatus);
                updateNetworkStatus();
            }
        });

        // æ”¶è—åŠŸèƒ½
        function toggleFavorite(placeId, event) {
            event.preventDefault();
            event.stopPropagation();
            
            const place = allPlaces.find(p => p.id == placeId);
            if (!place) return;

            const index = favoritePlaces.findIndex(f => f.id == placeId);
            if (index > -1) {
                favoritePlaces.splice(index, 1);
            } else {
                favoritePlaces.push(place);
            }
            
            localStorage.setItem('favoritePlaces', JSON.stringify(favoritePlaces));
            renderPlaces(showingFavorites ? favoritePlaces : allPlaces);
        }

        // æ˜¾ç¤º/éšè—æ”¶è—
        function toggleFavorites() {
            showingFavorites = !showingFavorites;
            const icon = document.getElementById('favIcon');
            
            if (showingFavorites) {
                icon.setAttribute('fill', 'currentColor');
                icon.style.color = '#ff4757';
                renderPlaces(favoritePlaces);
            } else {
                icon.setAttribute('fill', 'none');
                icon.style.color = '#666';
                renderPlaces(allPlaces);
            }
        }

        // æ›´æ–°æœç´¢èŒƒå›´
        function updateSearchRadius() {
            searchRadius = parseInt(document.getElementById('searchRadius').value);
            
            // ç«‹å³å–æ¶ˆå½“å‰è¯·æ±‚
            cancelCurrentRequest();
            
            const center = mapInstance.getCenter();
            
            // éšè—æç¤º
            const hintEl = document.getElementById('mapHint');
            if (hintEl && searchRadius <= 1000) {
                hintEl.style.display = 'none';
            }
            
            // ç”¨æˆ·ä¸»åŠ¨æ“ä½œï¼Œç«‹å³æ‰§è¡Œ
            fetchPlaces(center.lat, center.lng);
        }

        // æ‰©å¤§æœç´¢èŒƒå›´ï¼ˆæ™ºèƒ½å»ºè®®ï¼‰
        function expandSearchRadius() {
            const radiusSelect = document.getElementById('searchRadius');
            
            // æ ¹æ®å½“å‰èŒƒå›´æ™ºèƒ½æ‰©å¤§
            if (searchRadius < 1000) {
                searchRadius = 1000;
                radiusSelect.value = '1000';
            } else if (searchRadius < 2000) {
                searchRadius = 2000;
                radiusSelect.value = '2000';
            } else {
                searchRadius = 3000;
                radiusSelect.value = '3000';
            }
            
            // ç«‹å³æœç´¢
            cancelCurrentRequest();
            const center = mapInstance.getCenter();
            fetchPlaces(center.lat, center.lng);
        }

        // å¿«é€Ÿä¿®å¤ï¼šè‡ªåŠ¨ä¼˜åŒ–è®¾å®š
        function quickFix() {
            // ç«‹å³å–æ¶ˆå½“å‰è¯·æ±‚
            cancelCurrentRequest();
            
            // è®¾ç½®ä¸ºæœ€å¿«çš„é…ç½®
            searchRadius = 500;
            document.getElementById('searchRadius').value = '500';
            
            // å¦‚æœæ˜¯"å…¨éƒ¨"ï¼Œåˆ‡æ¢åˆ°"è—¥å±€"ï¼ˆæœ€å¿«ï¼‰
            if (mapFilter === 'all') {
                mapFilter = 'pharmacy';
                document.querySelectorAll('#mapView .type-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.filter === 'pharmacy');
                });
            }
            
            // éšè—æç¤º
            const hintEl = document.getElementById('mapHint');
            if (hintEl) {
                hintEl.style.display = 'none';
            }
            
            // é‡æ–°æœç´¢
            const center = mapInstance.getCenter();
            fetchPlaces(center.lat, center.lng);
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const list = document.getElementById('placeList');
            list.innerHTML = '<div class="loading"><div class="spinner"></div><span>âœ¨ å·²å„ªåŒ–è¨­å®šï¼Œé‡æ–°æœå°‹ä¸­...</span></div>';
        }

        // æ’åº
        function sortPlaces() {
            renderPlaces(showingFavorites ? favoritePlaces : allPlaces);
        }

        // åˆ¤æ–­è¥ä¸šçŠ¶æ€
        function getOpenStatus(opening_hours) {
            if (!opening_hours) return null;
            
            try {
                const now = new Date();
                const day = now.getDay(); // 0=Sunday, 1=Monday, etc.
                const time = now.getHours() * 100 + now.getMinutes();
                
                // ç®€å•è§£æ opening_hours (å¦‚ "Mo-Fr 08:00-18:00")
                // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…çš„ opening_hours æ ¼å¼å¯èƒ½å¾ˆå¤æ‚
                
                // 24/7 å…¨å¤©å€™è¥ä¸š
                if (opening_hours.includes('24/7')) {
                    return { isOpen: true, text: 'ç‡Ÿæ¥­ä¸­' };
                }
                
                // å°è¯•åŒ¹é…å¸¸è§æ ¼å¼
                const patterns = [
                    /(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/g,  // 08:00-18:00
                ];
                
                let hasMatch = false;
                for (const pattern of patterns) {
                    const matches = [...opening_hours.matchAll(pattern)];
                    if (matches.length > 0) {
                        hasMatch = true;
                        for (const match of matches) {
                            const openTime = parseInt(match[1]) * 100 + parseInt(match[2]);
                            const closeTime = parseInt(match[3]) * 100 + parseInt(match[4]);
                            
                            if (time >= openTime && time <= closeTime) {
                                return { isOpen: true, text: 'ç‡Ÿæ¥­ä¸­' };
                            }
                        }
                    }
                }
                
                if (hasMatch) {
                    return { isOpen: false, text: 'å·²é—œé–‰' };
                }
                
                return null;
            } catch (e) {
                return null;
            }
        }

        function escapeHtml(str) {
            return String(str || '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
        }

        // åˆå§‹åŒ–æ‡‰ç”¨
        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- PWA / Fullscreen on mobile -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4D9980">
    <link rel="manifest" href="manifest.webmanifest">
    <title>藥嚀管</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(to bottom, #D9F2E0, #F2FAF4, #FFFFFF);
            min-height: 100dvh; /* 使用動態視窗高度避免被瀏覽器工具列壓縮 */
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
        }

        /* 頂部分類和功能區 */
        .header {
            padding: 16px 24px;
            background: transparent;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .category-buttons {
            display: flex;
            gap: 0;
        }

        .category-btn {
            padding: 12px 24px;
            border: none;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            background: #E5E5E5;
            color: #000;
            position: relative;
        }

        .category-btn:first-child {
            border-radius: 20px 0 0 20px;
        }

        .category-btn:last-child {
            border-radius: 0 20px 20px 0;
        }

        .category-btn:only-child {
            border-radius: 20px;
        }

        .category-btn.active {
            background: #4D9980;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.1);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .icon-btn:hover {
            background: #f5f5f5;
        }

        /* 下拉選單（排序） */
        .dropdown-menu {
            position: absolute;
            right: 0;
            top: 44px;
            background: white;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 10px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
            padding: 6px;
            display: none;
            z-index: 20;
            min-width: 160px;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-menu button {
            width: 100%;
            text-align: left;
            padding: 10px 12px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        .dropdown-menu button:hover { background: #f4f6f8; }
        .dropdown-menu hr { border: 0; height: 1px; background: #eee; margin: 6px 0; }

        /* 搜尋列 */
        .search-bar {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.95);
            padding: 12px 16px;
            border-radius: 12px;
            gap: 12px;
            margin-top: 20px;
        }

        .search-bar input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
            background: transparent;
        }

        .search-bar svg {
            width: 18px;
            height: 18px;
            color: #666;
        }

        /* 藥品列表 */
        .medicine-list {
            padding: 0 20px;
            margin-top: 24px;
        }

        .medicine-card {
            background: #F5F6F7;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s;
        }

        .medicine-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .medicine-image {
            width: 64px;
            height: 64px;
            border-radius: 10px;
            background: #D5D5D5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: #666;
            flex-shrink: 0;
        }

        .medicine-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        .medicine-info {
            flex: 1;
        }

        .medicine-name {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #000;
        }

        .medicine-dosage {
            font-size: 16px;
            color: #666;
        }

        .time-slots {
            display: flex;
            gap: 16px;
        }

        .time-slot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(128,128,128,0.2);
            color: #666;
            font-size: 20px;
        }

        .time-slot.taken {
            background: #4D9980;
            color: white;
            border-color: #4D9980;
        }

        /* 底部功能按鈕 */
        .bottom-actions {
            position: fixed;
            bottom: 80px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 32px;
            padding: 20px;
        }

        .fab {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #4D9980;
            color: white;
            border: none;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            transition: all 0.3s;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        /* 匯出按鈕區域 */
        .export-section {
            padding: 12px 20px;
            background: rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .export-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px 16px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
            background: linear-gradient(135deg, #218838 0%, #1aa179 100%);
        }

        .export-btn:active {
            transform: translateY(0);
        }

        .export-btn span:first-child {
            font-size: 20px;
        }

        /* 底部導航 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: calc(12px + env(safe-area-inset-bottom)/2) 0 env(safe-area-inset-bottom) 0; /* 讓內容不被 Safari 工具列蓋住 */
            border-top: 1px solid #E5E5E5;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            color: #666;
            transition: all 0.3s;
            padding: 8px 16px;
            border: none;
            background: transparent;
            font-size: 12px;
        }

        .nav-item.active {
            color: #4D9980;
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
        }

        /* 模態窗口 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 600px;
            border-radius: 20px 20px 0 0;
            padding: 24px;
            padding-top: 0; /* 將頂部間距交由 sticky header 處理，避免滾動時露出背景 */
            /* 不得高於螢幕高度（多重單位做相容性回退） */
            max-height: 88vh; /* 一般瀏覽器回退 */
            max-height: calc(100svh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 20px); /* 小視窗單位 */
            max-height: calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 20px); /* 動態視窗單位 */
            padding-top: calc(24px + env(safe-area-inset-top));
            padding-bottom: calc(24px + env(safe-area-inset-bottom));
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overscroll-behavior: contain; /* 防止滾到頂/底時帶動背景頁 */
            -webkit-overflow-scrolling: touch; /* 行動裝置滾動更順，避免卡在頂部 */
            animation: slideUp 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 2;
            /* 讓 header 與彈窗上緣完全貼齊且填滿背景，不留縫隙 */
            margin: 0 -24px 16px -24px;
            padding: calc(24px + env(safe-area-inset-top)) 24px 8px 24px;
            background: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 1px 0 rgba(0,0,0,0.06) inset;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #f5f5f5;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            min-width: 0; /* 防止在 flex 容器中溢出 */
            max-width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px; /* 避免 iOS 自動放大 */
            outline: none;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        input[type="datetime-local"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            max-width: 100%;
            font-size: 16px; /* iOS 不自動縮放 */
        }

        /* 詳情內圖片在小螢幕不溢出 */
        #medicineDetailContent img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        /* 小螢幕血壓與單值區塊允許換行，避免橫向溢出 */
        #bloodPressureInputs > div,
        #singleValueInput > div,
        #editValueInputs > div {
            flex-wrap: wrap;
        }

        .form-input:focus {
            border-color: #4D9980;
        }

        .time-slot-selector {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .time-slot-option {
            flex: 1;
            min-width: 80px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .time-slot-option.selected {
            background: #4D9980;
            color: white;
            border-color: #4D9980;
        }

        .btn-primary {
            width: 100%;
            padding: 16px;
            background: #4D9980;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: #3D7A65;
        }

        .btn-danger {
            width: 100%;
            padding: 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 12px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* 空狀態 */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            color: rgba(77, 153, 128, 0.7);
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        /* 歷史記錄 */
        .history-item {
            padding: 16px;
            background: #F5F6F7;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .history-date {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .history-medicine {
            font-size: 16px;
            font-weight: 500;
            color: #000;
        }

        .history-time {
            font-size: 14px;
            color: #4D9980;
            margin-top: 4px;
        }

        /* 個人資料 */
        .profile-section {
            padding: 20px;
        }

        .profile-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-label {
            color: #666;
        }

        .profile-value {
            font-weight: 500;
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 12px;
            background: #f5f5f5;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: #e5e5e5;
            border-color: #4D9980;
        }

        .view-container {
            display: none;
        }

        .view-container.active {
            display: block;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* 健康記錄相關樣式 */
        .health-type-selector {
            background: rgba(255,255,255,0.05);
            padding: 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .type-buttons {
            display: flex;
            gap: 10px;
            padding: 0 20px;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .type-buttons::-webkit-scrollbar {
            display: none;
        }

        .type-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: rgba(128,128,128,0.1);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 70px;
            flex-shrink: 0;
        }

        .type-btn.active {
            background: #4D9980;
            color: white;
        }

        .type-icon {
            font-size: 24px;
        }

        .type-name {
            font-size: 12px;
            font-weight: 500;
        }

        .health-content {
            flex: 1;
            overflow-y: auto;
        }

        .sync-section {
            padding: 16px 20px;
            background: rgba(77, 153, 128, 0.05);
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .sync-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: #4D9980;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            width: 100%;
        }

        .sync-btn:hover {
            background: #3D7A65;
        }

        .sync-icon {
            font-size: 16px;
        }

        .health-records-list {
            padding: 20px;
        }

        .health-record-item {
            background: #F5F6F7;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .health-record-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .health-record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .health-record-type {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #333;
        }

        .health-record-time {
            font-size: 14px;
            color: #666;
        }

        .health-record-value {
            font-size: 18px;
            font-weight: 600;
            color: #4D9980;
            margin-bottom: 8px;
        }

        .health-record-note {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        .chart-container {
            padding: 20px;
            background: white;
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        #healthChart {
            height: 300px !important;
        }

        .export-types {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 10px;
        }

        .export-types .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f5f5f5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .export-types .checkbox-group:hover {
            background: #e5e5e5;
        }

        .export-types .checkbox-group input[type="checkbox"]:checked + span {
            color: #4D9980;
            font-weight: 500;
        }

        /* 日期分組標題 */
        .date-group {
            margin-bottom: 20px;
        }

        .date-group-title {
            font-size: 16px;
            font-weight: 600;
            color: #4D9980;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 2px solid #4D9980;
        }

        /* Toast 提示 */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s;
            max-width: 90%;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.success {
            background: #4D9980;
        }

        .toast.error {
            background: #dc3545;
        }

        /* 手機優化 */
        /* 載入中動畫 */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            color: #4D9980;
            gap: 10px;
        }
        .loading .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(77,153,128,0.3);
            border-top-color: #4D9980;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            .btn-primary {
                padding: 20px;
                font-size: 20px;
            }
            
            .form-input {
                padding: 16px;
                font-size: 18px;
            }
            
            .modal-content {
                padding: 16px;
                padding-top: 0; /* 交由 sticky header 補足頂部安全距離 */
                padding-bottom: calc(16px + env(safe-area-inset-bottom));
                max-height: calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 10px);
            }
            .modal-header {
                margin: 0 -16px 12px -16px;
                padding: calc(16px + env(safe-area-inset-top)) 16px 8px 16px;
            }
            
            .modal-title {
                font-size: 20px;
            }
            
            .time-slot-option {
                padding: 16px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- 我的藥品頁面 -->
    <div id="medicinesView" class="view-container active">
        <div class="header">
            <div class="top-bar">
                <div class="category-buttons">
                    <button class="category-btn active" onclick="changeCategory('處方藥')">處方藥</button>
                    <button class="category-btn" onclick="changeCategory('保健品')">保健品</button>
                </div>
                <div class="action-buttons" style="position: relative;">
                    <button class="icon-btn" onclick="toggleSortMenu(event)" title="排序">
                        ⇅
                    </button>
                    <div id="sortMenu" class="dropdown-menu">
                        <button onclick="setMedicineSort('created_desc')">新增時間 新→舊</button>
                        <button onclick="setMedicineSort('created_asc')">新增時間 舊→新</button>
                        <hr>
                        <button onclick="setMedicineSort('stock_desc')">庫存 高→低</button>
                        <button onclick="setMedicineSort('stock_asc')">庫存 低→高</button>
                    </div>
                    <button class="icon-btn" onclick="showHistory()">
                        🕒
                    </button>
                </div>
            </div>

            <div class="search-bar">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <input type="text" id="searchInput" placeholder="搜尋藥品" oninput="searchMedicines()">
                <button class="icon-btn" onclick="document.getElementById('searchInput').value=''; searchMedicines();" style="border: none; background: transparent;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="medicine-list" id="medicineList"></div>

        <div class="bottom-actions">
            <button class="fab" onclick="showAddMedicine()" title="添加藥品">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 26px; height: 26px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- 健康紀錄頁面 -->
    <div id="healthView" class="view-container">
        <div class="header">
            <h2 class="modal-title">健康紀錄</h2>
        </div>
        
        <!-- 匯出按鈕區域 -->
        <div class="export-section">
            <button class="export-btn" onclick="showExportOptions()">
                <span>📤</span>
                <span>匯出記錄</span>
            </button>
        </div>
        
        <!-- 健康指標類型選擇器 -->
        <div class="health-type-selector">
            <div class="type-buttons">
                <button class="type-btn active" data-type="bloodPressure" onclick="changeHealthType('bloodPressure')">
                    <span class="type-icon">❤️</span>
                    <span class="type-name">血壓</span>
                </button>
                <button class="type-btn" data-type="bloodSugar" onclick="changeHealthType('bloodSugar')">
                    <span class="type-icon">🩸</span>
                    <span class="type-name">血糖</span>
                </button>
                <button class="type-btn" data-type="heartRate" onclick="changeHealthType('heartRate')">
                    <span class="type-icon">💓</span>
                    <span class="type-name">心率</span>
                </button>
                <button class="type-btn" data-type="bloodOxygen" onclick="changeHealthType('bloodOxygen')">
                    <span class="type-icon">🫁</span>
                    <span class="type-name">血氧</span>
                </button>
                <button class="type-btn" data-type="weight" onclick="changeHealthType('weight')">
                    <span class="type-icon">⚖️</span>
                    <span class="type-name">體重</span>
                </button>
                <button class="type-btn" data-type="medication" onclick="changeHealthType('medication')">
                    <span class="type-icon">💊</span>
                    <span class="type-name">用藥紀錄</span>
                </button>
            </div>
        </div>

        <div class="health-content">
            <!-- 同步按鈕（僅在用藥記錄顯示） -->
            <div id="syncButton" class="sync-section" style="display: none;">
                <button class="sync-btn" onclick="syncMedicationRecords()">
                    <span class="sync-icon">🔄</span>
                    <span>同步藥品服用記錄</span>
                </button>
            </div>

            <!-- 健康記錄列表 -->
            <div class="health-records-list" id="healthRecordsList">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h3 id="emptyStateTitle">暫無血壓記錄</h3>
                    <p>點擊右下方 + 按鈕添加新記錄</p>
                </div>
            </div>
        </div>

        <!-- 圖表區域 -->
        <div class="chart-container" id="chartContainer" style="display: none;">
            <canvas id="healthChart"></canvas>
        </div>

        <!-- 底部添加按鈕 -->
        <div class="bottom-actions">
            <button class="fab" onclick="showAddHealthRecord()" title="添加健康記錄">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 26px; height: 26px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </button>
        </div>

    </div>

    <!-- 附近醫療地圖頁面 -->
    <div id="mapView" class="view-container">
        <div class="header">
            <h2 class="modal-title">附近醫療</h2>
        </div>
        
        <!-- 网络状态指示器 -->
        <div id="networkStatus" style="display: none; padding: 8px 20px; background: #fff3cd; color: #856404; font-size: 13px; text-align: center;">
            📶 網路連接較慢，請耐心等待...
        </div>

        <!-- 搜索栏 -->
        <div style="padding: 12px 20px;">
            <div style="position: relative;">
                <input type="text" id="mapSearchInput" placeholder="搜尋醫療機構名稱..." style="width: 100%; padding: 10px 40px 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px;">
                <svg onclick="searchPlaces()" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; cursor: pointer; color: #666;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
        </div>

        <!-- 类别筛选 -->
        <div style="padding: 0 20px 12px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
            <button class="type-btn active" data-filter="all" onclick="setMapFilter('all')"><span class="type-name">全部</span></button>
            <button class="type-btn" data-filter="pharmacy" onclick="setMapFilter('pharmacy')"><span class="type-name">藥局</span></button>
            <button class="type-btn" data-filter="hospital" onclick="setMapFilter('hospital')"><span class="type-name">大醫院</span></button>
            <button class="type-btn" data-filter="internal" onclick="setMapFilter('internal')"><span class="type-name">內科</span></button>
            <button class="type-btn" data-filter="pediatric" onclick="setMapFilter('pediatric')"><span class="type-name">小兒科</span></button>
            <button class="type-btn" data-filter="dental" onclick="setMapFilter('dental')"><span class="type-name">牙科</span></button>
            <button class="type-btn" data-filter="eye" onclick="setMapFilter('eye')"><span class="type-name">眼科</span></button>
            <button class="type-btn" data-filter="ent" onclick="setMapFilter('ent')"><span class="type-name">耳鼻喉科</span></button>
            <button class="type-btn" data-filter="obgyn" onclick="setMapFilter('obgyn')"><span class="type-name">婦產科</span></button>
            <button class="type-btn" data-filter="ortho" onclick="setMapFilter('ortho')"><span class="type-name">骨科</span></button>
            <button class="type-btn" data-filter="derm" onclick="setMapFilter('derm')"><span class="type-name">皮膚科</span></button>
            <button class="type-btn" data-filter="emergency" onclick="setMapFilter('emergency')"><span class="type-name">急診</span></button>
        </div>

        <!-- 工具栏：范围和排序 -->
        <div style="padding: 0 20px 12px; display: flex; gap: 8px; align-items: center;">
            <select id="searchRadius" onchange="updateSearchRadius()" style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                <option value="500">500米內</option>
                <option value="1000" selected>1公里內</option>
                <option value="2000">2公里內</option>
                <option value="3000">3公里內</option>
            </select>
            <select id="sortBy" onchange="sortPlaces()" style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                <option value="distance">距離排序</option>
                <option value="name">名稱排序</option>
            </select>
            <button onclick="toggleFavorites()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">
                <svg id="favIcon" style="width: 20px; height: 20px; color: #666;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
            </button>
        </div>
        
        <!-- 提示信息 -->
        <div id="mapHint" style="display: none; padding: 8px 20px; background: #e3f2fd; color: #1565c0; font-size: 12px; border-left: 3px solid #1976d2; margin: 0 20px 12px;">
            💡 提示：如果加載很慢，試試選擇更小的搜尋範圍（500米或1公里）
        </div>

        <!-- 地图容器 - 添加边距和边框 -->
        <div style="padding: 0 12px; margin-bottom: 12px; position: relative;">
            <div id="map" style="height: calc(100dvh - 410px); min-height: 250px; border: 2px solid #e0e0e0; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
            
            <!-- 小游戏浮层 - 独立于列表，固定在地图上方 -->
            <div id="miniGameOverlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.98); z-index: 2000; border-radius: 12px; padding: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
                <!-- 关闭按钮 -->
                <button onclick="closeGameOverlay()" style="position: absolute; top: 8px; right: 8px; background: #e0e0e0; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#ccc'" onmouseout="this.style.background='#e0e0e0'" title="關閉遊戲">
                    ✖️
                </button>
                <div style="text-align: center;">
                    <div style="font-size: 13px; color: #4D9980; font-weight: 500; margin-bottom: 8px;">
                        🎮 等待太久了？來玩個小遊戲吧！
                    </div>
                    <div style="font-size: 11px; color: #999; margin-bottom: 12px;">
                        📱 手機：點擊遊戲區域 | 💻 電腦：點擊或按空格
                    </div>
                    <canvas id="gameCanvas" width="280" height="180" 
                            style="border: 2px solid #e0e0e0; border-radius: 8px; background: #fff; cursor: pointer; display: block; margin: 0 auto; box-shadow: 0 2px 6px rgba(0,0,0,0.1); max-width: 100%;"></canvas>
                    <div style="margin-top: 8px; font-size: 16px; font-weight: 600; color: #4D9980;">
                        分數：<span id="gameScore">0</span>
                    </div>
                </div>
            </div>
            
            <!-- 搜索此区域按钮 -->
            <div id="searchAreaBtn" style="display: none; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000;">
                <button onclick="searchCurrentArea()" 
                        style="background: linear-gradient(135deg, #4D9980 0%, #5daa94 100%); 
                               color: white; 
                               border: none; 
                               padding: 10px 20px; 
                               border-radius: 8px; 
                               font-size: 14px; 
                               font-weight: 500;
                               cursor: pointer; 
                               box-shadow: 0 3px 10px rgba(77, 153, 128, 0.4);
                               transition: all 0.3s ease;
                               display: inline-flex;
                               align-items: center;
                               gap: 6px;"
                        onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(77, 153, 128, 0.5)';"
                        onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 3px 10px rgba(77, 153, 128, 0.4)';">
                    <span style="font-size: 16px;">🔍</span> 搜尋此區域
                </button>
            </div>
            
            <!-- 回到我的位置按钮 - 在地图缩放控制按钮下方 -->
            <button id="myLocationBtn" onclick="goToMyLocation()" style="position: absolute; top: 92px; right: 24px; z-index: 1000; background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px; width: 34px; height: 34px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.2s;" title="回到我的位置" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
                📍
            </button>
        </div>
        
        <div id="placeList" class="health-records-list" style="padding-top: 12px;"></div>
    </div>

    <!-- 個人資料頁面 -->
    <div id="profileView" class="view-container">
        <div class="header">
            <h2 class="modal-title">個人資料</h2>
        </div>
        <div class="profile-section">
            <div class="profile-item">
                <span class="profile-label">姓名</span>
                <input type="text" id="userName" class="form-input" style="width: auto; border: none; background: transparent; text-align: right;" placeholder="請輸入姓名" onchange="saveProfile()" oninput="saveProfile()" autocomplete="name">
            </div>
            <div class="profile-item">
                <span class="profile-label">年齡</span>
                <input type="number" id="userAge" class="form-input" style="width: auto; border: none; background: transparent; text-align: right;" placeholder="20" onchange="saveProfile()" oninput="saveProfile()" inputmode="numeric">
            </div>
            <div class="profile-item">
                <span class="profile-label">性別</span>
                <select id="userGender" class="form-input" style="width: auto; border: none; background: transparent; text-align: right;" onchange="saveProfile()" >
                    <option value="男性">男性</option>
                    <option value="女性">女性</option>
                    <option value="其他">其他</option>
                </select>
            </div>
            <div class="profile-item">
                <span class="profile-label">身高 (cm)</span>
                <input type="number" id="userHeight" class="form-input" style="width: auto; border: none; background: transparent; text-align: right;" placeholder="170" onchange="saveProfile()" oninput="saveProfile()" inputmode="numeric">
            </div>
            <div class="profile-item">
                <span class="profile-label">體重 (kg)</span>
                <input type="number" id="userWeight" class="form-input" style="width: auto; border: none; background: transparent; text-align: right;" placeholder="60" onchange="saveProfile()" oninput="saveProfile()" inputmode="numeric">
            </div>
            <div class="profile-item">
                <span class="profile-label">疾病</span>
                <input type="text" id="userDisease" class="form-input" style="width: auto; border: none; background: transparent; text-align: right;" placeholder="例如：高血壓、糖尿病" onchange="saveProfile()" oninput="saveProfile()">
            </div>
        </div>
    </div>

    <!-- 底部導航 -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchView('medicines')">
            <svg fill="currentColor" viewBox="0 0 24 24">
                <path d="M4.22 11.29l-1.94 1.94a3 3 0 000 4.24l4.25 4.25a3 3 0 004.24 0l9.19-9.19a3 3 0 000-4.24L15.71 4.04a3 3 0 00-4.24 0l-1.94 1.94 4.24 4.25a1 1 0 010 1.41l-2.12 2.12a1 1 0 01-1.41 0L5.99 9.52l-1.77 1.77z"/>
            </svg>
            <span>我的藥品</span>
        </button>
        <button class="nav-item" onclick="switchView('health')">
            <svg fill="currentColor" viewBox="0 0 24 24">
                <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
            </svg>
            <span>健康紀錄</span>
        </button>
        <button class="nav-item" onclick="switchView('map')">
            <svg fill="currentColor" viewBox="0 0 24 24">
                <path d="M9 20l-5 2V6l5-2 6 2 6-2v16l-6 2-6-2zm6-14l-6-2v14l6 2V6z"/>
            </svg>
            <span>附近醫療</span>
        </button>
        <button class="nav-item" onclick="switchView('profile')">
            <svg fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            <span>個人資料</span>
        </button>
    </div>

    <!-- 添加/編輯藥品模態窗口 -->
    <div id="addMedicineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">添加藥品</h3>
                <button class="close-btn" onclick="closeModal('addMedicineModal')">×</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">藥品名稱</label>
                <input type="text" id="medicineName" class="form-input" placeholder="請輸入藥品名稱">
            </div>

            <div class="form-group">
                <label class="form-label">類別</label>
                <select id="medicineCategory" class="form-input">
                    <option value="處方藥">處方藥</option>
                    <option value="保健品">保健品</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">每次用量</label>
                <input type="text" id="medicineDosage" class="form-input" placeholder="例如：1顆、2ml">
            </div>

            <div class="form-group">
                <label class="form-label">總庫存</label>
                <input type="number" id="medicineStock" class="form-input" placeholder="總量">
            </div>

            <div class="form-group">
                <label class="form-label">服用時段</label>
                <div class="time-slot-selector">
                    <div class="time-slot-option" data-slot="morning" onclick="toggleTimeSlot(this)">
                        早上
                    </div>
                    <div class="time-slot-option" data-slot="noon" onclick="toggleTimeSlot(this)">
                        中午
                    </div>
                    <div class="time-slot-option" data-slot="evening" onclick="toggleTimeSlot(this)">
                        晚上
                    </div>
                    <div class="time-slot-option" data-slot="bedtime" onclick="toggleTimeSlot(this)">
                        睡前
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">藥品圖片</label>
                <div class="file-input-wrapper">
                    <input type="file" id="medicineImage" accept="image/*" onchange="previewImage(this)">
                    <label for="medicineImage" class="file-input-label">
                        📷 點擊上傳圖片
                    </label>
                </div>
                <img id="imagePreview" class="image-preview" style="display: none;">
            </div>

            <div class="form-group">
                <label class="form-label">備註</label>
                <textarea id="medicineNotes" class="form-input" rows="3" placeholder="其他備註資訊"></textarea>
            </div>

            <button class="btn-primary" onclick="saveMedicine()">保存</button>
            <button class="btn-danger" id="deleteMedicineBtn" style="display: none;" onclick="deleteMedicine()">刪除藥品</button>
        </div>
    </div>

    <!-- 歷史記錄模態窗口 -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">服藥歷史</h3>
                <button class="close-btn" onclick="closeModal('historyModal')">×</button>
            </div>
            <div id="historyList"></div>
        </div>
    </div>

    <!-- 藥品詳情模態窗口 -->
    <div id="medicineDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="detailMedicineName"></h3>
                <button class="close-btn" onclick="closeModal('medicineDetailModal')">×</button>
            </div>
            <div id="medicineDetailContent"></div>
            <button class="btn-primary" onclick="editCurrentMedicine()">編輯</button>
        </div>
    </div>

    <!-- 添加健康記錄模態窗口 -->
    <div id="addHealthRecordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">添加健康記錄</h3>
                <button class="close-btn" onclick="closeModal('addHealthRecordModal')">×</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">記錄類型</label>
                <select id="healthRecordType" class="form-input" onchange="updateHealthRecordForm()">
                    <option value="bloodPressure">血壓</option>
                    <option value="bloodSugar">血糖</option>
                    <option value="heartRate">心率</option>
                    <option value="bloodOxygen">血氧</option>
                    <option value="weight">體重</option>
                    <option value="medication">用藥記錄</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">日期與時間</label>
                <input type="datetime-local" id="healthRecordDate" class="form-input">
            </div>

            <!-- 血壓專用輸入 -->
            <div id="bloodPressureInputs" class="form-group">
                <label class="form-label">血壓數值</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" id="systolicPressure" class="form-input" placeholder="收縮壓" style="flex: 1;">
                    <span>/</span>
                    <input type="number" id="diastolicPressure" class="form-input" placeholder="舒張壓" style="flex: 1;">
                    <span>mmHg</span>
                </div>
            </div>

            <!-- 其他數值輸入 -->
            <div id="singleValueInput" class="form-group">
                <label class="form-label">測量值</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" id="healthRecordValue" class="form-input" placeholder="數值" step="0.1">
                    <span id="healthRecordUnit">mmHg</span>
                </div>
            </div>

            <!-- 用藥記錄專用輸入 -->
            <div id="medicationInputs" class="form-group" style="display: none;">
                <label class="form-label">藥品名稱</label>
                <input type="text" id="healthMedicationName" class="form-input" placeholder="請輸入藥品名稱">
                
                <label class="form-label" style="margin-top: 15px;">劑量</label>
                <input type="text" id="healthMedicationDosage" class="form-input" placeholder="例如：一天兩次 5mg">
            </div>

            <div class="form-group">
                <label class="form-label">備註</label>
                <textarea id="healthRecordNote" class="form-input" rows="3" placeholder="其他備註資訊"></textarea>
            </div>

            <button class="btn-primary" onclick="saveHealthRecord()">保存</button>
        </div>
    </div>

    <!-- 編輯健康記錄模態窗口 -->
    <div id="editHealthRecordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">編輯健康記錄</h3>
                <button class="close-btn" onclick="closeModal('editHealthRecordModal')">×</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">記錄類型</label>
                <input type="text" id="editRecordType" class="form-input" readonly>
            </div>

            <div class="form-group">
                <label class="form-label">日期與時間</label>
                <input type="datetime-local" id="editRecordDate" class="form-input">
            </div>

            <div id="editValueInputs" class="form-group"></div>

            <div class="form-group">
                <label class="form-label">備註</label>
                <textarea id="editRecordNote" class="form-input" rows="3"></textarea>
            </div>

            <button class="btn-primary" onclick="updateHealthRecord()">保存修改</button>
            <button class="btn-danger" onclick="deleteHealthRecord()">刪除記錄</button>
        </div>
    </div>

    <!-- 匯出選項模態窗口 -->
    <div id="exportOptionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">匯出健康記錄</h3>
                <button class="close-btn" onclick="closeModal('exportOptionsModal')">×</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">選擇要匯出的記錄類型</label>
                <div class="export-types">
                    <label class="checkbox-group">
                        <input type="checkbox" id="export-bloodPressure" value="bloodPressure" checked>
                        <span>血壓</span>
                    </label>
                    <label class="checkbox-group">
                        <input type="checkbox" id="export-bloodSugar" value="bloodSugar" checked>
                        <span>血糖</span>
                    </label>
                    <label class="checkbox-group">
                        <input type="checkbox" id="export-heartRate" value="heartRate" checked>
                        <span>心率</span>
                    </label>
                    <label class="checkbox-group">
                        <input type="checkbox" id="export-bloodOxygen" value="bloodOxygen" checked>
                        <span>血氧</span>
                    </label>
                    <label class="checkbox-group">
                        <input type="checkbox" id="export-weight" value="weight" checked>
                        <span>體重</span>
                    </label>
                    <label class="checkbox-group">
                        <input type="checkbox" id="export-medication" value="medication" checked>
                        <span>用藥記錄</span>
                    </label>
                </div>
            </div>

            <button class="btn-primary" onclick="exportToPDF()">匯出為 PDF</button>
        </div>
    </div>

    <!-- Leaflet for map (no API key) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2pdf (包含 html2canvas + jsPDF) 用於正確顯示繁體中文 -->
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

    <script>
        // 數據結構
        let medicines = [];
        let history = [];
        let healthRecords = [];
        let currentCategory = '處方藥';
        let medicineSortMode = localStorage.getItem('medicineSortMode') || 'name_asc';
        let currentHealthType = 'bloodPressure';
        let editingMedicineId = null;
        let currentMedicineDetail = null;
        let editingHealthRecordId = null;
        let healthChart = null;
        // Map related state
        let mapInstance = null;
        let mapInited = false;
        let mapFilter = 'all';
        let mapMarkers = [];
        let userPosition = null; // {lat, lon}
        let searchRadius = 1000; // 默认1公里（减少查询复杂度）
        let allPlaces = []; // 存储所有搜索结果
        let favoritePlaces = JSON.parse(localStorage.getItem('favoritePlaces') || '[]');
        let showingFavorites = false;
        let placesCache = {}; // 缓存搜索结果
        let fetchTimeout = null; // 防抖动定时器
        let currentFetchController = null; // 用于取消请求
        let markerClusterGroup = null; // 标记聚合组
        let currentServerIndex = 0; // 当前使用的服务器索引
        let requestId = 0; // 请求ID，用于跟踪最新请求
        let isRequesting = false; // 是否正在请求中
        let displayedCount = 10; // 当前显示的数量
        const INITIAL_DISPLAY_COUNT = 10; // 初始显示10个
        const LOAD_MORE_COUNT = 10; // 每次加载更多10个
        let myLocationMarker = null; // 用户位置标记
        let loadingStartTime = 0; // 加载开始时间
        let progressInterval = null; // 进度更新定时器
        let currentMessage = '正在連接服務器...'; // 当前加载消息
        let currentProgress = 0; // 当前进度
        let lastSearchPosition = null; // 上次搜索的位置
        let autoSearchEnabled = false; // 是否启用自动搜索
        
        // 小游戏相关变量
        let gameActive = false;
        let gameStarted = false;
        let catY = 150;
        let catVelocity = 0;
        let pills = [];
        let gameScore = 0;
        let gameInterval = null;
        let gameCanvas = null;
        let gameCtx = null;
        let lastFrameTime = 0;
        let gameSpeed = 3; // 游戏速度，会逐渐增加
        let isOnGround = true; // 是否在地面上
        const GRAVITY = 0.5;
        const JUMP_STRENGTH = -7.5; // 降低跳跃高度
        const CAT_SIZE = 35;
        const PILL_WIDTH = 25;
        const PILL_HEIGHT = 35;
        const FRAME_RATE = 1000 / 60; // 60 FPS
        const GROUND_Y = 130; // 地面位置
        const MAX_SPEED = 8; // 最大速度
        
        // 多个 Overpass API 服务器备用
        const overpassServers = [
            'https://overpass.kumi.systems/api/interpreter',
            'https://overpass-api.de/api/interpreter',
            'https://overpass.openstreetmap.ru/api/interpreter',
            'https://overpass.openstreetmap.fr/api/interpreter'
        ];

        // 時段圖標映射
        const timeSlotIcons = {
            morning: '🌅',
            noon: '☀️',
            evening: '🌆',
            bedtime: '🌙'
        };

        const timeSlotNames = {
            morning: '早上',
            noon: '中午',
            evening: '晚上',
            bedtime: '睡前'
        };

        // 初始化
        function init() {
            loadData();
            loadProfile();
            renderMedicines();
            // 初始化健康記錄頁面
            changeHealthType(currentHealthType);
            // 地圖預設濾鏡
            mapFilter = localStorage.getItem('mapFilter') || 'pharmacy';
        }

        // 載入數據
        function loadData() {
            const savedMedicines = localStorage.getItem('medicines');
            const savedHistory = localStorage.getItem('history');
            const savedHealthRecords = localStorage.getItem('healthRecords');

            if (savedMedicines) {
                medicines = JSON.parse(savedMedicines);
                // 升級：補上 createdAt 以支援依添加時間排序
                let upgraded = false;
                medicines.forEach(m => {
                    if (!m.createdAt) {
                        const fallbackTs = parseInt(m.id) || Date.now();
                        m.createdAt = fallbackTs;
                        upgraded = true;
                    }
                });
                if (upgraded) {
                    localStorage.setItem('medicines', JSON.stringify(medicines));
                }
            }

            if (savedHistory) {
                history = JSON.parse(savedHistory);
            }

            if (savedHealthRecords) {
                healthRecords = JSON.parse(savedHealthRecords);
            }
        }

        // 保存數據
        function saveData() {
            localStorage.setItem('medicines', JSON.stringify(medicines));
            localStorage.setItem('history', JSON.stringify(history));
            localStorage.setItem('healthRecords', JSON.stringify(healthRecords));
        }

        // 載入個人資料
        function loadProfile() {
            const profile = JSON.parse(localStorage.getItem('profile') || '{}');
            document.getElementById('userName').value = profile.name || '';
            document.getElementById('userAge').value = profile.age || '';
            document.getElementById('userGender').value = profile.gender || '男性';
            document.getElementById('userHeight').value = profile.height || '';
            document.getElementById('userWeight').value = profile.weight || '';
            if (document.getElementById('userDisease')) {
                document.getElementById('userDisease').value = profile.disease || '';
            }
        }

        // 保存個人資料
        function saveProfile() {
            const profile = {
                name: document.getElementById('userName').value,
                age: document.getElementById('userAge').value,
                gender: document.getElementById('userGender').value,
                height: document.getElementById('userHeight').value,
                weight: document.getElementById('userWeight').value,
                disease: (document.getElementById('userDisease') && document.getElementById('userDisease').value) || ''
            };
            localStorage.setItem('profile', JSON.stringify(profile));
        }

        // 切換分類
        function changeCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === category) {
                    btn.classList.add('active');
                }
            });
            renderMedicines();
        }

        // 搜尋藥品
        function searchMedicines() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            renderMedicines(searchText);
        }

        // 渲染藥品列表
        function renderMedicines(searchText = '') {
            const listContainer = document.getElementById('medicineList');
            let filteredMedicines = medicines.filter(m => m.category === currentCategory);
            
            if (searchText) {
                filteredMedicines = filteredMedicines.filter(m => 
                    m.name.toLowerCase().includes(searchText)
                );
            }

            // 排序
            filteredMedicines = sortMedicines(filteredMedicines, medicineSortMode);

            if (filteredMedicines.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        <h3>暫無${currentCategory}</h3>
                        <p>點擊 + 按鈕添加新藥品</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = filteredMedicines.map(medicine => `
                <div class="medicine-card" onclick="showMedicineDetail('${medicine.id}')">
                    <div class="medicine-image">
                        ${medicine.imageData ? `<img src="${medicine.imageData}" alt="${medicine.name}">` : '💊'}
                    </div>
                    <div class="medicine-info">
                        <div class="medicine-name">${medicine.name}</div>
                        <div class="medicine-dosage">每次 ${medicine.dosage}</div>
                    </div>
                    <div class="time-slots">
                        ${medicine.timeSlots.map(slot => `
                            <div class="time-slot ${isTakenToday(medicine.id, slot) ? 'taken' : ''}" 
                                 onclick="event.stopPropagation(); takeMedicine('${medicine.id}', '${slot}')">
                                ${timeSlotIcons[slot]}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // 藥品排序
        function sortMedicines(list, mode) {
            const arr = list.slice();
            switch (mode) {
                case 'stock_asc':
                    return arr.sort((a, b) => (a.stock || 0) - (b.stock || 0));
                case 'stock_desc':
                    return arr.sort((a, b) => (b.stock || 0) - (a.stock || 0));
                case 'created_desc':
                    return arr.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                case 'created_asc':
                    return arr.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
                default:
                    return arr;
            }
        }

        function toggleSortMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('sortMenu');
            menu.classList.toggle('show');
            // 點擊外部關閉
            const close = (e) => {
                if (!menu.contains(e.target)) {
                    menu.classList.remove('show');
                    document.removeEventListener('click', close);
                }
            };
            document.addEventListener('click', close);
        }

        function setMedicineSort(mode) {
            medicineSortMode = mode;
            localStorage.setItem('medicineSortMode', medicineSortMode);
            renderMedicines(document.getElementById('searchInput').value.toLowerCase());
            const labels = {
                created_desc: '新增時間 新→舊',
                created_asc: '新增時間 舊→新',
                stock_desc: '庫存 高→低',
                stock_asc: '庫存 低→高'
            };
            showToast('排序：' + labels[medicineSortMode], 'success');
            const menu = document.getElementById('sortMenu');
            if (menu) menu.classList.remove('show');
        }

        // 顯示藥品詳情
        function showMedicineDetail(medicineId) {
            const medicine = medicines.find(m => m.id === medicineId);
            if (!medicine) return;

            currentMedicineDetail = medicine;
            document.getElementById('detailMedicineName').textContent = medicine.name;
            
            const detailContent = document.getElementById('medicineDetailContent');
            detailContent.innerHTML = `
                ${medicine.imageData ? `<img src="${medicine.imageData}" style="width: 100%; border-radius: 12px; margin-bottom: 20px;">` : ''}
                <div class="profile-item">
                    <span class="profile-label">類別</span>
                    <span class="profile-value">${medicine.category}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">每次用量</span>
                    <span class="profile-value">${medicine.dosage}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">剩餘庫存</span>
                    <span class="profile-value">${medicine.stock || 0}</span>
                </div>
                <div class="profile-item">
                    <span class="profile-label">服用時段</span>
                    <span class="profile-value">${medicine.timeSlots.map(s => timeSlotNames[s]).join('、')}</span>
                </div>
                ${medicine.notes ? `
                    <div class="profile-item" style="flex-direction: column; align-items: flex-start;">
                        <span class="profile-label">備註</span>
                        <span class="profile-value" style="margin-top: 8px;">${medicine.notes}</span>
                    </div>
                ` : ''}
            `;
            
            showModal('medicineDetailModal');
        }

        // 編輯當前藥品
        function editCurrentMedicine() {
            if (currentMedicineDetail) {
                closeModal('medicineDetailModal');
                editMedicine(currentMedicineDetail.id);
            }
        }

        // 檢查今天是否已服用
        function isTakenToday(medicineId, slot) {
            const today = new Date().toDateString();
            return history.some(h => 
                h.medicineId === medicineId && 
                h.slot === slot && 
                new Date(h.date).toDateString() === today
            );
        }

        // 服藥記錄
        function takeMedicine(medicineId, slot) {
            if (isTakenToday(medicineId, slot)) return;

            const medicine = medicines.find(m => m.id === medicineId);
            if (!medicine) return;

            // 使用自定義確認對話框
            showConfirmDialog(
                '確認服藥',
                `您確定已經服用了 ${medicine.name} ${medicine.dosage} 嗎？`,
                () => {
                    // 減少庫存
                    if (medicine.stock && medicine.stock > 0) {
                        medicine.stock--;
                    }

                    history.push({
                        id: Date.now().toString(),
                        medicineId: medicineId,
                        medicineName: medicine.name,
                        dosage: medicine.dosage,
                        slot: slot,
                        date: new Date().toISOString()
                    });
                    
                    saveData();
                    renderMedicines();
                    renderHealthRecords();
                    showToast('服藥記錄已保存', 'success');
                }
            );
        }

        // 顯示添加藥品
        function showAddMedicine() {
            editingMedicineId = null;
            document.getElementById('modalTitle').textContent = '添加藥品';
            document.getElementById('deleteMedicineBtn').style.display = 'none';
            
            // 清空表單
            document.getElementById('medicineName').value = '';
            document.getElementById('medicineCategory').value = currentCategory;
            document.getElementById('medicineDosage').value = '';
            document.getElementById('medicineStock').value = '';
            document.getElementById('medicineNotes').value = '';
            document.getElementById('medicineImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            
            document.querySelectorAll('.time-slot-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            showModal('addMedicineModal');
        }

        // 編輯藥品
        function editMedicine(medicineId) {
            const medicine = medicines.find(m => m.id === medicineId);
            if (!medicine) return;

            editingMedicineId = medicineId;
            document.getElementById('modalTitle').textContent = '編輯藥品';
            document.getElementById('deleteMedicineBtn').style.display = 'block';
            
            document.getElementById('medicineName').value = medicine.name;
            document.getElementById('medicineCategory').value = medicine.category;
            document.getElementById('medicineDosage').value = medicine.dosage;
            document.getElementById('medicineStock').value = medicine.stock || '';
            document.getElementById('medicineNotes').value = medicine.notes || '';
            
            if (medicine.imageData) {
                document.getElementById('imagePreview').src = medicine.imageData;
                document.getElementById('imagePreview').style.display = 'block';
            }
            
            document.querySelectorAll('.time-slot-option').forEach(el => {
                if (medicine.timeSlots.includes(el.dataset.slot)) {
                    el.classList.add('selected');
                } else {
                    el.classList.remove('selected');
                }
            });
            
            showModal('addMedicineModal');
        }

        // 切換時段選擇
        function toggleTimeSlot(element) {
            element.classList.toggle('selected');
        }

        // 圖片預覽
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 保存藥品
        function saveMedicine() {
            // 防止重複提交
            if (isSubmitting) {
                showToast('正在保存中，請稍候...', 'info');
                return;
            }

            const name = document.getElementById('medicineName').value.trim();
            const category = document.getElementById('medicineCategory').value;
            const dosage = document.getElementById('medicineDosage').value.trim();
            const stock = parseInt(document.getElementById('medicineStock').value) || 0;
            const notes = document.getElementById('medicineNotes').value.trim();
            const imagePreview = document.getElementById('imagePreview');
            
            // 檢查必填欄位
            if (!name || !dosage) {
                showToast('請填寫藥品名稱和用量', 'error');
                return;
            }

            const selectedSlots = Array.from(document.querySelectorAll('.time-slot-option.selected'))
                .map(el => el.dataset.slot);
            
            if (selectedSlots.length === 0) {
                showToast('請選擇至少一個服用時段', 'error');
                return;
            }

            // 設置提交狀態
            isSubmitting = true;
            const saveButton = document.querySelector('#addMedicineModal .btn-primary');
            if (saveButton) {
                saveButton.textContent = '保存中...';
                saveButton.disabled = true;
            }

            const medicineData = {
                name,
                category,
                dosage,
                stock,
                notes,
                timeSlots: selectedSlots,
                imageData: imagePreview.style.display !== 'none' ? imagePreview.src : null,
                createdAt: Date.now()
            };

            try {
                if (editingMedicineId) {
                    const index = medicines.findIndex(m => m.id === editingMedicineId);
                    if (index !== -1) {
                        medicines[index] = { ...medicines[index], ...medicineData };
                    }
                } else {
                    medicines.push({
                        id: Date.now().toString(),
                        ...medicineData
                    });
                }

                saveData();
                renderMedicines();
                closeModal('addMedicineModal');
                showToast('藥品保存成功！', 'success');
            } catch (error) {
                console.error('保存藥品時發生錯誤:', error);
                showToast('保存失敗，請重試', 'error');
            } finally {
                // 重置提交狀態
                isSubmitting = false;
                if (saveButton) {
                    saveButton.textContent = '保存';
                    saveButton.disabled = false;
                }
            }
        }

        // 刪除藥品
        function deleteMedicine() {
            if (!editingMedicineId) return;
            
            showConfirmDialog(
                '刪除藥品',
                '確定要刪除這個藥品嗎？',
                () => {
                    medicines = medicines.filter(m => m.id !== editingMedicineId);
                    saveData();
                    renderMedicines();
                    closeModal('addMedicineModal');
                    showToast('藥品已刪除', 'success');
                }
            );
        }

        // 顯示歷史記錄
        function showHistory() {
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h3>暫無服藥記錄</h3>
                    </div>
                `;
            } else {
                const sortedHistory = [...history].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                
                historyList.innerHTML = sortedHistory.map(item => {
                    const date = new Date(item.date);
                    return `
                        <div class="history-item">
                            <div class="history-date">${date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                            <div class="history-medicine">${item.medicineName}</div>
                            <div class="history-time">${timeSlotNames[item.slot]} - ${item.dosage}</div>
                        </div>
                    `;
                }).join('');
            }
            
            showModal('historyModal');
        }

        // 健康記錄類型配置
        const healthTypes = {
            bloodPressure: { name: '血壓', icon: '❤️', unit: 'mmHg', color: '#dc3545' },
            bloodSugar: { name: '血糖', icon: '🩸', unit: 'mmol/L', color: '#fd7e14' },
            heartRate: { name: '心率', icon: '💓', unit: 'bpm', color: '#e83e8c' },
            bloodOxygen: { name: '血氧', icon: '🫁', unit: '%', color: '#007bff' },
            weight: { name: '體重', icon: '⚖️', unit: 'kg', color: '#28a745' },
            medication: { name: '用藥記錄', icon: '💊', unit: '', color: '#6f42c1' }
        };

        // 切換健康記錄類型
        function changeHealthType(type) {
            console.log(`切換健康記錄類型到: ${type}`);
            currentHealthType = type;
            
            // 更新按鈕狀態
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === type) {
                    btn.classList.add('active');
                }
            });

            // 顯示/隱藏同步按鈕
            const syncButton = document.getElementById('syncButton');
            if (type === 'medication') {
                syncButton.style.display = 'block';
            } else {
                syncButton.style.display = 'none';
            }

            // 重新渲染健康記錄（只顯示選中類型的記錄）
            renderHealthRecords();
            updateChart();
            
            // 顯示切換提示
            const totalRecords = healthRecords.length;
            const filteredRecords = healthRecords.filter(record => record && record.type === type);
            console.log(`總記錄數: ${totalRecords}, ${healthTypes[type].name}記錄數: ${filteredRecords.length}`);
            
            if (totalRecords > 0 && filteredRecords.length === 0) {
                showToast(`已切換到${healthTypes[type].name}，當前沒有此類型的記錄`, 'info');
            }
        }

        // 渲染健康記錄
        function renderHealthRecords() {
            const container = document.getElementById('healthRecordsList');
            
            // 確保只顯示當前選中類型的記錄
            const filteredRecords = healthRecords.filter(record => {
                return record && record.type === currentHealthType;
            });
            
            console.log(`當前類型: ${currentHealthType}, 過濾後記錄數: ${filteredRecords.length}, 總記錄數: ${healthRecords.length}`);
            
            if (filteredRecords.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <h3>暫無${healthTypes[currentHealthType].name}記錄</h3>
                        <p>點擊右下方 + 按鈕添加新記錄</p>
                    </div>
                `;
                return;
            }

            // 按日期分組
            const groupedByDate = {};
            filteredRecords.forEach(record => {
                const dateKey = new Date(record.date).toLocaleDateString('zh-TW');
                if (!groupedByDate[dateKey]) {
                    groupedByDate[dateKey] = [];
                }
                groupedByDate[dateKey].push(record);
            });

            const sortedDates = Object.keys(groupedByDate).sort((a, b) => 
                new Date(b) - new Date(a)
            );

            container.innerHTML = sortedDates.map(date => `
                <div class="date-group">
                    <div class="date-group-title">${formatDateHeader(date)}</div>
                    ${groupedByDate[date].sort((a, b) => new Date(b.date) - new Date(a.date)).map(record => `
                        <div class="health-record-item" onclick="editHealthRecord('${record.id}')">
                            <div class="health-record-header">
                                <div class="health-record-type">
                                    <span>${healthTypes[record.type].icon}</span>
                                    <span>${healthTypes[record.type].name}</span>
                                </div>
                                <div class="health-record-time">${formatTime(new Date(record.date))}</div>
                            </div>
                            <div class="health-record-value">${formatHealthValue(record)}</div>
                            ${record.note ? `<div class="health-record-note">${record.note}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        // 格式化健康記錄數值
        function formatHealthValue(record) {
            if (record.type === 'bloodPressure') {
                return `${record.value}/${record.value2} ${healthTypes[record.type].unit}`;
            } else if (record.type === 'medication') {
                return `${record.medicationName || '未知藥物'}${record.dosage ? ' (' + record.dosage + ')' : ''}`;
            } else {
                return `${record.value} ${healthTypes[record.type].unit}`;
            }
        }

        // 格式化日期標題
        function formatDateHeader(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (date.toDateString() === today.toDateString()) {
                return '今天';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return '昨天';
            } else {
                return dateString;
            }
        }

        // 格式化時間
        function formatTime(date) {
            return date.toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // 切換視圖
        function switchView(view) {
            document.querySelectorAll('.view-container').forEach(el => {
                el.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active');
            });

            if (view === 'medicines') {
                document.getElementById('medicinesView').classList.add('active');
                document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            } else if (view === 'health') {
                document.getElementById('healthView').classList.add('active');
                document.querySelector('.nav-item:nth-child(2)').classList.add('active');
                renderHealthRecords();
                updateChart();
            } else if (view === 'map') {
                document.getElementById('mapView').classList.add('active');
                document.querySelector('.nav-item:nth-child(3)').classList.add('active');
                initMapOnce();
            } else if (view === 'profile') {
                document.getElementById('profileView').classList.add('active');
                document.querySelector('.nav-item:nth-child(4)').classList.add('active');
            }
        }

        // 模態窗口控制
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // 點擊模態窗口外部關閉
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('show');
                }
            });
        });

        // Toast 提示功能
        function showToast(message, type = 'info') {
            // 移除現有的 toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // 創建新的 toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // 顯示 toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            // 自動隱藏
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 3000);
        }

        // 防止重複提交
        let isSubmitting = false;

        // 自定義確認對話框
        function showConfirmDialog(title, message, onConfirm) {
            // 移除現有的確認對話框
            const existingDialog = document.querySelector('.confirm-dialog');
            if (existingDialog) {
                existingDialog.remove();
            }

            // 創建確認對話框
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog modal show';
            dialog.innerHTML = `
                <div class="modal-content" style="max-width: 400px; text-align: center; padding: 24px 20px;">
                    <h3 style="margin-top: 8px; margin-bottom: 16px; font-size: 18px; font-weight: 600;">${title}</h3>
                    <p style="margin-bottom: 24px; color: #666;">${message}</p>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn-cancel" style="flex: 1; padding: 12px; background: #f5f5f5; color: #333; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;">取消</button>
                        <button class="btn-confirm" style="flex: 1; padding: 12px; background: #4D9980; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;">確認</button>
                    </div>
                </div>
            `;

            document.body.appendChild(dialog);

            // 綁定事件
            dialog.querySelector('.btn-cancel').onclick = () => {
                dialog.remove();
            };

            dialog.querySelector('.btn-confirm').onclick = () => {
                dialog.remove();
                if (onConfirm) onConfirm();
            };

            // 點擊背景關閉
            dialog.onclick = (e) => {
                if (e.target === dialog) {
                    dialog.remove();
                }
            };
        }

        // 健康記錄相關功能
        function showAddHealthRecord() {
            document.getElementById('healthRecordType').value = currentHealthType;
            document.getElementById('healthRecordDate').value = new Date().toISOString().slice(0, 16);
            document.getElementById('healthRecordNote').value = '';
            document.getElementById('systolicPressure').value = '';
            document.getElementById('diastolicPressure').value = '';
            document.getElementById('healthRecordValue').value = '';
            document.getElementById('healthMedicationName').value = '';
            document.getElementById('healthMedicationDosage').value = '';
            
            updateHealthRecordForm();
            showModal('addHealthRecordModal');
        }

        function updateHealthRecordForm() {
            const type = document.getElementById('healthRecordType').value;
            const bloodPressureInputs = document.getElementById('bloodPressureInputs');
            const singleValueInput = document.getElementById('singleValueInput');
            const medicationInputs = document.getElementById('medicationInputs');
            const unitSpan = document.getElementById('healthRecordUnit');

            // 隱藏所有輸入區域
            bloodPressureInputs.style.display = 'none';
            singleValueInput.style.display = 'none';
            medicationInputs.style.display = 'none';

            if (type === 'bloodPressure') {
                bloodPressureInputs.style.display = 'block';
            } else if (type === 'medication') {
                medicationInputs.style.display = 'block';
            } else {
                singleValueInput.style.display = 'block';
                unitSpan.textContent = healthTypes[type].unit;
            }
        }

        function saveHealthRecord() {
            const type = document.getElementById('healthRecordType').value;
            const date = document.getElementById('healthRecordDate').value;
            const note = document.getElementById('healthRecordNote').value.trim();

            if (!date) {
                showToast('請選擇日期時間', 'error');
                return;
            }

            let record = {
                id: Date.now().toString(),
                type: type,
                date: new Date(date).toISOString(),
                note: note || null
            };

            if (type === 'bloodPressure') {
                const systolic = parseFloat(document.getElementById('systolicPressure').value);
                const diastolic = parseFloat(document.getElementById('diastolicPressure').value);
                
                if (!systolic || !diastolic) {
                    showToast('請填寫血壓數值', 'error');
                    return;
                }
                
                record.value = systolic;
                record.value2 = diastolic;
            } else if (type === 'medication') {
                const medicationName = document.getElementById('healthMedicationName').value.trim();
                const dosage = document.getElementById('healthMedicationDosage').value.trim();
                
                if (!medicationName) {
                    showToast('請填寫藥品名稱', 'error');
                    return;
                }
                
                record.medicationName = medicationName;
                record.dosage = dosage || null;
                record.value = 0;
            } else {
                const value = parseFloat(document.getElementById('healthRecordValue').value);
                
                if (!value && value !== 0) {
                    showToast('請填寫測量值', 'error');
                    return;
                }
                
                record.value = value;
            }

            healthRecords.push(record);
            saveData();
            
            // 自動切換到剛添加的記錄類型
            if (currentHealthType !== record.type) {
                changeHealthType(record.type);
            } else {
                renderHealthRecords();
                updateChart();
            }
            
            closeModal('addHealthRecordModal');
            showToast(`${healthTypes[record.type].name}記錄保存成功！`, 'success');
        }

        function editHealthRecord(recordId) {
            const record = healthRecords.find(r => r.id === recordId);
            if (!record) return;

            editingHealthRecordId = recordId;
            document.getElementById('editRecordType').value = healthTypes[record.type].name;
            document.getElementById('editRecordDate').value = new Date(record.date).toISOString().slice(0, 16);
            document.getElementById('editRecordNote').value = record.note || '';

            const editValueInputs = document.getElementById('editValueInputs');
            
            if (record.type === 'bloodPressure') {
                editValueInputs.innerHTML = `
                    <label class="form-label">血壓數值</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="editSystolicPressure" class="form-input" value="${record.value}" style="flex: 1;">
                        <span>/</span>
                        <input type="number" id="editDiastolicPressure" class="form-input" value="${record.value2}" style="flex: 1;">
                        <span>mmHg</span>
                    </div>
                `;
            } else if (record.type === 'medication') {
                editValueInputs.innerHTML = `
                    <label class="form-label">藥品名稱</label>
                    <input type="text" id="editMedicationName" class="form-input" value="${record.medicationName || ''}">
                    
                    <label class="form-label" style="margin-top: 15px;">劑量</label>
                    <input type="text" id="editMedicationDosage" class="form-input" value="${record.dosage || ''}">
                `;
            } else {
                editValueInputs.innerHTML = `
                    <label class="form-label">測量值</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="editHealthValue" class="form-input" value="${record.value}" step="0.1" style="flex: 1;">
                        <span>${healthTypes[record.type].unit}</span>
                    </div>
                `;
            }

            showModal('editHealthRecordModal');
        }

        function updateHealthRecord() {
            const record = healthRecords.find(r => r.id === editingHealthRecordId);
            if (!record) return;

            const date = document.getElementById('editRecordDate').value;
            const note = document.getElementById('editRecordNote').value.trim();

            if (!date) {
                showToast('請選擇日期時間', 'error');
                return;
            }

            record.date = new Date(date).toISOString();
            record.note = note || null;

            if (record.type === 'bloodPressure') {
                const systolic = parseFloat(document.getElementById('editSystolicPressure').value);
                const diastolic = parseFloat(document.getElementById('editDiastolicPressure').value);
                
                if (!systolic || !diastolic) {
                    showToast('請填寫血壓數值', 'error');
                    return;
                }
                
                record.value = systolic;
                record.value2 = diastolic;
            } else if (record.type === 'medication') {
                const medicationName = document.getElementById('editMedicationName').value.trim();
                const dosage = document.getElementById('editMedicationDosage').value.trim();
                
                if (!medicationName) {
                    showToast('請填寫藥品名稱', 'error');
                    return;
                }
                
                record.medicationName = medicationName;
                record.dosage = dosage || null;
            } else {
                const value = parseFloat(document.getElementById('editHealthValue').value);
                
                if (!value && value !== 0) {
                    showToast('請填寫測量值', 'error');
                    return;
                }
                
                record.value = value;
            }

            saveData();
            
            // 確保顯示更新後的記錄
            if (currentHealthType !== record.type) {
                changeHealthType(record.type);
            } else {
                renderHealthRecords();
                updateChart();
            }
            
            closeModal('editHealthRecordModal');
            showToast('健康記錄更新成功！', 'success');
        }

        function deleteHealthRecord() {
            showConfirmDialog(
                '刪除健康記錄',
                '確定要刪除這條健康記錄嗎？',
                () => {
                    const recordToDelete = healthRecords.find(r => r.id === editingHealthRecordId);
                    healthRecords = healthRecords.filter(r => r.id !== editingHealthRecordId);
                    saveData();
                    
                    // 刷新當前類型的記錄顯示
                    renderHealthRecords();
                    updateChart();
                    closeModal('editHealthRecordModal');
                    
                    if (recordToDelete) {
                        showToast(`${healthTypes[recordToDelete.type].name}記錄已刪除`, 'success');
                    } else {
                        showToast('健康記錄已刪除', 'success');
                    }
                }
            );
        }

        // 同步藥品記錄
        function syncMedicationRecords() {
            const newRecords = [];
            
            history.forEach(h => {
                // 檢查是否已存在相同的用藥記錄
                const exists = healthRecords.some(r => 
                    r.type === 'medication' &&
                    r.medicationName === h.medicineName &&
                    new Date(r.date).toDateString() === new Date(h.date).toDateString() &&
                    r.note === `${timeSlotNames[h.slot]} - ${h.dosage}`
                );

                if (!exists) {
                    newRecords.push({
                        id: Date.now().toString() + Math.random(),
                        type: 'medication',
                        date: h.date,
                        medicationName: h.medicineName,
                        dosage: h.dosage,
                        note: `${timeSlotNames[h.slot]} - ${h.dosage}`,
                        value: 0
                    });
                }
            });

            if (newRecords.length > 0) {
                healthRecords.push(...newRecords);
                saveData();
                renderHealthRecords();
                showToast(`已同步 ${newRecords.length} 條藥品記錄`, 'success');
            } else {
                showToast('沒有新的藥品記錄需要同步', 'info');
            }
        }

        // 匯出功能
        function showExportOptions() {
            showModal('exportOptionsModal');
        }

        async function exportToPDF() {
            const selectedTypes = getSelectedExportTypes();
            if (selectedTypes.length === 0) {
                showToast('請選擇至少一種記錄類型', 'error');
                return;
            }

            const filteredRecords = healthRecords.filter(record => selectedTypes.includes(record.type));
            if (filteredRecords.length === 0) {
                showToast('沒有可匯出的記錄', 'error');
                return;
            }

            // 建立臨時 DOM（使用原生字型渲染，確保繁體中文顯示正確）
            const container = document.createElement('div');
            container.style.padding = '24px';
            container.style.width = '794px'; // A4 寬度 @96DPI 約 794px
            container.style.boxSizing = 'border-box';
            container.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft JhengHei', sans-serif";
            // 讓每個區塊避免被截斷
            container.style.wordBreak = 'break-word';

            const title = document.createElement('h2');
            title.textContent = '健康記錄報告';
            title.style.textAlign = 'center';
            title.style.color = '#2f6f5d';
            container.appendChild(title);

            const gen = document.createElement('div');
            gen.style.textAlign = 'center';
            gen.style.marginBottom = '12px';
            gen.textContent = '生成時間：' + new Date().toLocaleString('zh-TW');
            container.appendChild(gen);

            const imageLoadPromises = [];

            selectedTypes.forEach(type => {
                const typeRecords = filteredRecords.filter(r => r.type === type);
                if (typeRecords.length === 0) return;

                const section = document.createElement('div');
                section.style.margin = '16px 0 24px';
                section.style.pageBreakInside = 'avoid';

                const header = document.createElement('h3');
                header.textContent = `${healthTypes[type].name}記錄`;
                header.style.color = '#4D9980';
                header.style.margin = '0 0 8px 0';
                section.appendChild(header);

                // 圖表
                if (type !== 'medication' && typeRecords.length >= 2) {
                    const chartPxWidth = 1000;
                    const chartPxHeight = 360;
                    const dpr = Math.min(2, Math.max(1.5, window.devicePixelRatio || 1));
                    const { dataUrl } = getChartImageData(type, typeRecords, chartPxWidth, chartPxHeight, dpr);
                    const img = document.createElement('img');
                    img.src = dataUrl;
                    img.style.width = '100%';
                    img.style.height = 'auto';
                    img.style.margin = '6px 0 10px';
                    section.appendChild(img);
                    imageLoadPromises.push(new Promise(res => { img.onload = () => res(); img.onerror = () => res(); }));
                }

                // 清單
                const list = document.createElement('div');
                const recordsForPdf = typeRecords
                    .slice()
                    .sort((a, b) => new Date(b.date) - new Date(a.date)); // 顯示所有筆數
                list.style.display = 'grid';
                list.style.gridTemplateColumns = '1fr 1fr';
                list.style.columnGap = '24px';
                list.style.rowGap = '6px';

                recordsForPdf.forEach(record => {
                    const row = document.createElement('div');
                    row.style.pageBreakInside = 'avoid';
                    const dateStr = new Date(record.date).toLocaleString('zh-TW');
                    let valueStr = '';
                    if (record.type === 'bloodPressure') {
                        valueStr = `${record.value}/${record.value2} ${healthTypes[record.type].unit}`;
                    } else if (record.type === 'medication') {
                        valueStr = `${record.medicationName || '未知藥物'}${record.dosage ? ' (' + record.dosage + ')' : ''}`;
                    } else {
                        valueStr = `${record.value} ${healthTypes[record.type].unit}`;
                    }
                    row.textContent = `${dateStr}    ${valueStr}`;
                    list.appendChild(row);
                });

                section.appendChild(list);
                container.appendChild(section);
            });

            // 掛到 body 後用 html2pdf 匯出，再移除
            document.body.appendChild(container);

            // 等待所有圖表圖片載入，避免被截圖時缺圖
            try { await Promise.all(imageLoadPromises); } catch (_) {}

            const opt = {
                margin:       [10, 10, 10, 10], // mm
                filename:     '健康記錄報告_' + new Date().toISOString().slice(0,10) + '.pdf',
                image:        { type: 'jpeg', quality: 0.92 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().from(container).set(opt).save().then(() => {
                container.remove();
                closeModal('exportOptionsModal');
                showToast('PDF匯出成功！', 'success');
            }).catch(err => {
                console.error('PDF匯出失敗:', err);
                container.remove();
                showToast('PDF匯出失敗，請重試', 'error');
            });
        }

        // 圖片匯出功能已移除（僅保留 PDF 匯出）

        // 以固定尺寸與像素比創建離屏圖表，避免匯出時被壓縮變形
        function createExportChart(type, records, cssWidth, cssHeight, devicePixelRatio = 2) {
            const tempCanvas = document.createElement('canvas');
            // 物理解像度：CSS 尺寸 * 像素比，確保清晰
            tempCanvas.width = Math.floor(cssWidth * devicePixelRatio);
            tempCanvas.height = Math.floor(cssHeight * devicePixelRatio);
            tempCanvas.style.width = cssWidth + 'px';
            tempCanvas.style.height = cssHeight + 'px';
            const ctx = tempCanvas.getContext('2d');
            // 將坐標系縮放到 DPR，避免圖表被拉伸
            ctx.scale(devicePixelRatio, devicePixelRatio);
            
            const sortedRecords = records.sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = sortedRecords.map(record => {
                const date = new Date(record.date);
                return date.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });
            });

            if (type === 'bloodPressure') {
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '收縮壓',
                                data: sortedRecords.map(record => record.value),
                                borderColor: '#dc3545',
                                backgroundColor: '#dc3545',
                                tension: 0.1,
                                pointRadius: 4
                            },
                            {
                                label: '舒張壓',
                                data: sortedRecords.map(record => record.value2),
                                borderColor: '#007bff',
                                backgroundColor: '#007bff',
                                tension: 0.1,
                                pointRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: false,
                        animation: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${healthTypes[type].name}趨勢圖`,
                                font: { size: 18, weight: 'bold' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: healthTypes[type].unit
                                }
                            }
                        }
                    }
                });
                // 強制立即渲染
                chart.update();
                return { canvas: tempCanvas, chart };
            } else {
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: healthTypes[type].name,
                            data: sortedRecords.map(record => record.value),
                            borderColor: healthTypes[type].color,
                            backgroundColor: healthTypes[type].color,
                            tension: 0.1,
                            pointRadius: 4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: false,
                         animation: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${healthTypes[type].name}趨勢圖`,
                                font: { size: 18, weight: 'bold' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: healthTypes[type].unit
                                }
                            }
                        }
                    }
                });
                // 強制立即渲染
                chart.update();
                return { canvas: tempCanvas, chart };
            }
        }

        // 取得圖表 PNG dataURL（封裝 createExportChart）
        function getChartImageData(type, records, widthPx, heightPx, dpr) {
            const { canvas, chart } = createExportChart(type, records, widthPx, heightPx, dpr);
            const dataUrl = canvas.toDataURL('image/png');
            chart.destroy();
            return { dataUrl, widthPx, heightPx };
        }

        function getSelectedExportTypes() {
            const checkboxes = document.querySelectorAll('.export-types input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // 圖表功能
        function updateChart() {
            const filteredRecords = healthRecords.filter(record => record.type === currentHealthType);
            
            // 只有非用藥記錄且有多個數據點時才顯示圖表
            if (currentHealthType === 'medication' || filteredRecords.length < 2) {
                document.getElementById('chartContainer').style.display = 'none';
                return;
            }

            document.getElementById('chartContainer').style.display = 'block';
            
            // 銷毀現有圖表
            if (healthChart) {
                healthChart.destroy();
            }

            const ctx = document.getElementById('healthChart').getContext('2d');
            const sortedRecords = filteredRecords.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const labels = sortedRecords.map(record => {
                const date = new Date(record.date);
                return date.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });
            });

            if (currentHealthType === 'bloodPressure') {
                // 血壓雙線圖表
                healthChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '收縮壓',
                                data: sortedRecords.map(record => record.value),
                                borderColor: '#dc3545',
                                backgroundColor: '#dc3545',
                                tension: 0.1,
                                pointRadius: 4
                            },
                            {
                                label: '舒張壓',
                                data: sortedRecords.map(record => record.value2),
                                borderColor: '#007bff',
                                backgroundColor: '#007bff',
                                tension: 0.1,
                                pointRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${healthTypes[currentHealthType].name}趨勢圖`,
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: healthTypes[currentHealthType].unit
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: '日期'
                                }
                            }
                        }
                    }
                });
            } else {
                // 單線圖表
                healthChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: healthTypes[currentHealthType].name,
                            data: sortedRecords.map(record => record.value),
                            borderColor: healthTypes[currentHealthType].color,
                            backgroundColor: healthTypes[currentHealthType].color,
                            tension: 0.1,
                            pointRadius: 4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${healthTypes[currentHealthType].name}趨勢圖`,
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: healthTypes[currentHealthType].unit
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: '日期'
                                }
                            }
                        }
                    }
                });
            }
        }

        // -------- Map (Leaflet + Overpass) ----------
        function initMapOnce() {
            if (mapInited) return;
            mapInited = true;
            const mapEl = document.getElementById('map');
            
            // 优化：使用更快的瓦片服务器，并启用硬件加速
            mapInstance = L.map(mapEl, {
                preferCanvas: true, // 使用 Canvas 渲染，性能更好
                zoomControl: true,
                attributionControl: false
            }).setView([25.033964, 121.564468], 14);
            
            // 使用多个瓦片服务器轮换，提高加载速度
            const tileUrls = [
                'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
            ];
            
            L.tileLayer(tileUrls[0], {
                maxZoom: 18,
                attribution: '&copy; OpenStreetMap',
                updateWhenIdle: true, // 只在停止移动时更新
                updateWhenZooming: false, // 缩放时不更新
                keepBuffer: 2 // 保持2屏幕的缓冲区
            }).addTo(mapInstance);

            // 定位 - 优化超时设置
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const { latitude, longitude } = pos.coords;
                    mapInstance.setView([latitude, longitude], 15);
                    
                    // 保存用户位置标记
                    myLocationMarker = L.circle([latitude, longitude], { 
                        radius: 30, 
                        color: '#4D9980',
                        fillColor: '#4D9980',
                        fillOpacity: 0.5
                    }).addTo(mapInstance);
                    
                    userPosition = { lat: latitude, lon: longitude };
                    debouncedFetchPlaces(latitude, longitude);
                }, (err) => {
                    console.warn('定位失敗/被拒絕:', err);
                    debouncedFetchPlaces();
                }, { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 }); // 降低精度要求，提高速度
            } else {
                debouncedFetchPlaces();
            }
            
            // 地图移动结束后显示"搜索此区域"按钮
            mapInstance.on('moveend', () => {
                const center = mapInstance.getCenter();
                
                // 计算移动距离
                if (lastSearchPosition) {
                    const distance = distanceInMeters(
                        lastSearchPosition.lat, 
                        lastSearchPosition.lon, 
                        center.lat, 
                        center.lng
                    );
                    
                    // 如果移动距离超过500米，显示"搜索此区域"按钮
                    if (distance > 500) {
                        showSearchAreaButton();
                    } else {
                        // 移动距离太小，隐藏按钮
                        hideSearchAreaButton();
                    }
                } else {
                    // 首次移动，隐藏按钮
                    hideSearchAreaButton();
                }
            });
        }

        // 显示"搜索此区域"按钮
        function showSearchAreaButton() {
            const btn = document.getElementById('searchAreaBtn');
            if (btn) {
                btn.style.display = 'block';
            }
        }

        // 隐藏"搜索此区域"按钮
        function hideSearchAreaButton() {
            const btn = document.getElementById('searchAreaBtn');
            if (btn) {
                btn.style.display = 'none';
            }
        }

        // 搜索当前区域
        function searchCurrentArea() {
            hideSearchAreaButton();
            const center = mapInstance.getCenter();
            fetchPlaces(center.lat, center.lng);
        }

        // 回到我的位置
        function goToMyLocation() {
            if (userPosition) {
                // 有保存的位置，直接跳转
                mapInstance.setView([userPosition.lat, userPosition.lon], 15);
                
                // 让标记闪烁一下提示用户
                if (myLocationMarker) {
                    const originalRadius = 30;
                    myLocationMarker.setRadius(50);
                    setTimeout(() => myLocationMarker.setRadius(originalRadius), 300);
                }
            } else {
                // 重新获取位置
                const btn = document.getElementById('myLocationBtn');
                btn.innerHTML = '⏳';
                btn.disabled = true;
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((pos) => {
                        const { latitude, longitude } = pos.coords;
                        mapInstance.setView([latitude, longitude], 15);
                        
                        // 创建或更新位置标记
                        if (myLocationMarker) {
                            myLocationMarker.setLatLng([latitude, longitude]);
                        } else {
                            myLocationMarker = L.circle([latitude, longitude], { 
                                radius: 30, 
                                color: '#4D9980',
                                fillColor: '#4D9980',
                                fillOpacity: 0.5
                            }).addTo(mapInstance);
                        }
                        
                        userPosition = { lat: latitude, lon: longitude };
                        btn.innerHTML = '📍';
                        btn.disabled = false;
                        
                        // 重新加载附近数据
                        fetchPlaces(latitude, longitude);
                    }, (err) => {
                        alert('無法獲取您的位置，請確認已允許定位權限');
                        btn.innerHTML = '📍';
                        btn.disabled = false;
                    }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 });
                } else {
                    alert('您的瀏覽器不支持定位功能');
                    btn.innerHTML = '📍';
                    btn.disabled = false;
                }
            }
        }

        // 防抖动函数 - 只用于地图移动等频繁事件
        function debouncedFetchPlaces(lat, lon) {
            if (fetchTimeout) {
                clearTimeout(fetchTimeout);
            }
            fetchTimeout = setTimeout(() => {
                fetchPlaces(lat, lon);
            }, 300); // 减少到300ms
        }

        function setMapFilter(f) {
            mapFilter = f;
            localStorage.setItem('mapFilter', f);
            
            // 立即取消所有进行中的请求
            cancelCurrentRequest();
            
            const center = mapInstance.getCenter();
            // 用户主动点击，立即执行，不使用防抖动
            fetchPlaces(center.lat, center.lng);
            
            // UI active
            document.querySelectorAll('#mapView .type-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.filter === f);
            });
        }
        
        // 取消当前请求（但保留游戏）
        function cancelCurrentRequest() {
            // 取消防抖动定时器
            if (fetchTimeout) {
                clearTimeout(fetchTimeout);
                fetchTimeout = null;
            }
            
            // 取消正在进行的请求
            if (currentFetchController) {
                currentFetchController.abort();
                currentFetchController = null;
            }
            
            // 清除进度定时器
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            
            // 重置请求状态
            isRequesting = false;
            
            // 显示取消提示（保留游戏）
            const list = document.getElementById('placeList');
            if (list) {
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>🚫 已取消搜尋</h3>
                        <p style="color: #999; margin: 12px 0;">
                            ${gameActive ? '繼續玩遊戲，或調整設定後重新搜尋' : '您可以調整設定後重新搜尋'}
                        </p>
                        <button onclick="fetchPlaces()" class="sync-btn" style="margin-top: 12px;">🔄 重新搜尋</button>
                    </div>
                `;
            }
        }

        // 显示加载进度
        function showLoadingProgress(container, message, progress) {
            const elapsed = Math.floor((Date.now() - loadingStartTime) / 1000);
            
            // 10秒后启动游戏
            if (elapsed >= 10 && !gameActive) {
                startMiniGame(container, message, elapsed);
                return;
            }
            
            // 智能提示和操作：根据实际等待时间
            let actionButtons = '';
            if (elapsed > 10 && gameActive) {
                actionButtons = `
                    <div style="margin-top: 16px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="cancelCurrentRequest(); quickFix();" 
                                style="background: linear-gradient(135deg, #b8c5d6 0%, #a8b9cc 100%); 
                                       color: #4a5568; 
                                       border: 1px solid #cbd5e0; 
                                       padding: 10px 20px; 
                                       border-radius: 8px; 
                                       font-size: 14px; 
                                       font-weight: 500;
                                       cursor: pointer; 
                                       box-shadow: 0 2px 6px rgba(0,0,0,0.08);
                                       transition: all 0.3s ease;
                                       display: inline-flex;
                                       align-items: center;
                                       gap: 6px;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 10px rgba(0,0,0,0.12)'; this.style.background='linear-gradient(135deg, #a8b9cc 0%, #98aabb 100%)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.08)'; this.style.background='linear-gradient(135deg, #b8c5d6 0%, #a8b9cc 100%)';">
                            <span style="font-size: 16px;">⚡</span> 優化設定重試
                        </button>
                        <button onclick="cancelCurrentRequest();" 
                                style="background: linear-gradient(135deg, #e8eaed 0%, #d5d8dc 100%); 
                                       color: #5a6270; 
                                       border: 1px solid #cbd5e0; 
                                       padding: 10px 20px; 
                                       border-radius: 8px; 
                                       font-size: 14px; 
                                       font-weight: 500;
                                       cursor: pointer; 
                                       box-shadow: 0 2px 6px rgba(0,0,0,0.08);
                                       transition: all 0.3s ease;
                                       display: inline-flex;
                                       align-items: center;
                                       gap: 6px;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 10px rgba(0,0,0,0.12)'; this.style.background='linear-gradient(135deg, #d5d8dc 0%, #c5c9cd 100%)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.08)'; this.style.background='linear-gradient(135deg, #e8eaed 0%, #d5d8dc 100%)';">
                            <span style="font-size: 16px;">⏸️</span> 取消
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="loading" style="padding: 30px 20px;">
                    <div class="spinner"></div>
                    <div style="margin-top: 16px; text-align: center;">
                        <div style="font-size: 15px; font-weight: 500; margin-bottom: 8px;">${message}</div>
                        <div style="font-size: 13px; color: #999; margin-bottom: 16px;">
                            已等待 <strong>${elapsed}</strong> 秒
                            ${elapsed > 20 ? '<span style="color: #ff9800;">（較慢）</span>' : ''}
                            ${elapsed > 45 ? '<span style="color: #f44336;">（異常慢）</span>' : ''}
                        </div>
                        
                        <!-- 进度条 -->
                        <div style="background: #e0e0e0; height: 6px; border-radius: 3px; overflow: hidden; margin: 0 auto; max-width: 200px;">
                            <div style="background: linear-gradient(90deg, #4D9980, #6cb896); height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                        </div>
                        
                        ${actionButtons}
                    </div>
                </div>
            `;
        }

        // 启动迷你游戏
        function startMiniGame(container, message, elapsed) {
            if (gameActive) return;
            
            try {
                gameActive = true;
                gameStarted = false;
                gameScore = 0;
                catY = GROUND_Y; // 调整初始位置适应新画布大小
                catVelocity = 0;
                pills = [];
                gameSpeed = 3; // 重置速度
                isOnGround = true;
            
            // 在下方列表区域只显示简单的等待提示
            container.innerHTML = `
                <div class="loading" style="padding: 30px 20px;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                        ${message}
                    </div>
                    <div style="font-size: 12px; color: #999;">
                        已等待 <strong>${elapsed}</strong> 秒
                    </div>
                    <div style="margin-top: 16px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="cancelCurrentRequest(); quickFix();" 
                                style="background: linear-gradient(135deg, #b8c5d6 0%, #a8b9cc 100%); 
                                       color: #4a5568; 
                                       border: 1px solid #cbd5e0; 
                                       padding: 8px 16px; 
                                       border-radius: 8px; 
                                       font-size: 13px; 
                                       cursor: pointer;">
                            ⚡ 優化設定重試
                        </button>
                        <button onclick="cancelCurrentRequest();" 
                                style="background: linear-gradient(135deg, #e8eaed 0%, #d5d8dc 100%); 
                                       color: #5a6270; 
                                       border: 1px solid #cbd5e0; 
                                       padding: 8px 16px; 
                                       border-radius: 8px; 
                                       font-size: 13px; 
                                       cursor: pointer;">
                            ⏸️ 取消
                        </button>
                    </div>
                </div>
            `;
            
            // 显示独立的游戏浮层
            const gameOverlay = document.getElementById('miniGameOverlay');
            if (gameOverlay) {
                gameOverlay.style.display = 'block';
            }
            
            // 初始化游戏
            setTimeout(() => {
                try {
                    gameCanvas = document.getElementById('gameCanvas');
                    if (!gameCanvas) {
                        console.error('无法找到游戏画布');
                        return;
                    }
                    
                    gameCtx = gameCanvas.getContext('2d');
                    if (!gameCtx) {
                        console.error('无法获取Canvas上下文');
                        return;
                    }
                    
                    // 添加点击和触摸事件（移动端兼容）
                    gameCanvas.addEventListener('click', catJump);
                    gameCanvas.addEventListener('touchend', handleTouch);
                    document.addEventListener('keydown', handleGameKeyPress);
                    
                    runGame();
                } catch (error) {
                    console.error('初始化游戏失败:', error);
                    gameActive = false;
                }
            }, 100);
            
            } catch (error) {
                console.error('启动游戏失败:', error);
                gameActive = false;
                // 降级显示普通加载界面
                container.innerHTML = `
                    <div class="loading" style="padding: 30px 20px;">
                        <div class="spinner"></div>
                        <div style="margin-top: 16px; text-align: center;">
                            <div style="font-size: 15px; font-weight: 500; margin-bottom: 8px;">${message}</div>
                            <div style="font-size: 13px; color: #999; margin-bottom: 16px;">已等待 ${elapsed} 秒</div>
                        </div>
                    </div>
                `;
            }
        }

        // 猫咪跳跃
        function catJump(e) {
            if (!gameActive) return;
            
            // 只在点击游戏画布时阻止默认行为
            if (e && e.target === gameCanvas && e.preventDefault) {
                e.preventDefault();
            }
            
            if (!gameStarted) {
                gameStarted = true;
            }
            
            // 只有在地面上才能跳跃（防止连续跳跃累积高度）
            if (isOnGround) {
                catVelocity = JUMP_STRENGTH;
                isOnGround = false;
            }
        }

        // 触摸控制（手机端）
        function handleTouch(e) {
            // 只在游戏激活时处理
            if (!gameActive) return;
            
            // 不阻止默认行为，允许滚动
            // 只调用跳跃
            catJump();
        }

        // 键盘控制
        function handleGameKeyPress(e) {
            if (gameActive && e.code === 'Space') {
                e.preventDefault();
                catJump(e);
            }
        }

        // 游戏主循环
        function runGame(currentTime = 0) {
            if (!gameActive || !gameCanvas || !gameCtx) return;
            
            // 帧率控制（避免过度占用资源）
            const elapsed = currentTime - lastFrameTime;
            if (elapsed < FRAME_RATE) {
                if (gameActive) {
                    requestAnimationFrame(runGame);
                }
                return;
            }
            lastFrameTime = currentTime;
            
            try {
                const canvas = gameCanvas;
                const ctx = gameCtx;
                
                // 清空画布
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制地面
            ctx.fillStyle = '#e0e0e0';
            ctx.fillRect(0, 170, canvas.width, 10);
            
            if (gameStarted) {
                // 更新猫咪位置
                catVelocity += GRAVITY;
                catY += catVelocity;
                
                // 限制猫咪不要掉出地面（调整适应新画布）
                if (catY >= GROUND_Y) {
                    catY = GROUND_Y;
                    catVelocity = 0;
                    isOnGround = true; // 着地了
                } else {
                    isOnGround = false; // 在空中
                }
                
                if (catY < 0) {
                    catY = 0;
                    catVelocity = 0;
                }
                
                // 根据分数逐渐加速（每5分加速一次，最高8倍速）
                gameSpeed = Math.min(MAX_SPEED, 3 + Math.floor(gameScore / 5) * 0.5);
                
                // 生成药丸障碍物
                if (pills.length === 0 || pills[pills.length - 1].x < canvas.width - 120) {
                    pills.push({
                        x: canvas.width,
                        y: 130,
                        passed: false
                    });
                }
                
                // 更新并绘制药丸
                pills = pills.filter(pill => {
                    pill.x -= gameSpeed; // 使用动态速度
                    
                    // 检测碰撞（更精确的碰撞检测）
                    const catLeft = 40 - CAT_SIZE/2 + 5;
                    const catRight = 40 + CAT_SIZE/2 - 5;
                    const catTop = catY + 5;
                    const catBottom = catY + CAT_SIZE - 5;
                    
                    const pillLeft = pill.x + 5;
                    const pillRight = pill.x + PILL_WIDTH - 5;
                    const pillTop = pill.y + 5;
                    const pillBottom = pill.y + PILL_HEIGHT - 5;
                    
                    if (catRight > pillLeft && catLeft < pillRight && 
                        catBottom > pillTop && catTop < pillBottom) {
                        // 碰到了！游戏结束
                        stopMiniGame(true);
                        return false;
                    }
                    
                    // 计分
                    if (!pill.passed && pill.x < 20) {
                        pill.passed = true;
                        gameScore++;
                        try {
                            const scoreEl = document.getElementById('gameScore');
                            if (scoreEl) {
                                scoreEl.textContent = gameScore;
                            }
                        } catch (e) {
                            // 元素可能已被移除，忽略错误
                        }
                    }
                    
                    // 绘制药丸 💊（使用兼容性更好的方法）
                    if (pill.x > -PILL_WIDTH) {
                        // 绘制胶囊形状
                        ctx.fillStyle = '#ff6b9d';
                        
                        const radius = PILL_WIDTH / 2;
                        const centerY = pill.y + PILL_HEIGHT / 2;
                        
                        // 上半圆
                        ctx.beginPath();
                        ctx.arc(pill.x + radius, pill.y + radius, radius - 1, 0, Math.PI, true);
                        ctx.fill();
                        
                        // 矩形主体
                        ctx.fillRect(pill.x + 1, pill.y + radius, PILL_WIDTH - 2, PILL_HEIGHT - PILL_WIDTH);
                        
                        // 下半圆
                        ctx.beginPath();
                        ctx.arc(pill.x + radius, pill.y + PILL_HEIGHT - radius, radius - 1, 0, Math.PI, false);
                        ctx.fill();
                        
                        // 药丸中间的线
                        ctx.strokeStyle = '#fff';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(pill.x + 4, centerY);
                        ctx.lineTo(pill.x + PILL_WIDTH - 4, centerY);
                        ctx.stroke();
                        
                        return true;
                    }
                    return false;
                });
            }
            
            // 绘制猫咪 🐱
            ctx.save();
            ctx.translate(40, catY + CAT_SIZE/2);
            
            // 猫咪身体
            ctx.fillStyle = '#ffa500';
            ctx.beginPath();
            ctx.ellipse(0, 0, CAT_SIZE/2, CAT_SIZE/2.5, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // 猫咪耳朵
            ctx.fillStyle = '#ffa500';
            ctx.beginPath();
            ctx.moveTo(-15, -15);
            ctx.lineTo(-10, -25);
            ctx.lineTo(-5, -15);
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(5, -15);
            ctx.lineTo(10, -25);
            ctx.lineTo(15, -15);
            ctx.fill();
            
            // 猫咪眼睛
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(-8, -3, 3, 0, Math.PI * 2);
            ctx.arc(8, -3, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // 猫咪鼻子
            ctx.fillStyle = '#ff69b4';
            ctx.beginPath();
            ctx.arc(0, 3, 2, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
            
            // 提示文字和速度显示
            if (!gameStarted) {
                ctx.fillStyle = '#999';
                ctx.font = '13px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('點擊畫面開始', canvas.width / 2, 25);
            } else {
                // 显示当前速度（右上角）
                ctx.fillStyle = '#999';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(`速度 ${gameSpeed.toFixed(1)}x`, canvas.width - 10, 20);
            }
            
            // 继续游戏循环
            if (gameActive) {
                requestAnimationFrame(runGame);
            }
            
            } catch (error) {
                console.error('游戏运行错误:', error);
                stopMiniGame(false);
            }
        }

        // 停止游戏（crashed = true 表示撞到了，false 表示正常结束）
        function stopMiniGame(crashed = false) {
            // 移除所有事件监听器
            document.removeEventListener('keydown', handleGameKeyPress);
            if (gameCanvas) {
                gameCanvas.removeEventListener('click', catJump);
                gameCanvas.removeEventListener('touchend', handleTouch);
            }
            
            // 如果是撞到了，显示重新开始选项
            if (crashed && gameCanvas && gameCtx) {
                try {
                    gameActive = false;
                    gameStarted = false;
                    
                    const ctx = gameCtx;
                    ctx.fillStyle = 'rgba(0,0,0,0.6)';
                    ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 18px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('💥 撞到了！', gameCanvas.width / 2, gameCanvas.height / 2 - 30);
                    ctx.font = '14px sans-serif';
                    ctx.fillText(`分數: ${gameScore}`, gameCanvas.width / 2, gameCanvas.height / 2 - 5);
                    ctx.font = '12px sans-serif';
                    ctx.fillStyle = '#ffa500';
                    ctx.fillText(`最高速度: ${gameSpeed.toFixed(1)}x`, gameCanvas.width / 2, gameCanvas.height / 2 + 18);
                    ctx.font = '12px sans-serif';
                    ctx.fillStyle = '#4D9980';
                    ctx.fillText('點擊重新開始', gameCanvas.width / 2, gameCanvas.height / 2 + 40);
                    
                    // 添加重新开始的点击事件
                    const restartGame = () => {
                        if (gameCanvas) {
                            gameCanvas.removeEventListener('click', restartGame);
                            gameCanvas.removeEventListener('touchend', restartGame);
                        }
                        // 重置游戏
                        restartMiniGame();
                    };
                    
                    gameCanvas.addEventListener('click', restartGame);
                    gameCanvas.addEventListener('touchend', restartGame);
                    
                } catch (error) {
                    console.error('停止游戏错误:', error);
                }
            } else {
                // 搜索完成，强制结束游戏
                gameActive = false;
                gameStarted = false;
                
                // 直接隐藏游戏浮层
                const gameOverlay = document.getElementById('miniGameOverlay');
                if (gameOverlay) {
                    gameOverlay.style.display = 'none';
                }
            }
        }

        // 重新开始游戏
        function restartMiniGame() {
            gameActive = true;
            gameStarted = false;
            gameScore = 0;
            catY = GROUND_Y;
            catVelocity = 0;
            pills = [];
            gameSpeed = 3; // 重置速度
            isOnGround = true;
            
            // 更新分数显示
            const scoreEl = document.getElementById('gameScore');
            if (scoreEl) {
                scoreEl.textContent = '0';
            }
            
            // 重新添加事件
            if (gameCanvas) {
                gameCanvas.addEventListener('click', catJump);
                gameCanvas.addEventListener('touchend', handleTouch);
                document.addEventListener('keydown', handleGameKeyPress);
            }
            
            // 重新启动游戏循环
            runGame();
        }

        // 关闭游戏浮层
        function closeGameOverlay() {
            // 停止游戏
            gameActive = false;
            gameStarted = false;
            
            // 移除事件监听器
            document.removeEventListener('keydown', handleGameKeyPress);
            if (gameCanvas) {
                gameCanvas.removeEventListener('click', catJump);
                gameCanvas.removeEventListener('touchend', handleTouch);
            }
            
            // 隐藏浮层
            const gameOverlay = document.getElementById('miniGameOverlay');
            if (gameOverlay) {
                gameOverlay.style.display = 'none';
            }
        }

        // 更新加载进度
        function updateLoadingProgress(message, progress) {
            // 更新当前状态（给定时器使用）
            currentMessage = message;
            currentProgress = progress;
            
            const list = document.getElementById('placeList');
            if (list && isRequesting) {
                showLoadingProgress(list, message, progress);
            }
        }

        function clearMapMarkers() {
            mapMarkers.forEach(m => mapInstance.removeLayer(m));
            mapMarkers = [];
        }

        function fetchPlaces(lat, lon) {
            // 如果正在请求中，先取消
            if (isRequesting) {
                cancelCurrentRequest();
            }
            
            // 生成新的请求ID
            const thisRequestId = ++requestId;
            isRequesting = true;
            
            clearMapMarkers();
            const list = document.getElementById('placeList');
            
            // 显示带进度的加载界面
            loadingStartTime = Date.now();
            currentMessage = '正在連接服務器...';
            currentProgress = 0;
            showLoadingProgress(list, currentMessage, currentProgress);
            
            // 启动定时器，每秒更新一次时间显示
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            progressInterval = setInterval(() => {
                if (isRequesting) {
                    showLoadingProgress(list, currentMessage, currentProgress);
                } else {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
            }, 1000); // 每秒更新一次

            // 若無定位，用地圖中心
            if (!lat || !lon) {
                const c = mapInstance.getCenter();
                lat = c.lat; lon = c.lng;
            }

            // 检查缓存
            const cacheKey = `${mapFilter}_${lat.toFixed(4)}_${lon.toFixed(4)}_${searchRadius}`;
            if (placesCache[cacheKey]) {
                isRequesting = false;
                
                // 记录搜索位置
                lastSearchPosition = { lat, lon };
                
                // 隐藏"搜索此区域"按钮
                hideSearchAreaButton();
                
                // 清除进度定时器
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                
                // 停止游戏（如果在玩）
                if (gameActive) {
                    stopMiniGame(false);
                }
                
                renderPlaces(placesCache[cacheKey]);
                return;
            }

            // 检查网络连接
            if (!navigator.onLine) {
                isRequesting = false;
                list.innerHTML = '<div class="empty-state"><h3>❌ 沒有網路連接</h3><p>請檢查您的網路設定</p></div>';
                return;
            }

            const filters = {
                // 简化"全部"查询，只包含主要类别
                all: 'nwr[amenity~"pharmacy|hospital|clinic|dentist"]',
                pharmacy: 'nwr[amenity=pharmacy]',
                hospital: 'nwr[amenity=hospital]',
                ent: 'nwr[healthcare:speciality=otorhinolaryngology]',
                obgyn: 'nwr[healthcare:speciality=gynaecology]',
                internal: 'nwr[healthcare:speciality=internal]',
                pediatric: 'nwr[healthcare:speciality=paediatrics]',
                dental: 'nwr[amenity=dentist]',
                eye: 'nwr[healthcare:speciality=ophthalmology]',
                ortho: 'nwr[healthcare:speciality=orthopaedics]',
                derm: 'nwr[healthcare:speciality=dermatology]',
                emergency: 'nwr[emergency=yes]'
            };

            // 带重试的获取函数
            const fetchWithRetry = async (serverIndex = 0, retryCount = 0) => {
                // 检查这个请求是否还是最新的
                if (thisRequestId !== requestId) {
                    return;
                }
                
                // 创建新的 AbortController
                currentFetchController = new AbortController();
                const signal = currentFetchController.signal;

                const maxRetries = overpassServers.length;
                if (retryCount >= maxRetries) {
                    // 检查这个请求是否还是最新的
                    if (thisRequestId !== requestId) {
                        return;
                    }
                    
                    isRequesting = false;
                    
                    // 记录搜索位置（即使失败）
                    lastSearchPosition = { lat, lon };
                    
                    // 隐藏"搜索此区域"按钮
                    hideSearchAreaButton();
                    
                    // 清除进度定时器
                    if (progressInterval) {
                        clearInterval(progressInterval);
                        progressInterval = null;
                    }
                    
                    // 停止游戏
                    if (gameActive) {
                        stopMiniGame(false);
                    }
                    
                    // 显示提示信息
                    const hintEl = document.getElementById('mapHint');
                    if (hintEl) {
                        hintEl.style.display = 'block';
                    }
                    
                    const finalScore = gameScore > 0 ? `<p style="color: #4D9980; font-size: 16px; font-weight: 500; margin: 8px 0;">🎮 遊戲分數：${gameScore}</p>` : '';
                    
                    list.innerHTML = `<div class="empty-state">
                        <h3>⏱️ 所有服務器響應超時</h3>
                        <p style="margin: 12px 0;">已嘗試 ${maxRetries} 個服務器都無法連接</p>
                        ${finalScore}
                        
                        <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin: 12px 0; text-align: left;">
                            <strong style="color: #856404;">💡 建議解決方法：</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; color: #856404;">
                                <li>選擇更小的搜尋範圍（500米或1公里）</li>
                                <li>選擇單一類別（藥局、醫院等）而非"全部"</li>
                                <li>檢查網路連接是否穩定</li>
                                <li>稍後再試（避開高峰時段）</li>
                            </ul>
                        </div>
                        
                        <button onclick="quickFix()" class="sync-btn" style="margin-top:8px; background: #ff9800;">🔧 自動優化設定</button>
                        <button onclick="fetchPlaces()" class="sync-btn" style="margin-top:8px; margin-left:8px;">🔄 重試</button>
                    </div>`;
                    return;
                }

                const overpassHost = overpassServers[serverIndex % overpassServers.length];
                
                // 动态调整查询参数：根据范围调整结果数量和超时时间
                const maxResults = searchRadius <= 2000 ? 40 : 25;
                const timeout = searchRadius <= 2000 ? 10 : 15;
                const clientTimeout = (timeout + 5) * 1000; // 比服务器超时多5秒
                
                const query = `[out:json][timeout:${timeout}];(${filters[mapFilter]}(around:${searchRadius},${lat},${lon}););out center ${maxResults};`;
                const overpass = `${overpassHost}?data=${encodeURIComponent(query)}`;

                // 更新进度：正在查询
                const serverNum = serverIndex + 1;
                const totalServers = overpassServers.length;
                updateLoadingProgress(`正在查詢服務器 ${serverNum}/${totalServers}...`, 20 + (serverIndex * 20));

                // 添加超时处理 - 动态超时时间
                const timeoutId = setTimeout(() => {
                    currentFetchController.abort();
                }, clientTimeout);

                try {
                    const response = await fetch(overpass, { signal });
                    clearTimeout(timeoutId);
                    
                    // 更新进度：正在接收数据
                    updateLoadingProgress('正在接收數據...', 60);
                    
                    // 检查这个请求是否还是最新的
                    if (thisRequestId !== requestId) {
                        return;
                    }
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    // 更新进度：正在解析数据
                    updateLoadingProgress('正在解析數據...', 80);
                    
                    const data = await response.json();
                    
                    // 再次检查（因为JSON解析需要时间）
                    if (thisRequestId !== requestId) {
                        return;
                    }
                    
                    // 更新进度：正在处理结果
                    updateLoadingProgress('正在處理結果...', 90);
                    
                    const elements = data.elements || [];
                    
                    if (elements.length === 0) {
                        isRequesting = false;
                        
                        // 记录搜索位置
                        lastSearchPosition = { lat, lon };
                        
                        // 隐藏"搜索此区域"按钮
                        hideSearchAreaButton();
                        
                        // 清除进度定时器
                        if (progressInterval) {
                            clearInterval(progressInterval);
                            progressInterval = null;
                        }
                        
                        // 停止游戏
                        if (gameActive) {
                            stopMiniGame(false);
                        }
                        
                        // 根据当前设置给出智能建议
                        const suggestions = [];
                        if (searchRadius < 2000) {
                            suggestions.push('擴大搜尋範圍到2-3公里');
                        }
                        if (mapFilter !== 'all' && mapFilter !== 'pharmacy' && mapFilter !== 'hospital') {
                            suggestions.push('試試「全部」或「藥局」類別');
                        }
                        if (searchRadius >= 2000) {
                            suggestions.push('試試其他類別或移動地圖位置');
                        }
                        
                        const suggestionHtml = suggestions.length > 0 ? 
                            `<ul style="text-align: left; margin: 12px auto; max-width: 250px; color: #666;">
                                ${suggestions.map(s => `<li style="margin: 6px 0;">• ${s}</li>`).join('')}
                            </ul>` : '';
                        
                        const categoryNames = {
                            'all': '全部類別',
                            'pharmacy': '藥局',
                            'hospital': '大醫院',
                            'internal': '內科',
                            'pediatric': '小兒科',
                            'dental': '牙科',
                            'eye': '眼科',
                            'ent': '耳鼻喉科',
                            'obgyn': '婦產科',
                            'ortho': '骨科',
                            'derm': '皮膚科',
                            'emergency': '急診'
                        };
                        const categoryName = categoryNames[mapFilter] || mapFilter;
                        const rangeText = searchRadius >= 1000 ? (searchRadius/1000) + '公里' : searchRadius + '米';
                        
                        list.innerHTML = `<div class="empty-state">
                            <h3>📍 附近沒有找到資料</h3>
                            <p style="color: #999; margin: 12px 0;">當前搜尋：${categoryName} · ${rangeText}</p>
                            ${suggestionHtml}
                            <div style="display: flex; gap: 8px; justify-content: center; margin-top: 16px;">
                                ${searchRadius < 3000 ? '<button onclick="expandSearchRadius()" class="sync-btn" style="background: #ff9800;">📏 擴大範圍</button>' : ''}
                                <button onclick="fetchPlaces()" class="sync-btn">🔄 重新搜尋</button>
                            </div>
                        </div>`;
                        return;
                    }

                    const items = elements.map(e => {
                        const p = e.tags || {};
                        const latlng = e.type === 'node' ? [e.lat, e.lon] : [e.center?.lat, e.center?.lon];
                        
                        return {
                            id: e.id,
                            name: p.name || '未命名',
                            address: p['addr:full'] || `${p['addr:city'] || ''}${p['addr:district'] || ''}${p['addr:street'] || ''}${p['addr:housenumber'] || ''}`,
                            phone: p.phone || p['contact:phone'] || '',
                            website: p.website || p['contact:website'] || '',
                            opening_hours: p.opening_hours || '',
                            lat: latlng[0],
                            lon: latlng[1],
                            type: mapFilter
                        };
                    }).filter(it => it.lat && it.lon);

                    allPlaces = items;
                    placesCache[cacheKey] = items;
                    
                    // 限制缓存大小
                    const cacheKeys = Object.keys(placesCache);
                    if (cacheKeys.length > 20) {
                        delete placesCache[cacheKeys[0]];
                    }
                    
                    // 记住成功的服务器
                    currentServerIndex = serverIndex % overpassServers.length;
                    isRequesting = false;
                    
                    // 记录搜索位置
                    lastSearchPosition = { lat, lon };
                    
                    // 隐藏"搜索此区域"按钮
                    hideSearchAreaButton();
                    
                    // 清除进度定时器
                    if (progressInterval) {
                        clearInterval(progressInterval);
                        progressInterval = null;
                    }
                    
                    // 最后进度：完成
                    updateLoadingProgress('完成！', 100);
                    
                    // 停止游戏（如果在玩）
                    if (gameActive) {
                        stopMiniGame(false);
                    }
                    
                    // 短暂延迟后显示结果（让用户看到100%）
                    setTimeout(() => {
                        renderPlaces(items);
                    }, 200);
                    
                } catch (error) {
                    clearTimeout(timeoutId);
                    
                    // 检查这个请求是否还是最新的
                    if (thisRequestId !== requestId) {
                        return;
                    }
                    
                    if (error.name === 'AbortError') {
                        return; // 被取消的请求不重试
                    }
                    
                    // 显示重试提示
                    const nextServer = (serverIndex + 1) % overpassServers.length;
                    updateLoadingProgress(`服務器 ${serverIndex + 1} 失敗，切換到服務器 ${nextServer + 1}...`, 30 + (serverIndex * 15));
                    
                    // 切换到下一个服务器重试
                    setTimeout(() => {
                        fetchWithRetry(serverIndex + 1, retryCount + 1);
                    }, 500);
                }
            };

            // 从上次成功的服务器开始尝试
            fetchWithRetry(currentServerIndex, 0);
        }

        function renderPlaces(items, resetCount = true) {
            clearMapMarkers();
            const list = document.getElementById('placeList');
            
            if (items.length === 0) {
                list.innerHTML = '<div class="empty-state"><h3>沒有找到資料</h3></div>';
                return;
            }

            // 重置显示数量
            if (resetCount) {
                displayedCount = INITIAL_DISPLAY_COUNT;
            }

            // 计算距离
            items.forEach(it => {
                if (userPosition && it.lat && it.lon) {
                    it.distance = distanceInMeters(userPosition.lat, userPosition.lon, it.lat, it.lon);
                }
            });

            // 排序
            const sortBy = document.getElementById('sortBy')?.value || 'distance';
            if (sortBy === 'distance') {
                items.sort((a, b) => (a.distance || Infinity) - (b.distance || Infinity));
            } else if (sortBy === 'name') {
                items.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));
            }

            // 只显示前displayedCount个
            const itemsToDisplay = items.slice(0, displayedCount);
            const hasMore = items.length > displayedCount;

            // 在地图上添加标记 - 只显示当前显示的项目
            requestAnimationFrame(() => {
                itemsToDisplay.forEach(it => {
                    if (it.lat && it.lon) {
                        const isFavorite = favoritePlaces.some(f => f.id === it.id);
                        const icon = L.divIcon({
                            html: `<div style="background: ${isFavorite ? '#ff4757' : '#4D9980'}; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                            iconSize: [24, 24],
                            className: ''
                        });
                        const marker = L.marker([it.lat, it.lon], { icon }).addTo(mapInstance);
                        const popupAddr = it.address || '';
                        marker.bindPopup(`<b>${escapeHtml(it.name)}</b><br>${escapeHtml(popupAddr)}`);
                        mapMarkers.push(marker);
                    }
                });
            });

            // 显示结果统计
            const statsHtml = `<div style="padding: 8px 20px; background: #f8f9fa; font-size: 13px; color: #666;">
                找到 ${items.length} 個醫療機構（顯示前 ${itemsToDisplay.length} 個）
            </div>`;

            // 渲染列表项
            const itemsHtml = itemsToDisplay.map(it => {
                const isFavorite = favoritePlaces.some(f => f.id === it.id);
                const dist = it.distance ? ` · ${formatDistance(it.distance)}` : '';
                const navUrl = it.lat && it.lon ? `https://www.google.com/maps/search/?api=1&query=${it.lat},${it.lon}` : '#';
                const tel = it.phone ? `tel:${it.phone.replace(/\s|-/g,'')}` : '';
                const openStatus = getOpenStatus(it.opening_hours);
                
                return `
                <div class="history-item" style="position: relative;">
                    <button onclick="toggleFavorite('${it.id}', event)" style="position: absolute; top: 12px; right: 12px; background: none; border: none; cursor: pointer; padding: 4px;">
                        <svg style="width: 20px; height: 20px; color: ${isFavorite ? '#ff4757' : '#ccc'};" fill="${isFavorite ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                    </button>
                    <div class="history-medicine">${escapeHtml(it.name)}${dist}</div>
                    ${openStatus ? `<div style="display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-bottom: 4px; ${openStatus.isOpen ? 'background: #d4edda; color: #155724;' : 'background: #f8d7da; color: #721c24;'}">${openStatus.text}</div>` : ''}
                    <div class="history-time" style="color:#333;">${escapeHtml(it.address || '地址未提供')}</div>
                    ${it.opening_hours ? `<div class="history-time">營業時間：${escapeHtml(it.opening_hours)}</div>` : ''}
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <a href="${navUrl}" target="_blank" class="sync-btn" style="padding:8px 12px; width:auto;">導航</a>
                        ${it.phone ? `<a href="${tel}" class="sync-btn" style="background:#6c757d; padding:8px 12px; width:auto;">打電話</a>` : ''}
                        ${it.website ? `<a href="${it.website}" target="_blank" class="sync-btn" style="background:#17a2b8; padding:8px 12px; width:auto;">官網</a>` : ''}
                    </div>
                </div>`;
            }).join('');

            // 显示更多按钮
            const loadMoreBtn = hasMore ? `
                <div style="padding: 20px; text-align: center;">
                    <button onclick="loadMorePlaces()" class="sync-btn" style="width: auto; padding: 12px 24px; font-size: 15px;">
                        📋 顯示更多 (還有 ${items.length - displayedCount} 個)
                    </button>
                </div>
            ` : '';
            
            list.innerHTML = statsHtml + itemsHtml + loadMoreBtn;
        }

        // 加载更多
        function loadMorePlaces() {
            displayedCount += LOAD_MORE_COUNT;
            renderPlaces(allPlaces, false); // false表示不重置计数
        }

        function distanceInMeters(lat1, lon1, lat2, lon2) {
            const R = 6371000; // m
            const toRad = (d) => d * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function formatDistance(m) {
            if (m < 1000) return `${Math.round(m)}m`;
            return `${(m/1000).toFixed(1)}km`;
        }

        // 搜索功能
        function searchPlaces() {
            const searchTerm = document.getElementById('mapSearchInput').value.trim().toLowerCase();
            if (!searchTerm) {
                renderPlaces(allPlaces);
                return;
            }
            const filtered = allPlaces.filter(p => 
                p.name.toLowerCase().includes(searchTerm) || 
                p.address.toLowerCase().includes(searchTerm)
            );
            renderPlaces(filtered);
        }

        // 按Enter键搜索
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('mapSearchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') searchPlaces();
                });
            }

            // 监听网络状态变化
            const networkStatus = document.getElementById('networkStatus');
            
            window.addEventListener('online', () => {
                if (networkStatus) {
                    networkStatus.style.display = 'none';
                }
            });
            
            window.addEventListener('offline', () => {
                if (networkStatus) {
                    networkStatus.innerHTML = '❌ 網路已斷開，請檢查網路連接';
                    networkStatus.style.background = '#f8d7da';
                    networkStatus.style.color = '#721c24';
                    networkStatus.style.display = 'block';
                }
            });

            // 检测网络速度（简单版本）
            if (navigator.connection) {
                const updateNetworkStatus = () => {
                    const connection = navigator.connection;
                    const effectiveType = connection.effectiveType;
                    
                    if (networkStatus && (effectiveType === 'slow-2g' || effectiveType === '2g')) {
                        networkStatus.innerHTML = '📶 網路連接較慢，可能需要更長時間';
                        networkStatus.style.background = '#fff3cd';
                        networkStatus.style.color = '#856404';
                        networkStatus.style.display = 'block';
                    } else if (networkStatus) {
                        networkStatus.style.display = 'none';
                    }
                };
                
                navigator.connection.addEventListener('change', updateNetworkStatus);
                updateNetworkStatus();
            }
        });

        // 收藏功能
        function toggleFavorite(placeId, event) {
            event.preventDefault();
            event.stopPropagation();
            
            const place = allPlaces.find(p => p.id == placeId);
            if (!place) return;

            const index = favoritePlaces.findIndex(f => f.id == placeId);
            if (index > -1) {
                favoritePlaces.splice(index, 1);
            } else {
                favoritePlaces.push(place);
            }
            
            localStorage.setItem('favoritePlaces', JSON.stringify(favoritePlaces));
            renderPlaces(showingFavorites ? favoritePlaces : allPlaces);
        }

        // 显示/隐藏收藏
        function toggleFavorites() {
            showingFavorites = !showingFavorites;
            const icon = document.getElementById('favIcon');
            
            if (showingFavorites) {
                icon.setAttribute('fill', 'currentColor');
                icon.style.color = '#ff4757';
                renderPlaces(favoritePlaces);
            } else {
                icon.setAttribute('fill', 'none');
                icon.style.color = '#666';
                renderPlaces(allPlaces);
            }
        }

        // 更新搜索范围
        function updateSearchRadius() {
            searchRadius = parseInt(document.getElementById('searchRadius').value);
            
            // 立即取消当前请求
            cancelCurrentRequest();
            
            const center = mapInstance.getCenter();
            
            // 隐藏提示
            const hintEl = document.getElementById('mapHint');
            if (hintEl && searchRadius <= 1000) {
                hintEl.style.display = 'none';
            }
            
            // 用户主动操作，立即执行
            fetchPlaces(center.lat, center.lng);
        }

        // 扩大搜索范围（智能建议）
        function expandSearchRadius() {
            const radiusSelect = document.getElementById('searchRadius');
            
            // 根据当前范围智能扩大
            if (searchRadius < 1000) {
                searchRadius = 1000;
                radiusSelect.value = '1000';
            } else if (searchRadius < 2000) {
                searchRadius = 2000;
                radiusSelect.value = '2000';
            } else {
                searchRadius = 3000;
                radiusSelect.value = '3000';
            }
            
            // 立即搜索
            cancelCurrentRequest();
            const center = mapInstance.getCenter();
            fetchPlaces(center.lat, center.lng);
        }

        // 快速修复：自动优化设定
        function quickFix() {
            // 立即取消当前请求
            cancelCurrentRequest();
            
            // 设置为最快的配置
            searchRadius = 500;
            document.getElementById('searchRadius').value = '500';
            
            // 如果是"全部"，切换到"藥局"（最快）
            if (mapFilter === 'all') {
                mapFilter = 'pharmacy';
                document.querySelectorAll('#mapView .type-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.filter === 'pharmacy');
                });
            }
            
            // 隐藏提示
            const hintEl = document.getElementById('mapHint');
            if (hintEl) {
                hintEl.style.display = 'none';
            }
            
            // 重新搜索
            const center = mapInstance.getCenter();
            fetchPlaces(center.lat, center.lng);
            
            // 显示成功提示
            const list = document.getElementById('placeList');
            list.innerHTML = '<div class="loading"><div class="spinner"></div><span>✨ 已優化設定，重新搜尋中...</span></div>';
        }

        // 排序
        function sortPlaces() {
            renderPlaces(showingFavorites ? favoritePlaces : allPlaces);
        }

        // 判断营业状态
        function getOpenStatus(opening_hours) {
            if (!opening_hours) return null;
            
            try {
                const now = new Date();
                const day = now.getDay(); // 0=Sunday, 1=Monday, etc.
                const time = now.getHours() * 100 + now.getMinutes();
                
                // 简单解析 opening_hours (如 "Mo-Fr 08:00-18:00")
                // 这是一个简化版本，实际的 opening_hours 格式可能很复杂
                
                // 24/7 全天候营业
                if (opening_hours.includes('24/7')) {
                    return { isOpen: true, text: '營業中' };
                }
                
                // 尝试匹配常见格式
                const patterns = [
                    /(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/g,  // 08:00-18:00
                ];
                
                let hasMatch = false;
                for (const pattern of patterns) {
                    const matches = [...opening_hours.matchAll(pattern)];
                    if (matches.length > 0) {
                        hasMatch = true;
                        for (const match of matches) {
                            const openTime = parseInt(match[1]) * 100 + parseInt(match[2]);
                            const closeTime = parseInt(match[3]) * 100 + parseInt(match[4]);
                            
                            if (time >= openTime && time <= closeTime) {
                                return { isOpen: true, text: '營業中' };
                            }
                        }
                    }
                }
                
                if (hasMatch) {
                    return { isOpen: false, text: '已關閉' };
                }
                
                return null;
            } catch (e) {
                return null;
            }
        }

        function escapeHtml(str) {
            return String(str || '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
        }

        // 初始化應用
        init();
    </script>
</body>
</html>
